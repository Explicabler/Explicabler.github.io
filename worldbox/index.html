<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>World Sandbox III</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.2/pixi.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --gold:#c8a84b;--gold-light:#e8c870;--dark:#0d0f0a;
  --panel:rgba(10,14,8,0.96);--border:#2a3820;
  --text:#c8d4b0;--text-dim:#6a7a58;
  --danger:#c04030;--safe:#4a9030;
}
body{background:#0d0f0a;color:var(--text);overflow:hidden;font-family:'Crimson Pro',Georgia,serif;}
#ui{display:flex;flex-direction:column;height:100vh;}
#canvasWrap{flex:1;position:relative;overflow:hidden;min-height:0;}
#gc{display:block;position:absolute;inset:0;pointer-events:none;z-index:2;opacity:0;}
#pixiCanvas{display:block;position:absolute;inset:0;z-index:2;}

/* ‚ïê‚ïê‚ïê DRAGGABLE PANEL BASE ‚ïê‚ïê‚ïê */
.dpanel{
  position:absolute;z-index:15;
  background:var(--panel);
  border:1px solid var(--border);border-radius:8px;
  box-shadow:0 8px 32px rgba(0,0,0,0.8),0 0 0 1px rgba(255,255,255,0.03);
  overflow:hidden;min-width:180px;
}
.dpanel-title{
  display:flex;align-items:center;justify-content:space-between;
  padding:6px 10px 5px;
  background:linear-gradient(to right,rgba(42,56,28,0.95),rgba(18,26,12,0.95));
  border-bottom:1px solid var(--border);
  cursor:grab;user-select:none;
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;
  color:var(--gold);text-transform:uppercase;
}
.dpanel-title:active{cursor:grabbing;}
.dpanel-title .dtitle-icon{font-size:12px;margin-right:5px;}
.dpanel-close{
  width:14px;height:14px;border-radius:50%;
  background:rgba(180,60,40,0.7);border:1px solid rgba(200,80,60,0.5);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:8px;color:rgba(255,200,180,0.8);transition:all .1s;flex-shrink:0;
}
.dpanel-close:hover{background:rgba(220,80,60,0.9);color:#fff;}
.dpanel-body{padding:8px 10px 10px;overflow-y:auto;max-height:400px;}
.dpanel-body::-webkit-scrollbar{width:3px;}
.dpanel-body::-webkit-scrollbar-thumb{background:#2a3820;border-radius:2px;}

/* ‚ïê‚ïê‚ïê STATS PANEL ‚ïê‚ïê‚ïê */
#statsPanel{width:210px;}
.sr{display:flex;justify-content:space-between;align-items:center;margin:2.5px 0;}
.sl{color:var(--text-dim);font-size:10px;display:flex;align-items:center;gap:4px;}
.sv{color:var(--text);font-size:11px;min-width:40px;text-align:right;}
.sbar{height:2px;background:#141c10;border-radius:1px;margin:1px 0 3px;overflow:hidden;}
.sbar-f{height:100%;border-radius:1px;transition:width .5s;}
.sdiv{height:1px;background:var(--border);margin:5px 0;}

/* ‚ïê‚ïê‚ïê CHRONICLE PANEL ‚ïê‚ïê‚ïê */
#chroniclePanel{width:240px;}
#eventLogBody{font-size:10px;line-height:1.6;color:var(--text-dim);}
#eventLogBody div{border-bottom:1px solid rgba(42,56,32,0.4);padding:2px 0;}

/* ‚ïê‚ïê‚ïê MINIMAP PANEL ‚ïê‚ïê‚ïê */
#minimapPanel{width:176px;}
#minimapPanel .dpanel-body{padding:6px;}
#minimap{display:block;border-radius:4px;image-rendering:pixelated;cursor:pointer;width:160px;height:160px;}

/* ‚ïê‚ïê‚ïê MORALE PANEL ‚Äî now merged into statsPanel, hidden ‚ïê‚ïê‚ïê */
#moralePanel{width:180px;}
#moralePanel .dpanel-body{padding:6px 10px 8px;}
#moraleTrack{width:100%;height:5px;background:#141c10;border-radius:3px;overflow:hidden;margin-top:4px;}
#moraleFill{height:100%;border-radius:3px;transition:width .6s,background .6s;}
.morale-label{font-size:9px;color:var(--text-dim);font-family:'Cinzel',serif;letter-spacing:0.5px;text-transform:uppercase;}
.morale-val{font-size:11px;color:var(--text);float:right;}

/* ‚ïê‚ïê‚ïê CHARACTER CARD ‚ïê‚ïê‚ïê */
#charCard{width:260px;display:none;}
#charCard .dpanel-body{padding:10px 12px 14px;}
.cc-header{display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;}
.cc-avatar{
  width:48px;height:48px;border-radius:6px;flex-shrink:0;
  border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
  font-size:26px;background:rgba(20,28,14,0.9);
}
.cc-name{font-family:'Cinzel',serif;font-size:13px;color:var(--gold-light);margin-bottom:2px;}
.cc-role{font-size:10px;color:var(--text-dim);display:flex;align-items:center;gap:4px;}
.cc-role-badge{
  display:inline-block;padding:1px 6px;border-radius:3px;
  font-size:9px;font-family:'Cinzel',serif;letter-spacing:0.5px;
  border:1px solid;margin-bottom:4px;
}
.cc-stat-row{display:flex;justify-content:space-between;align-items:center;margin:3px 0;}
.cc-stat-label{font-size:10px;color:var(--text-dim);}
.cc-stat-val{font-size:10px;color:var(--text);}
.cc-bar-wrap{flex:1;margin:0 8px;height:4px;background:#141c10;border-radius:2px;overflow:hidden;}
.cc-bar-fill{height:100%;border-radius:2px;transition:width .4s;}
.cc-divider{height:1px;background:var(--border);margin:8px 0;}
.cc-section-title{font-family:'Cinzel',serif;font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
.cc-trait{display:inline-block;background:rgba(42,56,28,0.7);border:1px solid var(--border);border-radius:3px;padding:1px 6px;font-size:9px;color:var(--text);margin:2px 2px 0 0;}
.cc-actions{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
.cc-btn{
  flex:1;min-width:60px;padding:4px 6px;font-size:9px;font-family:'Cinzel',serif;
  letter-spacing:0.4px;cursor:pointer;border-radius:4px;text-align:center;
  background:rgba(42,56,28,0.8);border:1px solid var(--border);color:var(--text);
  transition:all .12s;user-select:none;
}
.cc-btn:hover{background:rgba(60,80,36,0.9);border-color:#4a5830;color:var(--gold-light);}
.cc-btn.active-role{background:rgba(80,110,40,0.9);border-color:var(--gold);color:var(--gold-light);}
.cc-history{font-size:9px;color:var(--text-dim);line-height:1.6;max-height:70px;overflow-y:auto;}
.cc-history::-webkit-scrollbar{width:2px;}
.cc-history::-webkit-scrollbar-thumb{background:#2a3820;}
.cc-life-event{padding:1px 0;border-bottom:1px solid rgba(42,56,32,0.3);}
.cc-infected{color:#c060c0;font-size:9px;margin-top:4px;font-style:italic;}

/* ‚ïê‚ïê‚ïê SEASON BADGE ‚ïê‚ïê‚ïê */
#seasonBadge{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  background:rgba(10,14,8,0.88);border:1px solid var(--border);
  border-radius:20px;padding:4px 16px;
  font-family:'Cinzel',serif;font-size:10px;color:var(--gold);
  letter-spacing:1px;z-index:10;pointer-events:none;
  display:flex;gap:10px;align-items:center;white-space:nowrap;
}
#seasonBadge .sep{color:var(--border);}

/* ‚ïê‚ïê‚ïê NOTIF FEED ‚ïê‚ïê‚ïê */
#notifFeed{
  position:absolute;top:50px;right:14px;
  display:flex;flex-direction:column;gap:5px;
  z-index:20;pointer-events:none;max-width:260px;
}
.notif{
  background:rgba(12,18,8,0.93);border:1px solid var(--border);
  border-left:3px solid var(--gold);border-radius:4px;
  padding:5px 10px;font-size:10px;color:var(--text);
  animation:slideIn .25s ease,fadeOut .4s ease 3.5s forwards;
}
.notif.danger{border-left-color:var(--danger);}
.notif.good{border-left-color:var(--safe);}
@keyframes slideIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
@keyframes fadeOut{to{opacity:0;}}

/* ‚ïê‚ïê‚ïê NIGHT OVERLAY ‚ïê‚ïê‚ïê */
#nightOverlay{position:absolute;inset:0;pointer-events:none;z-index:2;transition:background 4s ease;}

/* ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê */
#hud{
  background:linear-gradient(to bottom,#181e12,#0f1309);
  border-top:1px solid #2a3820;
  display:flex;align-items:center;
  padding:5px 10px;gap:6px;
  flex-shrink:0;z-index:10;height:74px;
  box-shadow:0 -4px 24px rgba(0,0,0,0.8);
}
#speedCtrl{display:flex;gap:2px;align-items:center;}
.sp{
  width:36px;height:36px;
  background:linear-gradient(to bottom,#252e18,#181f10);
  border:1px solid #2a3820;border-radius:5px;
  color:#8a9878;cursor:pointer;font-size:12px;
  display:flex;align-items:center;justify-content:center;
  transition:all .12s;flex-shrink:0;user-select:none;
}
.sp:hover{background:linear-gradient(to bottom,#303c20,#222e16);border-color:#4a5830;color:var(--text);}
.sp.active{background:linear-gradient(to bottom,#5a7828,#3a5018);border-color:var(--gold);color:var(--gold-light);}
.hud-sep{width:1px;height:50px;background:#2a3820;flex-shrink:0;margin:0 2px;}
#toolGroups{display:flex;gap:3px;flex:1;overflow-x:auto;align-items:center;}
#toolGroups::-webkit-scrollbar{height:3px;}
#toolGroups::-webkit-scrollbar-thumb{background:#2a3820;}
.tool-group{display:flex;gap:2px;align-items:center;}
.tg-label{font-size:7px;color:var(--text-dim);text-transform:uppercase;writing-mode:vertical-rl;transform:rotate(180deg);letter-spacing:1.5px;flex-shrink:0;padding:0 2px;font-family:'Cinzel',serif;}
.tool-btn{
  width:52px;height:62px;
  background:linear-gradient(to bottom,#1e2818,#141c10);
  border:1px solid #2a3820;border-radius:6px;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  font-size:20px;color:var(--text);
  transition:all .12s;flex-shrink:0;user-select:none;
}
.tool-btn .lbl{font-size:7px;color:var(--text-dim);margin-top:3px;text-transform:uppercase;letter-spacing:0.5px;font-family:'Cinzel',serif;}
.tool-btn:hover{background:linear-gradient(to bottom,#283520,#1a2416);border-color:#4a5830;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.tool-btn.active{background:linear-gradient(to bottom,#3a5020,#283818);border-color:var(--gold);color:var(--gold-light);box-shadow:0 0 12px rgba(180,160,60,0.3);}
.tool-btn.active .lbl{color:var(--gold);}
.tool-btn.danger{border-color:#3a1a18;}
.tool-btn.danger:hover{border-color:#8a3028;}
.tool-btn.danger.active{background:linear-gradient(to bottom,#7a2820,#501814);border-color:#cc4030;box-shadow:0 0 12px rgba(180,60,40,0.4);}
.tool-btn.magic{border-color:#2a1a3a;}
.tool-btn.magic:hover{border-color:#6a2a9a;}
.tool-btn.magic.active{background:linear-gradient(to bottom,#4a2070,#301050);border-color:#9060d0;box-shadow:0 0 12px rgba(120,60,200,0.4);}
#newWorldBtn{
  width:58px;height:62px;
  background:linear-gradient(to bottom,#2a3818,#1a2410);
  border:1px solid #3a5020;border-radius:6px;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  font-size:22px;color:var(--text);flex-shrink:0;user-select:none;transition:all .12s;
}
#newWorldBtn .lbl{font-size:7px;color:#6a9048;margin-top:3px;text-transform:uppercase;font-family:'Cinzel',serif;}
#newWorldBtn:hover{background:linear-gradient(to bottom,#384820,#263014);transform:translateY(-2px);}
#hint{position:absolute;bottom:82px;right:14px;font-size:9px;color:var(--text-dim);background:rgba(8,12,6,0.7);padding:3px 8px;border-radius:4px;pointer-events:none;font-family:'Cinzel',serif;letter-spacing:0.3px;}
/* ‚ïê‚ïê‚ïê MAIN MENU ‚ïê‚ïê‚ïê */
#mainMenu{
  position:fixed;inset:0;z-index:9000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 50% 60%, #172310 0%, #080d05 80%);
  font-family:'Cinzel',serif;
}
#mainMenu.hidden{display:none;}
.mm-stars{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.mm-title{
  font-size:clamp(26px,4.5vw,50px);color:var(--gold-light);letter-spacing:8px;
  text-transform:uppercase;text-align:center;margin-bottom:4px;position:relative;
  text-shadow:0 0 60px rgba(200,160,60,0.5),0 2px 6px rgba(0,0,0,0.9);
}
.mm-sub{font-size:10px;color:var(--text-dim);letter-spacing:4px;text-transform:uppercase;margin-bottom:36px;}
.mm-card{
  background:rgba(8,12,6,0.95);border:1px solid #2a3820;border-radius:10px;
  padding:26px 28px;width:min(460px,92vw);
  box-shadow:0 20px 60px rgba(0,0,0,0.85),0 0 0 1px rgba(255,255,255,0.02);
}
.mm-tabs{display:flex;border-bottom:1px solid #2a3820;margin-bottom:20px;}
.mm-tab{
  flex:1;padding:8px 4px;font-family:'Cinzel',serif;font-size:9.5px;letter-spacing:1px;
  color:var(--text-dim);cursor:pointer;text-align:center;text-transform:uppercase;
  border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;
}
.mm-tab.on{color:var(--gold);border-bottom-color:var(--gold);}
.mm-pane{display:none;}
.mm-pane.on{display:block;}
.mm-field{margin-bottom:13px;}
.mm-lbl{display:block;font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
.mm-inp{
  width:100%;background:rgba(6,10,4,0.9);border:1px solid #2a3820;border-radius:5px;
  padding:8px 10px;font-family:'Crimson Pro',serif;font-size:13px;color:var(--text);
  outline:none;transition:border .15s;
}
.mm-inp:focus{border-color:var(--gold);}
.mm-row{display:flex;gap:10px;}
.mm-row .mm-field{flex:1;}
.mm-btn{
  width:100%;padding:11px;background:linear-gradient(to bottom,#3a5020,#263418);
  border:1px solid #4a6028;border-radius:6px;font-family:'Cinzel',serif;font-size:10.5px;
  letter-spacing:2px;color:var(--gold-light);cursor:pointer;text-transform:uppercase;
  transition:all .15s;margin-top:6px;
}
.mm-btn:hover{background:linear-gradient(to bottom,#4a6828,#324020);border-color:var(--gold);
  box-shadow:0 0 20px rgba(180,160,60,0.2);}
.mm-saves{display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto;margin-bottom:10px;}
.mm-saves::-webkit-scrollbar{width:3px;}
.mm-saves::-webkit-scrollbar-thumb{background:#2a3820;}
.sv-slot{
  display:flex;align-items:center;gap:10px;padding:9px 11px;
  background:rgba(14,20,10,0.9);border:1px solid #252f18;border-radius:6px;
  cursor:pointer;transition:all .12s;
}
.sv-slot:hover:not(.empty){border-color:#3a4e24;background:rgba(22,32,14,0.9);}
.sv-slot.empty{opacity:0.45;cursor:default;}
.sv-icon{font-size:20px;flex-shrink:0;}
.sv-info{flex:1;min-width:0;}
.sv-name{font-size:11px;color:var(--gold-light);font-family:'Cinzel',serif;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sv-meta{font-size:9px;color:var(--text-dim);margin-top:2px;}
.sv-del{font-size:10px;padding:3px 7px;background:rgba(70,15,15,0.7);border:1px solid #5a2020;
  border-radius:3px;color:#c06060;cursor:pointer;flex-shrink:0;transition:all .1s;}
.sv-del:hover{background:rgba(110,25,25,0.9);}
.mm-hr{height:1px;background:#1e2a14;margin:14px 0;}
.mm-ver{position:absolute;bottom:16px;font-size:9px;color:#3a4a2a;letter-spacing:1px;}

/* ‚ïê‚ïê‚ïê MOBILE CONTROLS ‚ïê‚ïê‚ïê */
#mobileControls{display:none;position:absolute;z-index:25;inset:0;pointer-events:none;}

/* Joystick */
#joystickWrap{
  position:absolute;bottom:16px;left:16px;pointer-events:all;
  width:96px;height:96px;
}
#joystickBase{
  width:96px;height:96px;border-radius:50%;
  background:rgba(10,18,6,0.65);border:2px solid rgba(80,110,40,0.7);
  display:flex;align-items:center;justify-content:center;
}
#joystickKnob{
  width:38px;height:38px;border-radius:50%;
  background:radial-gradient(circle at 35% 35%,#6a9040,#2a4010);
  border:2px solid rgba(140,180,60,0.8);
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  transition:transform .05s;
  pointer-events:none;
}

/* Zoom buttons */
#zoomBtns{
  position:absolute;bottom:16px;right:16px;pointer-events:all;
  display:flex;flex-direction:column;gap:6px;
}
.zoom-btn{
  width:44px;height:44px;border-radius:10px;
  background:rgba(10,18,6,0.75);border:2px solid rgba(80,110,40,0.7);
  color:var(--gold-light);font-size:22px;font-weight:bold;
  display:flex;align-items:center;justify-content:center;
  user-select:none;-webkit-user-select:none;cursor:pointer;
}
.zoom-btn:active{background:rgba(40,60,20,0.9);}

/* Tool drawer toggle button */
#toolDrawerBtn{
  position:absolute;bottom:16px;left:50%;transform:translateX(-50%);
  pointer-events:all;
  background:rgba(10,18,6,0.85);border:2px solid var(--border);
  border-radius:24px;padding:6px 20px;
  font-family:'Cinzel',serif;font-size:11px;color:var(--gold);
  letter-spacing:1px;display:flex;align-items:center;gap:6px;
}
#toolDrawerBtn:active{background:rgba(30,44,18,0.95);}

/* Speed shortcut row */
#mobileSpeedRow{
  position:absolute;top:12px;right:14px;pointer-events:all;
  display:flex;gap:5px;
}
.mob-sp{
  width:38px;height:38px;border-radius:8px;
  background:rgba(10,18,6,0.75);border:1.5px solid rgba(60,85,30,0.8);
  color:#8a9878;font-size:12px;
  display:flex;align-items:center;justify-content:center;
  user-select:none;
}
.mob-sp.active{background:rgba(50,80,20,0.9);border-color:var(--gold);color:var(--gold-light);}

/* Tool drawer */
#toolDrawer{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:rgba(8,12,6,0.97);
  border-top:2px solid var(--border);border-radius:16px 16px 0 0;
  padding:12px 10px 28px;
  transform:translateY(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);
  pointer-events:all;
}
#toolDrawer.open{transform:translateY(0);}
#toolDrawerHandle{
  width:40px;height:4px;background:#3a4e28;border-radius:2px;
  margin:0 auto 12px;
}
#toolDrawerGrid{
  display:grid;grid-template-columns:repeat(6,1fr);gap:6px;
  max-height:55vh;overflow-y:auto;
}
.td-group-label{
  grid-column:1/-1;font-family:'Cinzel',serif;font-size:8px;
  color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;
  padding:4px 0 2px;border-bottom:1px solid var(--border);margin-top:4px;
}
.td-btn{
  aspect-ratio:1;border-radius:8px;
  background:rgba(20,28,14,0.9);border:1.5px solid var(--border);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer;user-select:none;gap:2px;
}
.td-btn .lbl{font-size:7px;color:var(--text-dim);font-family:'Cinzel',serif;
  letter-spacing:0.4px;text-transform:uppercase;}
.td-btn.active{background:rgba(50,80,24,0.9);border-color:var(--gold);color:var(--gold-light);}
.td-btn.active .lbl{color:var(--gold);}
.td-btn.danger{border-color:#3a1a18;}
.td-btn.danger.active{background:rgba(80,24,18,0.9);border-color:#cc4030;}
.td-btn.magic{border-color:#2a1a3a;}
.td-btn.magic.active{background:rgba(50,20,80,0.9);border-color:#9060d0;}
#toolDrawerOverlay{
  display:none;position:fixed;inset:0;z-index:190;background:rgba(0,0,0,0.45);
}
#toolDrawerOverlay.open{display:block;}

/* Mobile mode applied via JS ‚Äî body.mobile class */
body.mobile #mobileControls{display:block;}
body.mobile #hint{display:none;}
body.mobile #hud{height:58px;padding:4px 6px;gap:4px;}
body.mobile .sp{width:30px;height:30px;font-size:10px;}
body.mobile .tool-btn{width:40px;height:48px;font-size:16px;}
body.mobile .tool-btn .lbl{font-size:6px;}
body.mobile #newWorldBtn{width:44px;height:48px;font-size:17px;}

/* ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê */
#settingsOverlay{
  display:none;position:fixed;inset:0;z-index:9999;
  background:rgba(0,0,0,0.7);align-items:center;justify-content:center;
}
#settingsOverlay.open{display:flex;}
#settingsModal{
  background:rgba(8,12,6,0.98);border:1px solid var(--border);
  border-radius:12px;padding:0;width:min(480px,94vw);
  max-height:90vh;overflow:hidden;display:flex;flex-direction:column;
  box-shadow:0 24px 64px rgba(0,0,0,0.9);
}
#settingsModal .sm-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px 13px;
  background:linear-gradient(to right,rgba(42,56,28,0.95),rgba(18,26,12,0.95));
  border-bottom:1px solid var(--border);flex-shrink:0;
}
#settingsModal .sm-title{
  font-family:'Cinzel',serif;font-size:12px;letter-spacing:2px;
  color:var(--gold);text-transform:uppercase;
}
#settingsModal .sm-close{
  width:22px;height:22px;border-radius:50%;
  background:rgba(180,60,40,0.7);border:1px solid rgba(200,80,60,0.5);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:11px;color:rgba(255,200,180,0.9);transition:all .1s;
}
#settingsModal .sm-close:hover{background:rgba(220,80,60,0.9);color:#fff;}
#settingsModal .sm-body{overflow-y:auto;padding:16px 18px 20px;flex:1;}
#settingsModal .sm-body::-webkit-scrollbar{width:4px;}
#settingsModal .sm-body::-webkit-scrollbar-thumb{background:#2a3820;border-radius:2px;}
.sm-section{margin-bottom:18px;}
.sm-section-title{
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;
  color:var(--text-dim);text-transform:uppercase;
  border-bottom:1px solid var(--border);padding-bottom:5px;margin-bottom:10px;
}
.sm-row{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;gap:12px;
}
.sm-label{font-size:11px;color:var(--text);flex-shrink:0;min-width:130px;}
.sm-desc{font-size:9px;color:var(--text-dim);margin-top:1px;}
.sm-label-wrap{flex:1;}
.sm-control{flex-shrink:0;display:flex;align-items:center;gap:8px;}
/* Slider */
.sm-slider{
  -webkit-appearance:none;appearance:none;
  width:120px;height:4px;border-radius:2px;
  background:linear-gradient(to right,var(--gold) 0%,var(--gold) var(--pct,50%),#1e2a14 var(--pct,50%));
  outline:none;cursor:pointer;
}
.sm-slider::-webkit-slider-thumb{
  -webkit-appearance:none;appearance:none;
  width:14px;height:14px;border-radius:50%;
  background:var(--gold-light);border:2px solid var(--gold);cursor:pointer;
}
.sm-slider::-moz-range-thumb{
  width:14px;height:14px;border-radius:50%;
  background:var(--gold-light);border:2px solid var(--gold);cursor:pointer;
}
.sm-val{
  font-size:10px;color:var(--gold);font-family:'Cinzel',serif;
  min-width:28px;text-align:right;
}
/* Toggle */
.sm-toggle{
  position:relative;width:42px;height:22px;cursor:pointer;flex-shrink:0;
}
.sm-toggle input{opacity:0;width:0;height:0;position:absolute;}
.sm-toggle-track{
  position:absolute;inset:0;border-radius:11px;
  background:#1e2a14;border:1px solid var(--border);transition:background .2s;
}
.sm-toggle input:checked~.sm-toggle-track{background:rgba(60,100,20,0.8);border-color:var(--gold);}
.sm-toggle-thumb{
  position:absolute;top:3px;left:3px;width:14px;height:14px;
  border-radius:50%;background:#4a5830;transition:transform .2s,background .2s;
}
.sm-toggle input:checked~.sm-toggle-thumb{transform:translateX(20px);background:var(--gold-light);}
/* Reset button */
.sm-reset{
  width:100%;padding:9px;margin-top:6px;
  background:rgba(20,28,14,0.8);border:1px solid var(--border);
  border-radius:6px;font-family:'Cinzel',serif;font-size:9px;
  letter-spacing:1px;color:var(--text-dim);cursor:pointer;
  text-transform:uppercase;transition:all .15s;
}
.sm-reset:hover{border-color:#4a5830;color:var(--text);}
/* Settings HUD button */
#settingsBtn{
  width:36px;height:36px;
  background:linear-gradient(to bottom,#252e18,#181f10);
  border:1px solid #2a3820;border-radius:5px;
  color:#8a9878;cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;
  transition:all .12s;flex-shrink:0;user-select:none;
}
#settingsBtn:hover{background:linear-gradient(to bottom,#303c20,#222e16);border-color:#4a5830;color:var(--text);}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê MAIN MENU ‚ïê‚ïê‚ïê -->
<div id="mainMenu">
  <div class="mm-stars" id="mmStars"></div>
  <div class="mm-title">World Sandbox</div>
  <div class="mm-sub">A living world simulation</div>
  <div class="mm-card">
    <div class="mm-tabs">
      <div class="mm-tab on" data-tab="new">‚ú¶ New World</div>
      <div class="mm-tab" data-tab="load">üìú Load Save</div>
    </div>
    <!-- NEW WORLD -->
    <div class="mm-pane on" id="pane-new">
      <div class="mm-field">
        <label class="mm-lbl">World Name</label>
        <input class="mm-inp" id="mm-wname" placeholder="e.g. Aethermoor, The Verdant Isle‚Ä¶" maxlength="32">
      </div>
      <div class="mm-row">
        <div class="mm-field">
          <label class="mm-lbl">Seed (optional)</label>
          <input class="mm-inp" id="mm-seed" placeholder="Random" maxlength="20">
        </div>
        <div class="mm-field">
          <label class="mm-lbl">Island Size</label>
          <select class="mm-inp" id="mm-size">
            <option value="small">Small</option>
            <option value="medium" selected>Medium</option>
            <option value="large">Large</option>
          </select>
        </div>
      </div>
      <button class="mm-btn" id="mm-start">‚öë Begin</button>
    </div>
    <!-- LOAD SAVES -->
    <div class="mm-pane" id="pane-load">
      <div class="mm-saves" id="mm-saves-list"></div>
      <div class="mm-hr"></div>
      <div style="font-size:9px;color:var(--text-dim);text-align:center;letter-spacing:.5px">
        Saves are stored in your browser. Up to 6 slots.
      </div>
    </div>
  </div>
  <div class="mm-ver">v5.0 ‚Äî Island Edition</div>
</div>
<div id="ui">
  <div id="canvasWrap">
    <div id="pixiMount"></div>
    <canvas id="gc"></canvas>
    <!-- nightOverlay: PixiJS ColorMatrixFilter handles day/night -->

    <!-- SEASON BADGE -->
    <div id="seasonBadge">
      <span id="sBadgeWorld" style="color:var(--gold);font-family:'Cinzel',serif;letter-spacing:1px;"></span>
      <span class="sep" id="sBadgeWorldSep" style="display:none">|</span>
      <span id="sBadgeSeason">üå∏ Spring</span>
      <span class="sep">|</span>
      <span id="sBadgeWeather">‚òÄ Clear</span>
      <span class="sep">|</span>
      <span id="sBadgeTime">üå§ Day</span>
      <span class="sep">|</span>
      <span id="sBadgeZoom">Zoom 100%</span>
    </div>

    <!-- NOTIFICATION FEED -->
    <div id="notifFeed"></div>

    <!-- DRAGGABLE: MINIMAP -->
    <div class="dpanel" id="minimapPanel">
      <div class="dpanel-title" data-panel="minimapPanel">
        <span><span class="dtitle-icon">üó∫</span>Map</span>
        <div class="dpanel-close" data-close="minimapPanel">‚úï</div>
      </div>
      <div class="dpanel-body">
        <canvas id="minimap" width="160" height="160"></canvas>
      </div>
    </div>

    <!-- DRAGGABLE: WORLD STATS -->
    <div class="dpanel" id="statsPanel">
      <div class="dpanel-title" data-panel="statsPanel">
        <span><span class="dtitle-icon">üåç</span>Realm Stats</span>
        <span style="font-size:8px;color:var(--text-dim);font-style:italic;font-family:'Crimson Pro',serif;letter-spacing:0" id="sAgeName">Age of Dawn</span>
        <div class="dpanel-close" data-close="statsPanel">‚úï</div>
      </div>
      <div class="dpanel-body">
        <div class="sr"><span class="sl">üìÖ Year</span><span class="sv" id="sY">0</span></div>
        <div class="sr"><span class="sl">üë• Population</span><span class="sv" id="sP">0</span></div>
        <div class="sbar"><div class="sbar-f" id="sPopBar" style="width:0%;background:linear-gradient(to right,#4a7828,#8ab840)"></div></div>
        <div class="sr"><span class="sl">üèò Settlements</span><span class="sv" id="sS">0</span></div>
        <div class="sr"><span class="sl">üèó Buildings</span><span class="sv" id="sB">0</span></div>
        <div class="sdiv"></div>
        <div class="sr"><span class="sl">ü™µ Wood</span><span class="sv" id="sW">0</span></div>
        <div class="sr"><span class="sl">ü™® Stone</span><span class="sv" id="sSt">0</span></div>
        <div class="sr"><span class="sl">üçñ Food</span><span class="sv" id="sF">0</span></div>
        <div class="sbar"><div class="sbar-f" id="sFoodBar" style="width:20%;background:linear-gradient(to right,#8a4020,#d06030)"></div></div>
        <div class="sr"><span class="sl">‚öó Tech</span><span class="sv" id="sT">1</span></div>
        <div class="sr"><span class="sl">üêæ Wildlife</span><span class="sv" id="sAnimal">0</span></div>
        <div class="sr"><span class="sl">ü¶† Disease</span><span class="sv" id="sDisease" style="color:#5a7840">None</span></div>
        <div class="sdiv"></div>
        <div class="sr morale-label"><span>‚öñ Morale</span><span class="morale-val" id="sMoraleVal">70</span></div>
        <div id="moraleTrack"><div id="moraleFill" style="width:70%;background:#5a9030;"></div></div>
      </div>
    </div>

    <!-- DRAGGABLE: CHRONICLE -->
    <div class="dpanel" id="chroniclePanel">
      <div class="dpanel-title" data-panel="chroniclePanel">
        <span><span class="dtitle-icon">üìú</span>Chronicle</span>
        <div class="dpanel-close" data-close="chroniclePanel">‚úï</div>
      </div>
      <div class="dpanel-body">
        <div id="eventLogBody"></div>
      </div>
    </div>

    <!-- DRAGGABLE: CHARACTER CARD -->
    <div class="dpanel" id="charCard">
      <div class="dpanel-title" data-panel="charCard">
        <span><span class="dtitle-icon">üë§</span>Character</span>
        <div class="dpanel-close" data-close="charCard">‚úï</div>
      </div>
      <div class="dpanel-body" id="charCardBody">
        <!-- filled dynamically -->
      </div>
    </div>


    <!-- MOBILE CONTROLS -->
    <div id="mobileControls">
      <!-- Joystick (pan) -->
      <div id="joystickWrap">
        <div id="joystickBase">
          <div id="joystickKnob"></div>
        </div>
      </div>
      <!-- Speed row -->
      <div id="mobileSpeedRow">
        <div class="mob-sp" data-speed="0">‚è∏</div>
        <div class="mob-sp active" data-speed="1">‚ñ∂</div>
        <div class="mob-sp" data-speed="2">‚ñ∂‚ñ∂</div>
        <div class="mob-sp" data-speed="3">‚ö°</div>
      </div>
      <!-- Tool drawer toggle -->
      <div id="toolDrawerBtn">üõ† Tools</div>
      <!-- Zoom -->
      <div id="zoomBtns">
        <div class="zoom-btn" id="zoomInBtn">+</div>
        <div class="zoom-btn" id="zoomOutBtn">‚àí</div>
      </div>
    </div>

    <!-- TOOL DRAWER (slides up) -->
    <div id="toolDrawerOverlay"></div>
    <div id="toolDrawer">
      <div id="toolDrawerHandle"></div>
      <div id="toolDrawerGrid">
        <div class="td-group-label">Life</div>
        <div class="td-btn active" data-tool="human">üßë<span class="lbl">Human</span></div>
        <div class="td-btn" data-tool="tree">üå≤<span class="lbl">Tree</span></div>
        <div class="td-btn" data-tool="animal">ü¶å<span class="lbl">Animal</span></div>
        <div class="td-btn" data-tool="heal">üíö<span class="lbl">Heal</span></div>
        <div class="td-btn" data-tool="inspect">üîç<span class="lbl">Inspect</span></div>
        <div class="td-btn" data-tool="erase">üóë<span class="lbl">Erase</span></div>

        <div class="td-group-label">Disasters</div>
        <div class="td-btn danger" data-tool="fire">üî•<span class="lbl">Fire</span></div>
        <div class="td-btn danger" data-tool="lightning">‚ö°<span class="lbl">Bolt</span></div>
        <div class="td-btn danger" data-tool="meteor">‚òÑÔ∏è<span class="lbl">Meteor</span></div>
        <div class="td-btn danger" data-tool="flood">üåä<span class="lbl">Flood</span></div>
        <div class="td-btn danger" data-tool="plague">ü¶†<span class="lbl">Plague</span></div>
        <div class="td-btn danger" data-tool="volcano">üåã<span class="lbl">Volcano</span></div>

        <div class="td-group-label">Divine</div>
        <div class="td-btn magic" data-tool="rain">üåß<span class="lbl">Rain</span></div>
        <div class="td-btn magic" data-tool="fertility">üåæ<span class="lbl">Fertile</span></div>
        <div class="td-btn magic" data-tool="inspire">‚ú®<span class="lbl">Inspire</span></div>

        <div class="td-group-label">Terrain</div>
        <div class="td-btn" data-tool="tGrass">üü©<span class="lbl">Grass</span></div>
        <div class="td-btn" data-tool="tWater">üü¶<span class="lbl">Water</span></div>
        <div class="td-btn" data-tool="tSand">üü®<span class="lbl">Sand</span></div>
        <div class="td-btn" data-tool="tMtn">‚¨ú<span class="lbl">Rock</span></div>
        <div class="td-btn" data-tool="tLava">üü•<span class="lbl">Lava</span></div>
      </div>
    </div>
    <div id="hint">WASD ¬∑ Scroll zoom ¬∑ Right-drag pan ¬∑ Click humans to inspect</div>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div id="speedCtrl">
      <button class="sp" data-speed="0" title="Pause">‚è∏</button>
      <button class="sp active" data-speed="1" title="1√ó">‚ñ∂</button>
      <button class="sp" data-speed="2" title="2√ó">‚ñ∂‚ñ∂</button>
      <button class="sp" data-speed="3" title="‚ö°">‚ö°</button>
    </div>
    <div class="hud-sep"></div>
    <div id="toolGroups">
      <div class="tool-group">
        <div class="tg-label">Life</div>
        <button class="tool-btn active" data-tool="human">üßë<span class="lbl">Human</span></button>
        <button class="tool-btn" data-tool="tree">üå≤<span class="lbl">Tree</span></button>
        <button class="tool-btn" data-tool="animal">ü¶å<span class="lbl">Animal</span></button>
        <button class="tool-btn" data-tool="heal">üíö<span class="lbl">Heal</span></button>
      </div>
      <div class="hud-sep"></div>
      <div class="tool-group">
        <div class="tg-label">Disasters</div>
        <button class="tool-btn danger" data-tool="fire">üî•<span class="lbl">Fire</span></button>
        <button class="tool-btn danger" data-tool="lightning">‚ö°<span class="lbl">Bolt</span></button>
        <button class="tool-btn danger" data-tool="meteor">‚òÑÔ∏è<span class="lbl">Meteor</span></button>
        <button class="tool-btn danger" data-tool="flood">üåä<span class="lbl">Flood</span></button>
        <button class="tool-btn danger" data-tool="plague">ü¶†<span class="lbl">Plague</span></button>
        <button class="tool-btn danger" data-tool="volcano">üåã<span class="lbl">Volcano</span></button>
      </div>
      <div class="hud-sep"></div>
      <div class="tool-group">
        <div class="tg-label">Divine</div>
        <button class="tool-btn magic" data-tool="rain">üåß<span class="lbl">Rain</span></button>
        <button class="tool-btn magic" data-tool="fertility">üåæ<span class="lbl">Fertile</span></button>
        <button class="tool-btn magic" data-tool="inspire">‚ú®<span class="lbl">Inspire</span></button>
      </div>
      <div class="hud-sep"></div>
      <div class="tool-group">
        <div class="tg-label">Terrain</div>
        <button class="tool-btn" data-tool="tGrass">üü©<span class="lbl">Grass</span></button>
        <button class="tool-btn" data-tool="tWater">üü¶<span class="lbl">Water</span></button>
        <button class="tool-btn" data-tool="tSand">üü®<span class="lbl">Sand</span></button>
        <button class="tool-btn" data-tool="tMtn">‚¨ú<span class="lbl">Rock</span></button>
        <button class="tool-btn" data-tool="tLava">üü•<span class="lbl">Lava</span></button>
      </div>
      <div class="hud-sep"></div>
      <div class="tool-group">
        <div class="tg-label">Inspect</div>
        <button class="tool-btn" data-tool="inspect">üîç<span class="lbl">Inspect</span></button>
        <button class="tool-btn" data-tool="erase">üóë<span class="lbl">Erase</span></button>
      </div>
      <div class="hud-sep"></div>
      <div class="tool-group">
        <button id="newWorldBtn">üåç<span class="lbl">New World</span></button>
        <button id="saveBtn">üíæ<span class="lbl">Save</span></button>
        <button id="menuBtn">‚ò∞<span class="lbl">Menu</span></button>
        <button id="settingsBtn" title="Settings">‚öô</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê -->
<div id="settingsOverlay">
  <div id="settingsModal">
    <div class="sm-header">
      <span class="sm-title">‚öô Settings</span>
      <div class="sm-close" id="settingsClose">‚úï</div>
    </div>
    <div class="sm-body">

      <!-- DISPLAY -->
      <div class="sm-section">
        <div class="sm-section-title">Display</div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Wave Animation</div>
            <div class="sm-desc">Animated water surface</div>
          </div>
          <div class="sm-control">
            <label class="sm-toggle"><input type="checkbox" id="st-waves" checked><div class="sm-toggle-track"></div><div class="sm-toggle-thumb"></div></label>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Wave Speed</div>
            <div class="sm-desc">How fast waves travel</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-waveSpeed" min="20" max="200" value="100">
            <span class="sm-val" id="st-waveSpeed-val">1√ó</span>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Wave Intensity</div>
            <div class="sm-desc">Contrast of wave colour shift</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-waveIntensity" min="0" max="200" value="100">
            <span class="sm-val" id="st-waveIntensity-val">1√ó</span>
          </div>
        </div>
      </div>

      <!-- CAMERA -->
      <div class="sm-section">
        <div class="sm-section-title">Camera</div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Pan Speed</div>
            <div class="sm-desc">WASD / arrow key speed</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-panSpeed" min="20" max="300" value="100">
            <span class="sm-val" id="st-panSpeed-val">1√ó</span>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Zoom Speed</div>
            <div class="sm-desc">Scroll wheel zoom rate</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-zoomSpeed" min="50" max="250" value="100">
            <span class="sm-val" id="st-zoomSpeed-val">1√ó</span>
          </div>
        </div>
      </div>

      <!-- MOBILE -->
      <div class="sm-section" id="sm-mobile-section">
        <div class="sm-section-title">Mobile Controls</div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Show Controls</div>
            <div class="sm-desc">Force-show mobile overlay</div>
          </div>
          <div class="sm-control">
            <label class="sm-toggle"><input type="checkbox" id="st-mobileForce"><div class="sm-toggle-track"></div><div class="sm-toggle-thumb"></div></label>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Joystick Sensitivity</div>
            <div class="sm-desc">Pan speed when using joystick</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-joySens" min="20" max="300" value="100">
            <span class="sm-val" id="st-joySens-val">1√ó</span>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Joystick Size</div>
            <div class="sm-desc">Visual size of the joystick</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-joySize" min="60" max="160" value="96">
            <span class="sm-val" id="st-joySize-val">96px</span>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Joystick Opacity</div>
            <div class="sm-desc">Transparency of controls overlay</div>
          </div>
          <div class="sm-control">
            <input class="sm-slider" type="range" id="st-joyOpacity" min="20" max="100" value="75">
            <span class="sm-val" id="st-joyOpacity-val">75%</span>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Tap to Use Tool</div>
            <div class="sm-desc">Single tap fires active tool</div>
          </div>
          <div class="sm-control">
            <label class="sm-toggle"><input type="checkbox" id="st-tapTool" checked><div class="sm-toggle-track"></div><div class="sm-toggle-thumb"></div></label>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Pinch to Zoom</div>
            <div class="sm-desc">Two-finger pinch zoom</div>
          </div>
          <div class="sm-control">
            <label class="sm-toggle"><input type="checkbox" id="st-pinchZoom" checked><div class="sm-toggle-track"></div><div class="sm-toggle-thumb"></div></label>
          </div>
        </div>
      </div>

      <!-- SIMULATION -->
      <div class="sm-section">
        <div class="sm-section-title">Simulation</div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Show Notifications</div>
            <div class="sm-desc">Pop-up event messages</div>
          </div>
          <div class="sm-control">
            <label class="sm-toggle"><input type="checkbox" id="st-notifs" checked><div class="sm-toggle-track"></div><div class="sm-toggle-thumb"></div></label>
          </div>
        </div>
        <div class="sm-row">
          <div class="sm-label-wrap">
            <div class="sm-label">Day/Night Overlay</div>
            <div class="sm-desc">Darken canvas at night</div>
          </div>
          <div class="sm-control">
            <label class="sm-toggle"><input type="checkbox" id="st-daynight" checked><div class="sm-toggle-track"></div><div class="sm-toggle-thumb"></div></label>
          </div>
        </div>
      </div>

      <button class="sm-reset" id="st-reset">‚Ü∫ Reset to Defaults</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAGGABLE PANELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initDraggable(){
  // Single shared drag state ‚Äî only one panel moves at a time
  let activePanel=null,ox=0,oy=0,zTop=20;

  function positionPanels(){
    // Set initial positions after layout using pixel coords based on window size
    const hud=74; // HUD height in px
    const bottom=window.innerHeight-hud;
    const defaults={
      minimapPanel:   {left:12,              top:bottom-180},
      statsPanel:     {left:196,             top:bottom-280},
      chroniclePanel: {left:416,             top:bottom-220},
      charCard:       {left:window.innerWidth-274, top:50},
    };
    Object.entries(defaults).forEach(([id,pos])=>{
      const el=document.getElementById(id);
      if(!el)return;
      el.style.left=pos.left+'px';
      el.style.top=pos.top+'px';
      el.style.bottom='';
      el.style.right='';
    });
  }

  // Run after first paint so offsetHeight is accurate
  requestAnimationFrame(positionPanels);

  document.querySelectorAll('.dpanel-title[data-panel]').forEach(titleBar=>{
    const panel=document.getElementById(titleBar.dataset.panel);
    if(!panel)return;

    titleBar.addEventListener('mousedown',e=>{
      if(e.target.classList.contains('dpanel-close'))return;
      e.preventDefault();
      const rect=panel.getBoundingClientRect();
      panel.style.left=rect.left+'px';
      panel.style.top=rect.top+'px';
      panel.style.bottom='';
      panel.style.right='';
      panel.style.zIndex=++zTop;
      ox=e.clientX-rect.left;
      oy=e.clientY-rect.top;
      activePanel=panel;
    });

    titleBar.addEventListener('touchstart',e=>{
      if(e.target.classList.contains('dpanel-close'))return;
      const t=e.touches[0];
      const rect=panel.getBoundingClientRect();
      panel.style.left=rect.left+'px';
      panel.style.top=rect.top+'px';
      panel.style.bottom='';
      panel.style.right='';
      panel.style.zIndex=++zTop;
      ox=t.clientX-rect.left;
      oy=t.clientY-rect.top;
      activePanel=panel;
    },{passive:true});
  });

  // Single move/up listener on document ‚Äî no duplicates
  document.addEventListener('mousemove',e=>{
    if(!activePanel)return;
    const maxX=window.innerWidth-activePanel.offsetWidth;
    const maxY=window.innerHeight-activePanel.offsetHeight;
    activePanel.style.left=Math.max(0,Math.min(maxX,e.clientX-ox))+'px';
    activePanel.style.top=Math.max(0,Math.min(maxY,e.clientY-oy))+'px';
  });
  document.addEventListener('mouseup',()=>{activePanel=null;});
  document.addEventListener('mouseleave',()=>{activePanel=null;});

  document.addEventListener('touchmove',e=>{
    if(!activePanel)return;
    const t=e.touches[0];
    const maxX=window.innerWidth-activePanel.offsetWidth;
    const maxY=window.innerHeight-activePanel.offsetHeight;
    activePanel.style.left=Math.max(0,Math.min(maxX,t.clientX-ox))+'px';
    activePanel.style.top=Math.max(0,Math.min(maxY,t.clientY-oy))+'px';
  },{passive:true});
  document.addEventListener('touchend',()=>{activePanel=null;});

  // Close buttons
  document.querySelectorAll('.dpanel-close[data-close]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const panel=document.getElementById(btn.dataset.close);
      if(panel){panel.style.display=panel.style.display==='none'?'block':'none';}
    });
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORE SETUP
// 2D canvas handles all drawing. PixiJS sits behind it as a WebGL
// compositing layer ‚Äî it receives the 2D canvas as a texture each
// frame and applies GPU post-processing filters (day/night tint,
// fire bloom, fog blur) without touching any game logic.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const G=120,CS=16;
const wrap=document.getElementById('canvasWrap');

// ‚îÄ‚îÄ 2D drawing canvas (all game rendering happens here) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas=document.getElementById('gc');
// 2D canvas: styled via CSS (#gc), used as offscreen texture for PixiJS
const ctx=canvas.getContext('2d',{alpha:false,willReadFrequently:false});

const mmEl=document.getElementById('minimap');
const mmc=mmEl.getContext('2d',{alpha:false});

let _lastW=0,_lastH=0,_resizeTimer=null;

// ‚îÄ‚îÄ PixiJS Application ‚Äî WebGL compositor behind the 2D canvas ‚îÄ‚îÄ‚îÄ‚îÄ
// PixiJS renders the 2D canvas as a full-screen texture and applies:
//   ‚Ä¢ ColorMatrixFilter  ‚Äî day/night colour grading
//   ‚Ä¢ BlurFilter         ‚Äî fog atmospheric blur
//   ‚Ä¢ Additive blend     ‚Äî fire/lava glow bloom
// The PixiJS canvas sits at z-index:1, the 2D canvas at z-index:2.
const _pApp = new PIXI.Application({
  width:  wrap.clientWidth  || 800,
  height: wrap.clientHeight || 600,
  backgroundColor: 0x000000,
  antialias: false,
  resolution: 1,
  autoDensity: false,
  powerPreference: 'high-performance',
});
document.getElementById('pixiMount').appendChild(_pApp.view);
_pApp.view.id = 'pixiCanvas';
_pApp.ticker.stop(); // driven by our own RAF loop

// Upload the 2D canvas as a PixiJS texture each frame
const _baseTexture = new PIXI.BaseTexture(canvas, {
  scaleMode: PIXI.SCALE_MODES.NEAREST, // pixel-art: no interpolation
});
const _canvasTex = new PIXI.Texture(_baseTexture);
const _canvasSprite = new PIXI.Sprite(_canvasTex);
_canvasSprite.width  = _pApp.renderer.width;
_canvasSprite.height = _pApp.renderer.height;

// ‚îÄ‚îÄ Layer 1: world sprite (colour-graded for day/night) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _worldContainer = new PIXI.Container();
_worldContainer.addChild(_canvasSprite);
_pApp.stage.addChild(_worldContainer);

// ColorMatrix for day/night tint on the whole scene
const _cmWorld = new PIXI.ColorMatrixFilter();
_worldContainer.filters = [_cmWorld];

// ‚îÄ‚îÄ Layer 2: fire bloom ‚Äî additive glow sprites ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We draw glowing rectangles here; BlurFilter makes them bloom
const _gBloom  = new PIXI.Graphics();
const _bloomContainer = new PIXI.Container();
_bloomContainer.addChild(_gBloom);
_bloomContainer.blendMode = PIXI.BLEND_MODES.ADD;
const _bloomFilter = new PIXI.BlurFilter(8, 2);
_bloomFilter.quality = 2;
_bloomContainer.filters = [_bloomFilter];
_pApp.stage.addChild(_bloomContainer);

// ‚îÄ‚îÄ Layer 3: full-screen weather effects drawn in WebGL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Rain/snow/fog drawn as PixiJS Graphics on top of everything

// ‚îÄ‚îÄ Layer 4: fog blur ‚Äî applied to world when fog active ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _fogFilter = new PIXI.BlurFilter(3, 1);
_fogFilter.quality = 1;

function _applyDayNightFilter(){
  _cmWorld.reset();
  if(!S||!S.daynight) return;
  if(dayPhase===2){
    // Night: deep blue tint, strongly darkened
    _cmWorld.matrix=[
      0.22, 0.03, 0.08, 0, -0.04,
      0.02, 0.14, 0.08, 0, -0.06,
      0.04, 0.04, 0.45, 0, +0.06,
      0,    0,    0,    1,  0,
    ];
  } else if(dayPhase===1){
    // Dusk: warm amber
    _cmWorld.matrix=[
      1.18, 0.10, 0.00, 0,  0.03,
      0.06, 0.88, 0.00, 0, -0.03,
      0.00, 0.00, 0.65, 0, -0.06,
      0,    0,    0,    1,  0,
    ];
  } else if(dayPhase===3){
    // Dawn: soft rose-gold
    _cmWorld.matrix=[
      1.12, 0.06, 0.04, 0,  0.02,
      0.03, 0.84, 0.04, 0, -0.02,
      0.00, 0.00, 0.78, 0, -0.04,
      0,    0,    0,    1,  0,
    ];
  }
  // Fog: add blur filter to world
  if(weather.type==='fog'){
    _worldContainer.filters=[_cmWorld,_fogFilter];
  } else {
    _worldContainer.filters=[_cmWorld];
  }
}

function resize(){
  const w=wrap.clientWidth,h=wrap.clientHeight;
  if(w===_lastW&&h===_lastH)return;
  _lastW=w;_lastH=h;
  canvas.width=w;canvas.height=h;
  _pApp.renderer.resize(w,h);
  _canvasSprite.width=w;
  _canvasSprite.height=h;
}
resize();
window.addEventListener('resize',()=>{
  clearTimeout(_resizeTimer);
  _resizeTimer=setTimeout(resize,150);
});

const cam={x:0,y:0,zoom:0.6,min:0.3,max:8.0};
const keys={};
function cz(){return CS*cam.zoom;}
function sx(wx){return(wx-cam.x)*cz();}
function sy(wy){return(wy-cam.y)*cz();}
function wxf(sx2){return sx2/cz()+cam.x;}
function wyf(sy2){return sy2/cz()+cam.y;}
function clamp(){const c=cz();const pw=_pApp.renderer.width,ph=_pApp.renderer.height;cam.x=Math.max(0,Math.min(G-pw/c,cam.x));cam.y=Math.max(0,Math.min(G-ph/c,cam.y));}
function rnd(n){return Math.floor(Math.random()*n);}
function mdist(ax,ay,bx,by){return Math.abs(ax-bx)+Math.abs(ay-by);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TERRAIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TER={
  // 8 variants per terrain ‚Äî large tonal spread so noise-seeded clusters read clearly
  GRASS:{walkable:true,color:'#86b84b',
    v:['#86b84b','#618135','#86b84b','#618135','#86b84b','#618135','#86b84b','#618135'],
    lite:'#a0d060',dark:'#4a6228',dkk:'#2e3c18'},
  WATER:{walkable:false,color:'#2e78c4',
    v:['#2e78c4','#163c88','#4aa0e0','#1a4c9c','#5cb4f0','#204070','#3888d0','#1258a8'],
    lite:'#6cc8f8',dark:'#0c2c68',dkk:'#081848'},
  SAND:{walkable:true,color:'#e8eba4',
    v:['#e8eba4','#d8db90','#e8eba4','#d8db90','#e8eba4','#d8db90','#e8eba4','#d8db90'],
    lite:'#f4f6c0',dark:'#b8ba78',dkk:'#888a50'},
  MOUNTAIN:{walkable:false,color:'#7c7468',
    v:['#7c7468','#4c4840','#a09890','#585450','#bcb4ac','#3c3838','#8c8478','#606060'],
    lite:'#d0c8c0',dark:'#383430',dkk:'#201e1c'},
  SNOW:{walkable:true,color:'#e0f0f8',
    v:['#e0f0f8','#a8c8e0','#f4fcff','#b8d8ec','#ffffff','#90b4cc','#d0e8f4','#c0d8ec'],
    lite:'#ffffff',dark:'#80a8c0',dkk:'#507080'},
  LAVA:{walkable:false,color:'#e83810',
    v:['#e83810','#f86020','#c01c08','#f04818','#ff8030','#a01008','#e84820','#d82c0c'],
    lite:'#ff9040',dark:'#780808',dkk:'#380404'},
  MARSH:{walkable:true,color:'#3c7830',
    v:['#3c7830','#1c4c14','#58a040','#285a20','#70b850','#183c10','#487830','#326828'],
    lite:'#70c048',dark:'#143c0c',dkk:'#0c2808'},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROLES SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLES={
  'hunter':{
    label:'Hunter',emoji:'üèπ',color:'#c87820',border:'#e09030',
    desc:'Hunts deer for the village food supply.',
    bonus:'Kills deer for large food yield',
    statBoost:{str:15,agi:10},
    traits:['Swift','Keen-eyed','Wilderness-wise'],
  },
  'gatherer':{
    label:'Gatherer',emoji:'üåø',color:'#4a9030',border:'#70b840',
    desc:'Forages for berries and plants.',
    bonus:'Gathers food from wild plants',
    statBoost:{wis:10,end:5},
    traits:['Patient','Resourceful','Nature-bond'],
  },
  'farmer':{
    label:'Farmer',emoji:'üåæ',color:'#8ab030',border:'#a8d040',
    desc:'Works the farm to steadily produce food.',
    bonus:'Generates food each work cycle',
    statBoost:{end:15,wis:5},
    traits:['Hard-working','Grounded'],
  },
  'lumberjack':{
    label:'Lumberjack',emoji:'ü™ì',color:'#a05020',border:'#c07030',
    desc:'Chops trees to keep the village supplied with wood.',
    bonus:'Chops wood faster and yields more per tree',
    statBoost:{str:20,end:10},
    traits:['Strong-backed','Methodical'],
  },
  'builder':{
    label:'Builder',emoji:'‚öí',color:'#c06028',border:'#e08040',
    desc:'Constructs buildings to grow the settlement.',
    bonus:'Builds faster, lower wood cost',
    statBoost:{str:10,int:5},
    traits:['Methodical','Strong-backed'],
  },
  'miner':{
    label:'Miner',emoji:'‚õè',color:'#6878a0',border:'#8898c0',
    desc:'Mines stone and ore from rocks.',
    bonus:'Mines yield 2√ó stone per trip',
    statBoost:{str:20,end:10},
    traits:['Tireless','Stone-sense'],
  },
  'scholar':{
    label:'Scholar',emoji:'üìñ',color:'#4070b0',border:'#6090d0',
    desc:'Studies in libraries to advance technology.',
    bonus:'Knowledge generation +50%',
    statBoost:{int:25,wis:15},
    traits:['Curious','Sharp-minded','Bookish'],
  },
  'warrior':{
    label:'Warrior',emoji:'‚öî',color:'#a03020',border:'#c84030',
    desc:'Patrols the settlement perimeter and fights wolves.',
    bonus:'Protects nearby humans from wolves & disease',
    statBoost:{str:25,end:15},
    traits:['Fearless','Battle-hardened'],
  },
  'herbalist':{
    label:'Herbalist',emoji:'üå±',color:'#30a060',border:'#50c080',
    desc:'Heals the sick and cures disease.',
    bonus:'Cures infected neighbours 3√ó faster',
    statBoost:{wis:20,int:10},
    traits:['Gentle','Plant-lore','Healer'],
  },
  'merchant':{
    label:'Merchant',emoji:'ü™ô',color:'#c8a030',border:'#e8c040',
    desc:'Trades between settlements, generating wealth.',
    bonus:'Trade routes yield +50% resources',
    statBoost:{cha:20,int:10},
    traits:['Shrewd','Well-traveled','Silver-tongued'],
  },
  'leader':{
    label:'Leader',emoji:'üëë',color:'#c8a030',border:'#f0c840',
    desc:'Leads the settlement, boosting everyone\'s output.',
    bonus:'Settlement members work 20% faster',
    statBoost:{cha:25,int:15,wis:10},
    traits:['Commanding','Inspiring','Wise'],
  },
  'elder':{
    label:'Elder',emoji:'üßô',color:'#9878c0',border:'#b898e0',
    desc:'Old and wise. Shares knowledge, boosts morale.',
    bonus:'Tech & morale passively increase nearby',
    statBoost:{wis:30,int:20},
    traits:['Ancient','Sage','Revered'],
  },
  'explorer':{
    label:'Explorer',emoji:'üß≠',color:'#20a898',border:'#40c8b8',
    desc:'Scouts the wilderness and reports resource locations to the settlement.',
    bonus:'Moves 2√ó faster, discovers trees/stones/food for others to harvest',
    statBoost:{agi:25,end:15,wis:10},
    traits:['Adventurous','Sharp-eyed','Tireless'],
  },
  'none':{
    label:'Wanderer',emoji:'üö∂',color:'#708060',border:'#909878',
    desc:'No role yet. Will find their path.',
    bonus:'None',
    statBoost:{},
    traits:['Restless'],
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIRST_NAMES=['Aldric','Bryn','Cael','Dara','Edwyn','Fenn','Gael','Hild','Ivar','Jana',
  'Kira','Lorn','Mira','Nael','Oswin','Pera','Quinn','Reva','Soen','Tara',
  'Uric','Vael','Wren','Xara','Yvor','Zara','Aela','Brom','Cera','Dwyn',
  'Elan','Fira','Gorn','Hara','Idris','Jael','Kern','Lyra','Morn','Nira'];
const LAST_NAMES=['Ashwood','Blackmere','Coldwater','Dawnfield','Eastholm','Firestone',
  'Greymoor','Highvale','Ironwood','Jadecrest','Kindlebrook','Larchford',
  'Misthollow','Nightfall','Oakhaven','Pinecrest','Quickwater','Riverstone',
  'Silverwood','Thornfield','Underholt','Valecroft','Wildbourne','Yewdale'];
const SET_NP=['Oak','River','Stone','Pine','Hill','Vale','Iron','Gold','Silver','Ash','Moor','Grey'];
const SET_NS=['haven','ford','dale','hold','wood','bridge','gate','moor','shire','fell','crest','mere'];
const DN=['Spotted Fever','Black Pox','Marsh Sickness','Bone Ague','Creeping Rot','Grey Plague'];
function genHumanName(){return FIRST_NAMES[rnd(FIRST_NAMES.length)]+' '+LAST_NAMES[rnd(LAST_NAMES.length)];}
function genSettName(){return SET_NP[rnd(SET_NP.length)]+SET_NS[rnd(SET_NS.length)];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let world,year,tick,speed=1,tool='human';
let worldName='',worldSeed='';
let season=0,seasonTick=0,dayTick=0,dayPhase=0;
let weather={type:'clear',intensity:0,ticks:0};
let worldMorale=70,diseaseActive=false,diseaseName='',diseaseSeverity=0;
let pendingNotifs=[],eventLog=[];
let selectedEntity=null;

// ‚îÄ‚îÄ‚îÄ Performance: spatial lookups ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// pathMap: "x,y" -> path object  (O(1) lookup replacing O(n) find)
let pathMap=new Map();
// foodSet: "x,y" -> food object
let foodSet=new Map();
// treeMap: "x,y" -> tree object
let treeMap=new Map();
// Minimap dirty flag ‚Äî only redraw when world changes
let minimapDirty=true;
// Cached DOM refs for stat panel (set on first use)
let _domCache={};
function _dom(id){return _domCache[id]||(_domCache[id]=document.getElementById(id));}
// Per-frame timestamp (avoid repeated Date.now() calls)
let _frameNow=0;
// Infected count cache (recomputed once per update cycle)
let _infectedCount=0;

function notify(msg,type='normal'){if(S&&!S.notifs)return;pendingNotifs.push({msg,type});}
function flushNotifs(){
  const feed=_dom('notifFeed');
  while(pendingNotifs.length>0){
    const {msg,type}=pendingNotifs.shift();
    const el=document.createElement('div');
    el.className='notif '+(type==='danger'?'danger':type==='good'?'good':'');
    el.textContent=msg;
    feed.appendChild(el);
    setTimeout(()=>el.remove(),4000);
  }
  while(feed.children.length>5)feed.removeChild(feed.firstChild);
}
function logEvent(msg){
  eventLog.unshift(msg);if(eventLog.length>30)eventLog.pop();
  const body=_dom('eventLogBody');
  body.innerHTML=eventLog.slice(0,10).map(m=>`<div>${m}</div>`).join('');
  minimapDirty=true;
}

function addFood(x,y){
  if(x>=0&&x<G&&y>=0&&y<G){
    const t=world.terrain[y][x];
    const k=x+','+y;
    if((t==='GRASS'||t==='SAND'||t==='MARSH')&&!treeMap.has(k)&&!foodSet.has(k)){
      const f={x,y};world.food.push(f);foodSet.set(k,f);minimapDirty=true;
    }
  }
}
function layPath(x0,y0,x1,y1){
  let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx2=x0<x1?1:-1,sy2=y0<y1?1:-1,err=dx-dy,cx=x0,cy=y0;
  while(true){
    if(cx>=0&&cx<G&&cy>=0&&cy<G&&world.terrain[cy][cx]!=='WATER'&&world.terrain[cy][cx]!=='MOUNTAIN'){
      const k=cx+','+cy;
      const ex=pathMap.get(k);
      if(ex)ex.worn=Math.min(ex.worn+1,20);else{const p={x:cx,y:cy,worn:3};world.paths.push(p);pathMap.set(k,p);}
    }
    if(cx===x1&&cy===y1)break;
    const e2=2*err;
    if(e2>-dy){err-=dy;cx+=sx2;}
    if(e2<dx){err+=dx;cy+=sy2;}
  }
}
function setT(x,y,t){
  if(x>=0&&x<G&&y>=0&&y<G){
    world.terrain[y][x]=t;
    const nv=(TER[t]?.v?.length)||5;
    const hv=((x*2749+y*3541)^(x*57+y*131))&0xffff;
    world.tv[y][x]=hv%nv;
    minimapDirty=true;
  }
}

function freshWorld(){
  world={terrain:[],tv:[],entities:[],trees:[],stones:[],food:[],
    buildings:[],fires:[],paths:[],settlements:[],animals:[],lavaFlows:[],
    elev:[], // [{y][x}] 0.0-1.0 elevation per tile
    depth:[], // [{y][x}] 0.0=shoreline 1.0=deepest ‚Äî computed after island gen
    crops:[], // [{x,y,stage,maxStage,farmId}] growing crop tiles
    knownResources:[], // [{x,y,type}] discovered by explorers
    res:{wood:0,stone:0,food:0,knowledge:0,faith:0},tech:1};
  year=0;tick=0;season=0;seasonTick=0;dayTick=0;dayPhase=0;
  weather={type:'clear',intensity:0,ticks:0};worldMorale=70;
  diseaseActive=false;diseaseName='';diseaseSeverity=0;
  eventLog=[];selectedEntity=null;
  pathMap.clear();foodSet.clear();treeMap.clear();
  minimapDirty=true;
  _dom('eventLogBody').innerHTML='';
  _dom('charCard').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARACTER CARD UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCharCard(entity){
  selectedEntity=entity;
  const panel=_dom('charCard');
  panel.style.display='block';
  refreshCharCard();
}
function refreshCharCard(){
  if(!selectedEntity||selectedEntity.health<=0){
    _dom('charCard').style.display='none';
    selectedEntity=null;return;
  }
  const e=selectedEntity;
  const role=ROLES[e.profession]||ROLES['none'];
  const age=e.age;
  const ageLabel=age<900?'Young':age<4500?'Adult':age<9000?'Middle-aged':age<14000?'Old':'Ancient';
  const body=_dom('charCardBody');

  // Life stage emoji
  const lifeEmoji=age<900?'üë∂':age<4500?'üßë':age<9000?'üßî':age<14000?'üë¥':'üßô';

  const stateLabels={idle:'Resting',gwood:'Chopping wood',gstone:'Mining stone',gfood:'Foraging',
    building:'Building',working:'At work',farming:'Farming',hunting:'Hunting',patrolling:'On patrol',
    healing:'Healing others',trading:'Trading',sleeping:'Sleeping',courting:'Seeking partner'};
  const stateLabel=stateLabels[e.state]||e.state;

  body.innerHTML=`
    <div class="cc-header">
      <div class="cc-avatar" style="border-color:${role.border}">${role.emoji}</div>
      <div>
        <div class="cc-name">${e.name}</div>
        <div style="margin-bottom:4px">
          <span class="cc-role-badge" style="color:${role.color};border-color:${role.border};background:rgba(0,0,0,0.3)">${role.emoji} ${role.label}</span>
        </div>
        <div class="cc-role" style="color:var(--text-dim)">${lifeEmoji} ${ageLabel} ¬∑ ${e.settlement?e.settlement.name:'Wanderer'}</div>
        <div style="font-size:9px;color:#8ab840;margin-top:2px;font-style:italic">${stateLabel}</div>
      </div>
    </div>
    ${e.infected?`<div class="cc-infected">ü¶† Infected with ${diseaseName}</div>`:''}
    <div class="cc-divider"></div>
    <div class="cc-section-title">Vitals</div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">‚ù§ Health</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${e.health}%;background:${e.health>60?'#4a8830':e.health>30?'#a08020':'#882020'}"></div></div>
      <span class="cc-stat-val">${Math.floor(e.health)}</span>
    </div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üçñ Hunger</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${Math.min(100,e.hunger)}%;background:${e.hunger<40?'#5a7830':e.hunger<80?'#a07820':'#aa3020'}"></div></div>
      <span class="cc-stat-val">${Math.floor(e.hunger)}</span>
    </div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üò¥ Tired</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${Math.min(100,e.tiredness)}%;background:${e.tiredness<50?'#3a5880':e.tiredness<80?'#7840a0':'#402060'}"></div></div>
      <span class="cc-stat-val">${Math.floor(e.tiredness)}</span>
    </div>
    <div class="cc-divider"></div>
    <div class="cc-section-title">Attributes</div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üí™ Strength</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${e.str}%;background:#a06030"></div></div>
      <span class="cc-stat-val">${Math.floor(e.str)}</span>
    </div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üß† Intellect</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${e.int}%;background:#3060b0"></div></div>
      <span class="cc-stat-val">${Math.floor(e.int)}</span>
    </div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üåø Wisdom</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${e.wis}%;background:#306840"></div></div>
      <span class="cc-stat-val">${Math.floor(e.wis)}</span>
    </div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üèÉ Agility</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${e.agi}%;background:#609040"></div></div>
      <span class="cc-stat-val">${Math.floor(e.agi)}</span>
    </div>
    <div class="cc-stat-row">
      <span class="cc-stat-label">üí¨ Charisma</span>
      <div class="cc-bar-wrap"><div class="cc-bar-fill" style="width:${e.cha}%;background:#9040a0"></div></div>
      <span class="cc-stat-val">${Math.floor(e.cha)}</span>
    </div>
    <div class="cc-divider"></div>
    <div class="cc-section-title">Traits</div>
    <div>${(e.traits||[]).map(t=>`<span class="cc-trait">${t}</span>`).join('')}</div>
    <div class="cc-divider"></div>
    ${e.partner?`<div style="font-size:9px;color:#9878c0;margin-bottom:4px">üíë Partner: ${e.partner.name}</div>`:''}
    <div class="cc-section-title">Assign Role</div>
    <div class="cc-actions" id="ccRoleButtons"></div>
    <div class="cc-divider"></div>
    <div class="cc-section-title">Life Events</div>
    <div class="cc-history">${(e.lifeEvents||[]).slice(-8).reverse().map(ev=>`<div class="cc-life-event">${ev}</div>`).join('')||'<span style="color:var(--text-dim);font-style:italic;font-size:9px">No events yet</span>'}</div>
    <div class="cc-divider"></div>
    <div style="display:flex;gap:4px">
      <div class="cc-btn" id="ccHealBtn" style="border-color:#4a7828;color:#8ab840">üíö Heal</div>
      <div class="cc-btn" id="ccFollowBtn">üìç Follow</div>
      <div class="cc-btn" id="ccFreeBtn" style="border-color:#7a3020;color:#c06040">‚ò† Remove</div>
    </div>
  `;

  // Populate role buttons
  const rbContainer=_dom('ccRoleButtons');
  Object.entries(ROLES).filter(([k])=>k!=='none').forEach(([key,r])=>{
    const btn=document.createElement('div');
    btn.className='cc-btn'+(e.profession===key?' active-role':'');
    btn.style.minWidth='70px';
    btn.textContent=`${r.emoji} ${r.label}`;
    btn.title=r.desc;
    btn.addEventListener('click',()=>{
      assignRole(e,key);
      refreshCharCard();
      logEvent(`Year ${year} ‚Äî ${e.name} becomes a ${r.label}.`);
    });
    rbContainer.appendChild(btn);
  });

  // Action buttons
  _dom('ccHealBtn').addEventListener('click',()=>{
    e.health=100;e.hunger=0;e.tiredness=0;e.infected=false;
    e.lifeEvents.push(`Year ${year}: Healed by divine power.`);
    refreshCharCard();notify('üíö '+e.name+' healed','good');
  });
  document.getElementById('ccFollowBtn').addEventListener('click',()=>{
    // Pan camera to follow entity
    cam.x=e.x-_pApp.renderer.width/cz()/2;cam.y=e.y-_pApp.renderer.height/cz()/2;clamp();
  });
  document.getElementById('ccFreeBtn').addEventListener('click',()=>{
    e.health=0;selectedEntity=null;
    _dom('charCard').style.display='none';
    notify('‚ò† '+e.name+' removed');
  });
}

function assignRole(entity,roleKey){
  entity.profession=roleKey;
  const role=ROLES[roleKey];
  if(role.statBoost){
    Object.entries(role.statBoost).forEach(([stat,val])=>{
      entity[stat]=Math.min(100,(entity[stat]||50)+val);
    });
  }
  (role.traits||[]).forEach(t=>{
    if(!(entity.traits||[]).includes(t)){entity.traits=entity.traits||[];entity.traits.push(t);}
  });
  // Assign workplace for roles that have one
  if(world&&entity.settlement){
    const typeMap={farmer:'farm',miner:'mine',scholar:'library',warrior:'barracks',merchant:'market'};
    const wt=typeMap[roleKey];
    if(wt){const wp=world.buildings.find(b=>b.type===wt&&b.settlement===entity.settlement||b.type===wt);if(wp)entity.workplace=wp;}
  }
  entity.tx=null;entity.ty=null;entity.state='idle';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENTITY CLASS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Entity{
  constructor(x,y){
    this.x=x;this.y=y;this.health=100;this.age=0;
    this.hunger=Math.random()*15;this.tiredness=Math.random()*15;
    this.state='idle';this.profession='none';
    this.settlement=null;this.home=null;this.workplace=null;
    this.tx=null;this.ty=null;this.lx=x;this.ly=y;this.stk=0;this.prey=null;this.moveTick=rnd(20);
    // Core stats
    this.str=30+Math.random()*40;
    this.int=30+Math.random()*40;
    this.wis=20+Math.random()*40;
    this.agi=20+Math.random()*40;
    this.cha=20+Math.random()*40;
    this.end=20+Math.random()*40;
    // Identity
    this.name=genHumanName();
    this.traits=this.genTraits();
    this.lifeEvents=[`Year ${year}: Born into the world.`];
    this._lastBuildingX=null;this._lastBuildingY=null;
    this.infected=false;this.infectedTicks=0;
    this._selected=false;
    this.walkFrame=0;this.walkTick=0;this.facing=1;this.isMoving=false;
    this.rx=x;this.ry=y;
    this.partner=null;       // bonded partner
    this.breedCooldown=0;    // ticks until can breed again
  }
  genTraits(){
    const allTraits=['Brave','Cautious','Curious','Stubborn','Kind','Greedy','Loyal','Independent',
      'Strong','Nimble','Wise','Foolish','Lucky','Unlucky','Ambitious','Content','Artistic','Practical'];
    const count=1+rnd(3);
    const chosen=[];
    while(chosen.length<count){const t=allTraits[rnd(allTraits.length)];if(!chosen.includes(t))chosen.push(t);}
    return chosen;
  }
  update(){
    try{
      this.age+=0.25;this.hunger+=0.0008;this.tiredness+=0.0005; // slower rates ‚Äî longer lives
      if(season===3){this.hunger+=0.0004;this.tiredness+=0.0004;}

      // Elder passive
      if(this.profession==='elder'&&this.age>7200&&tick%60===0){
        worldMorale=Math.min(100,worldMorale+0.3);
        world.res.knowledge++;
      }
      // Leader passive ‚Äî boost nearby settlement members
      if(this.profession==='leader'&&this.settlement&&tick%30===0){
        this.settlement.members.forEach(m=>{
          if(m!==this){m.hunger=Math.max(0,m.hunger-0.5);m.tiredness=Math.max(0,m.tiredness-0.3);}
        });
      }
      // Warrior passive ‚Äî damage nearby wolves
      if(this.profession==='warrior'){
        world.animals.forEach(a=>{
          if(a.type==='wolf'&&mdist(a.x,a.y,this.x,this.y)<5){a.health-=2;}
        });
        if(this.infected&&Math.random()<0.005)this.infected=false;
      }
      // Herbalist passive ‚Äî cure nearby infected each cycle
      if(this.profession==='herbalist'&&tick%20===0){
        const sick=world.entities.find(e=>e!==this&&e.infected&&mdist(e.x,e.y,this.x,this.y)<8);
        if(sick&&Math.random()<0.10){sick.infected=false;this.lifeEvents.push(`Year ${year}: Cured ${sick.name}.`);}
      }
      // Merchant passive ‚Äî generate resources when near another settlement
      if(this.profession==='merchant'&&this.settlement&&tick%90===0){
        const other=world.settlements.find(s=>s!==this.settlement&&mdist(s.x,s.y,this.x,this.y)<30);
        if(other){world.res.food+=5;world.res.wood+=3;this.lifeEvents.push(`Year ${year}: Traded with ${other.name}.`);}
      }

      // Disease
      if(this.infected){
        this.infectedTicks++;
        this.health-=0.04*diseaseSeverity; // reduced damage
        if(this.infectedTicks%30===0){
          const near=world.entities.find(e=>e!==this&&!e.infected&&mdist(e.x,e.y,this.x,this.y)<3);
          if(near&&Math.random()<0.25)near.infected=true;
        }
        const temples=world.buildings.filter(b=>b.type==='temple').length;
        if(Math.random()<0.004+temples*0.002){this.infected=false;this.infectedTicks=0;}
      }

      if(this.age>18000||this.hunger>150||this.health<=0){  // ~10 years lifespan
        this.health=0;
        if(this.settlement)this.settlement.remove(this);
        if(this.home)this.home.residents=this.home.residents.filter(r=>r!==this);
        if(selectedEntity===this){selectedEntity=null;_dom('charCard').style.display='none';}
        return;
      }

      // Age-based role promotion to elder (~year 4)
      if(this.age>7200&&this.age<7300&&this.profession!=='leader'&&this.profession!=='elder'){
        if(this.cha>75&&this.settlement&&Math.random()<0.3){
          this.profession='elder';
          this.lifeEvents.push(`Year ${year}: Became an Elder.`);
          notify(`üßô ${this.name} has become an Elder.`,'good');
        }
      }
      // Assign role once old enough (~6 months = 3600 ticks)
      if(this.profession==='none'&&this.settlement&&this.age>450){
        const chance=this.age<1800?0.008:0.003;
        if(Math.random()<chance)this.autoAssignRole();
      }

      if(this.x===this.lx&&this.y===this.ly){this.stk++;if(this.stk>18){this.explore(25);this.stk=0;}}else this.stk=0;
      this.lx=this.x;this.ly=this.y;

      // Eating ‚Äî from stockpile or nearby wild food
      if(this.hunger>40&&this.state!=='sleeping'){
        if(world.res.food>0){
          world.res.food--;this.hunger=Math.max(0,this.hunger-60);this.state='idle';this.tx=null;this.ty=null;
        }else{
          // Emergency: eat wild food directly nearby
          const k=this.x+','+this.y;
          const f=foodSet.get(k);
          if(f){world.food=world.food.filter(ff=>ff!==f);foodSet.delete(k);this.hunger=Math.max(0,this.hunger-60);minimapDirty=true;}
          else if(this.hunger>60){this.state='gfood';this.findFood();}
        }
      }

      // Sleep ‚Äî rest when near home (within 2 tiles), not exact tile
      if(this.tiredness>80&&this.home&&this.state!=='sleeping'){this.state='sleeping';this.tx=this.home.x;this.ty=this.home.y;}
      if((dayPhase===2||dayPhase===3)&&this.home&&this.state!=='sleeping'&&this.tiredness>25&&Math.random()<0.02){this.state='sleeping';this.tx=this.home.x;this.ty=this.home.y;}
      if(this.state==='sleeping'){
        const nearHome=this.home&&mdist(this.x,this.y,this.home.x,this.home.y)<=2;
        if(nearHome){
          this.tiredness=Math.max(0,this.tiredness-2);
          if(this.tiredness<15){this.state='idle';this.tx=null;this.ty=null;}
          return;
        }
        // Still walking home ‚Äî keep moving
      }

      if(!this.settlement&&this.age>360&&Math.random()<0.015)this.trySettle();
      if(this.settlement&&!this.home&&this.age>360)this.claimHome();
      if(this.workplace)this.workplace.workers=Math.min(3,(this.workplace.workers||0)+0.005);

      // ‚îÄ‚îÄ Breeding cooldown tick ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(this.breedCooldown>0)this.breedCooldown--;

      // ‚îÄ‚îÄ Partner bond: clear if partner died ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(this.partner&&this.partner.health<=0)this.partner=null;

      // ‚îÄ‚îÄ Courtship: adults seek a partner, bond, then breed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Age 80 = ~2 years (each tick = age++, 120 ticks/year)
      if(this.age>450&&this.age<4500&&this.hunger<65&&this.tiredness<70&&this.health>30){

        // Step 1: find a partner bond if we don't have one
        if(!this.partner&&this.breedCooldown===0&&Math.random()<0.003){
          const candidate=world.entities.find(e=>
            e!==this&&
            !e.partner&&
            e.age>450&&e.age<4500&&
            e.health>30&&e.hunger<70&&
            (e.settlement===this.settlement||(!e.settlement&&!this.settlement))&&
            mdist(e.x,e.y,this.x,this.y)<30
          );
          if(candidate){
            this.partner=candidate;
            candidate.partner=this;
            this.lifeEvents.push(`Year ${year}: Bonded with ${candidate.name}.`);
          }
        }

        // Step 2: if bonded and ready, enter courting state to walk to partner
        if(this.partner&&this.breedCooldown===0&&
           this.state==='idle'&&Math.random()<0.04){
          this.state='courting';
          this.tx=this.partner.x;
          this.ty=this.partner.y;
        }

        // Step 3: while courting, update target and check if close enough to breed
        if(this.state==='courting'&&this.partner){
          // Keep target fresh as partner moves
          this.tx=this.partner.x;this.ty=this.partner.y;
          if(mdist(this.x,this.y,this.partner.x,this.partner.y)<=2){
            // Close enough ‚Äî breed!
            // Prefer to spawn at a shared home, else near current position
            const home=this.home||this.partner.home;
            const bx=Math.max(0,Math.min(G-1,(home?home.x:this.x)+rnd(3)-1));
            const by=Math.max(0,Math.min(G-1,(home?home.y:this.y)+rnd(3)-1));
            if(TER[world.terrain[by]?.[bx]]?.walkable){
              const child=new Entity(bx,by);
              child.lifeEvents=[`Year ${year}: Born to ${this.name} & ${this.partner.name}.`];
              const parentTraits=[...this.traits,...(this.partner.traits||[])];
              if(parentTraits.length>0&&Math.random()<0.6)
                child.traits.push(parentTraits[rnd(parentTraits.length)]);
              world.entities.push(child);
              const sett=this.settlement||this.partner.settlement;
              if(sett)sett.add(child);
              this.lifeEvents.push(`Year ${year}: Had a child ‚Äî ${child.name}.`);
              this.partner.lifeEvents.push(`Year ${year}: Had a child ‚Äî ${child.name}.`);
              // Cooldown ~3‚Äì5 years (360‚Äì600 ticks)
              const cd=14400+rnd(7200); // ~2-3 years between children
              this.breedCooldown=cd;
              this.partner.breedCooldown=cd;
              notify(`üë∂ ${child.name} born in ${sett?sett.name:'the wild'}.`,'good');
            }
            this.state='idle';this.tx=null;this.ty=null;
          }
        }else if(this.state==='courting'&&!this.partner){
          // Partner gone, give up
          this.state='idle';this.tx=null;this.ty=null;
        }
      }

      // Path-laying
      if(this.settlement&&this.settlement.buildings.length>=2&&Math.random()<0.015){
        const nearB=world.buildings.find(b=>b.x===this.x&&b.y===this.y);
        if(nearB){if(this._lastBuildingX!==null)layPath(this._lastBuildingX,this._lastBuildingY,nearB.x,nearB.y);this._lastBuildingX=nearB.x;this._lastBuildingY=nearB.y;}
      }

      if(this.state==='hunting'){this.doHunting();if(this.tx!==null&&this.ty!==null){const spd=this.profession==='explorer'?6:12;this.moveTick=(this.moveTick+1)%spd;if(this.moveTick===0)this.move();}return;}
      if(this.state!=='sleeping'){
        switch(this.state){
          case'idle':       this.decide();break;
          case'courting':   break; // handled above ‚Äî just needs movement tick
          case'gwood':      this.doWood();break;
          case'gstone':     this.doStone();break;
          case'gfood':      this.doFood();break;
          case'building':   this.doBuild();break;
          case'working':    this.doWork();break;
          case'farming':    this.doFarming();break;
          case'patrolling': this.doPatrolling();break;
          case'healing':    this.doHealing();break;
          case'trading':    this.doTrading();break;
          case'exploring':  this.doExploring();break;
        }
      }
      if(this.tx!==null&&this.ty!==null){const spd=this.profession==='explorer'?6:12;this.moveTick=(this.moveTick+1)%spd;if(this.moveTick===0)this.move();}

      // Refresh card if selected
      if(selectedEntity===this&&tick%10===0)refreshCharCard();
    }catch(err){console.error('Entity error:',err);this.health=0;}
  }
  autoAssignRole(){
    const s=this.settlement;
    const members=s.members;
    // Count existing roles
    const counts={};
    members.forEach(m=>{counts[m.profession]=(counts[m.profession]||0)+1;});
    const pop=members.length;
    // Target ratios per village size ‚Äî what the village actually needs
    // Format: [role, targetCount, minPop]
    const targets=[
      ['farmer',     Math.max(1,Math.floor(pop*0.20)), 1],
      ['lumberjack', Math.max(1,Math.floor(pop*0.15)), 2],
      ['miner',      Math.max(1,Math.floor(pop*0.10)), 4],
      ['hunter',     Math.max(1,Math.floor(pop*0.12)), 3],
      ['gatherer',   Math.max(1,Math.floor(pop*0.10)), 2],
      ['builder',    Math.max(1,Math.floor(pop*0.12)), 3],
      ['explorer',   Math.max(1,Math.floor(pop*0.08)), 3],
      ['warrior',    Math.max(0,Math.floor(pop*0.08)), 6],
      ['herbalist',  Math.max(0,Math.floor(pop*0.05)), 8],
      ['scholar',    Math.max(0,Math.floor(pop*0.05)), 10],
      ['merchant',   Math.max(0,Math.floor(pop*0.04)), 15],
    ];
    // Find the role most under its target that we qualify for (min pop met)
    let bestRole=null,bestShortfall=-Infinity;
    for(const [role,target,minPop] of targets){
      if(pop<minPop)continue;
      const shortfall=target-(counts[role]||0);
      if(shortfall>bestShortfall){bestShortfall=shortfall;bestRole=role;}
    }
    // If all roles are met, pick randomly from common ones
    if(!bestRole||bestShortfall<=0){
      const fallback=['farmer','lumberjack','gatherer','miner','hunter'];
      bestRole=fallback[rnd(fallback.length)];
    }
    assignRole(this,bestRole);
    this.lifeEvents.push(`Year ${year}: Became a ${ROLES[bestRole].label}.`);
    notify(`${ROLES[bestRole].emoji} ${this.name} is now a ${ROLES[bestRole].label}`);
  }
  woodNeeded(){
    // How much wood the settlement actually needs right now
    const s=this.settlement;
    if(!s)return 8; // solo entity: small personal buffer
    const n=s.needs();
    const pending=Object.values(n).filter(v=>v).length;
    // 3 wood per building needed + 5 buffer per 10 population
    const popBuffer=Math.ceil(s.members.length/10)*5;
    return Math.max(5,Math.min(40, pending*3 + popBuffer));
  }
  decide(){
    // Never interrupt active courting
    if(this.state==='courting')return;
    // Survival first ‚Äî eat if hungry
    if(this.hunger>38){this.state='gfood';this.findFood();return;}
    if(world.res.food<20&&Math.random()<.35){this.state='gfood';this.findFood();return;}

    const r=Math.random();

    // ‚îÄ‚îÄ Housing drive ‚Äî anyone without a home strongly wants to build one ‚îÄ‚îÄ
    if(this.settlement&&!this.home){
      // Gather materials if short, otherwise build
      if(world.res.wood<3){this.state='gwood';this.findTree();return;}
      const n=this.settlement.needs();
      if(n.house&&world.res.wood>=3){this.state='building';this.findSpot();return;}
    }
    // Even housed settlers help build houses when population is outgrowing them
    if(this.settlement&&r<0.55){
      const n=this.settlement.needs();
      if(n.house&&world.res.wood>=3){this.state='building';this.findSpot();return;}
    }

    // ‚îÄ‚îÄ Role-driven primary work (80% of the time) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    switch(this.profession){

      case'explorer':
        if(r<0.85){this.state='exploring';this.exploreWide();return;}
        break;

      case'farmer':
        if(r<0.75){this.state='farming';this.findFarm();return;}
        break;

      case'lumberjack':
        // Only chop if stockpile is below what the settlement needs
        if(r<0.80&&world.res.wood<this.woodNeeded()){this.state='gwood';this.findTree();return;}
        break;

      case'miner':
        if(r<0.75){this.state='gstone';this.findStone();return;}
        break;

      case'hunter':
        if(r<0.78){this.state='hunting';this.findPrey();return;}
        break;

      case'gatherer':
        if(r<0.72){this.state='gfood';this.findFood();return;}
        break;

      case'builder':
        if(this.settlement&&r<0.85){
          const n=this.settlement.needs();
          if(Object.values(n).some(v=>v)&&world.res.wood>=3){this.state='building';this.findSpot();return;}
        }
        // builders gather wood only if below the settlement's actual need
        if(world.res.wood<this.woodNeeded()){this.state='gwood';this.findTree();return;}
        break;

      case'warrior':
        if(r<0.70){this.state='patrolling';this.patrolPoint();return;}
        break;

      case'scholar':
        if(this.workplace&&r<0.72){this.state='working';this.tx=this.workplace.x;this.ty=this.workplace.y;return;}
        break;

      case'herbalist':
        if(r<0.60){this.state='healing';this.tx=this.settlement?this.settlement.x+rnd(10)-5:this.x;this.ty=this.settlement?this.settlement.y+rnd(10)-5:this.y;return;}
        break;

      case'merchant':
        if(this.settlement&&r<0.50){this.state='trading';this.findTradeTarget();return;}
        break;
    }

    // ‚îÄ‚îÄ Village utility work (when role work is done or no role) ‚îÄ‚îÄ‚îÄ‚îÄ
    // Help gather wood/stone if critically low
    // Pitch in on wood only if genuinely short ‚Äî not just hoarding
    if(world.res.wood<this.woodNeeded()&&r<0.4){this.state='gwood';this.findTree();return;}
    if(world.res.stone<8&&r<0.4){this.state='gstone';this.findStone();return;}

    // Wanderers pitch in on any building need
    if(this.profession==='none'&&this.settlement&&r<0.6){
      const n=this.settlement.needs();
      if(Object.values(n).some(v=>v)&&world.res.wood>=3){this.state='building';this.findSpot();return;}
    }

    this.explore(30);
  }

  findFarm(){
    // Walk to the farm building
    const farm=world.buildings.find(b=>b.type==='farm'&&mdist(b.x,b.y,this.x,this.y)<80)||world.buildings.find(b=>b.type==='farm');
    if(farm){this.tx=farm.x+rnd(farm.w||1);this.ty=farm.y+rnd(farm.h||1);}
    else{this.explore(20);}
  }
  findPrey(){
    const prey=world.animals.find(a=>a.type==='deer'&&mdist(a.x,a.y,this.x,this.y)<40);
    if(prey){this.prey=prey;this.tx=prey.x;this.ty=prey.y;}
    else{this.explore(50);}
  }
  patrolPoint(){
    if(this.settlement){
      const angle=Math.random()*Math.PI*2;
      const r2=this.settlement.radius*0.6;
      this.tx=Math.max(0,Math.min(G-1,Math.floor(this.settlement.x+Math.cos(angle)*r2)));
      this.ty=Math.max(0,Math.min(G-1,Math.floor(this.settlement.y+Math.sin(angle)*r2)));
    }else this.explore(20);
  }
  findTradeTarget(){
    const other=world.settlements.find(s=>s!==this.settlement);
    if(other){this.tx=other.x;this.ty=other.y;}else this.explore(40);
  }
  findTree(){
    // Only target mature (stage>=2) trees ‚Äî leave saplings and young to grow
    const isCuttable=t=>t&&!t.onFire&&t.stage>=2;
    // Prefer explorer-known tree locations first
    const known=world.knownResources.filter(r=>r.type==='tree');
    if(known.length>0){
      let b=null,bd=Infinity;
      known.forEach(r=>{const t=treeMap.get(r.x+','+r.y);if(isCuttable(t)){const d=mdist(r.x,r.y,this.x,this.y);if(d<bd){bd=d;b=t;}}});
      if(b){this.tx=b.x;this.ty=b.y;return;}
    }
    // Scan all trees; prefer mature over ancient (leave ancients when possible)
    let best=null,bestScore=Infinity;
    world.trees.forEach(t=>{
      if(!isCuttable(t))return;
      const d=mdist(t.x,t.y,this.x,this.y);
      // Score: distance + penalty for ancient trees (prefer stage 2 over 3)
      const score=d+(t.stage===3?30:0);
      if(score<bestScore){bestScore=score;best=t;}
    });
    if(best){this.tx=best.x;this.ty=best.y;}else this.explore(60);
  }
  findStone(){
    const known=world.knownResources.filter(r=>r.type==='stone');
    if(known.length>0){
      let b=null,bd=Infinity;
      known.forEach(r=>{const s=world.stones.find(s=>s.x===r.x&&s.y===r.y&&s.amount>0);if(s){const d=mdist(r.x,r.y,this.x,this.y);if(d<bd){bd=d;b=s;}}});
      if(b){this.tx=b.x;this.ty=b.y;return;}
    }
    let b=null,bd=Infinity;world.stones.forEach(s=>{const d=mdist(s.x,s.y,this.x,this.y);if(d<bd&&s.amount>0){bd=d;b=s;}});if(b){this.tx=b.x;this.ty=b.y;}else this.explore(60);
  }
  findFood(){
    if(world.res.food>0){world.res.food--;this.hunger=0;this.state='idle';return;}
    // Check explorer-known food locations first
    const knownFood=world.knownResources.filter(r=>r.type==='food');
    if(knownFood.length>0){
      let b=null,bd=Infinity;
      knownFood.forEach(r=>{if(foodSet.has(r.x+','+r.y)){const d=mdist(r.x,r.y,this.x,this.y);if(d<bd){bd=d;b=r;}}});
      if(b){this.tx=b.x;this.ty=b.y;return;}
    }
    const range=this.profession==='gatherer'?30:15;
    let b=null,bd=Infinity;
    world.food.forEach(f=>{const d=mdist(f.x,f.y,this.x,this.y);if(d<bd&&d<range){bd=d;b=f;}});
    if(!b)world.food.forEach(f=>{const d=mdist(f.x,f.y,this.x,this.y);if(d<bd){bd=d;b=f;}});
    if(b){this.tx=b.x;this.ty=b.y;}else this.explore(70);
  }
  findSpot(){
    if(this.settlement){const s=this.settlement.spot();if(s){this.tx=s.x;this.ty=s.y;return;}}
    for(let a=0;a<10;a++){const bx=this.x+rnd(9)-4,by=this.y+rnd(9)-4;if(bx>=0&&bx<G&&by>=0&&by<G&&world.terrain[by][bx]==='GRASS'&&!world.buildings.find(b=>b.x===bx&&b.y===by)&&!treeMap.has(bx+','+by)){this.tx=bx;this.ty=by;return;}}
  }
  explore(r){const a=Math.random()*Math.PI*2,d=r*.4+Math.random()*r*.9;this.tx=Math.max(0,Math.min(G-1,Math.floor(this.x+Math.cos(a)*d)));this.ty=Math.max(0,Math.min(G-1,Math.floor(this.y+Math.sin(a)*d)));}
  exploreWide(){
    const a=Math.random()*Math.PI*2,d=40+Math.random()*80;
    this.tx=Math.max(0,Math.min(G-1,Math.floor(this.x+Math.cos(a)*d)));
    this.ty=Math.max(0,Math.min(G-1,Math.floor(this.y+Math.sin(a)*d)));
  }
  doExploring(){
    // Scan nearby tiles and register found resources into world.knownResources
    const scanR=6;
    for(let dy=-scanR;dy<=scanR;dy++){
      for(let dx=-scanR;dx<=scanR;dx++){
        const nx=this.x+dx,ny=this.y+dy;
        if(nx<0||nx>=G||ny<0||ny>=G)continue;
        const k=nx+','+ny;
        if(treeMap.has(k)&&!world.knownResources.find(r=>r.x===nx&&r.y===ny&&r.type==='tree'))
          world.knownResources.push({x:nx,y:ny,type:'tree'});
        const stone=world.stones.find(s=>s.x===nx&&s.y===ny&&s.amount>0);
        if(stone&&!world.knownResources.find(r=>r.x===nx&&r.y===ny&&r.type==='stone'))
          world.knownResources.push({x:nx,y:ny,type:'stone'});
        if(foodSet.has(k)&&!world.knownResources.find(r=>r.x===nx&&r.y===ny&&r.type==='food')){
          world.knownResources.push({x:nx,y:ny,type:'food'});
          if(Math.random()<0.04&&this.settlement)
            logEvent(`Year ${year} ‚Äî ${this.name} discovered food sources.`);
        }
      }
    }
    // Occasional scouting report
    if(Math.random()<0.002&&this.settlement){
      const known=world.knownResources.length;
      notify(`üß≠ ${this.name} reports ${known} known resource sites.`);
      logEvent(`Year ${year} ‚Äî Explorer ${this.name} charts the land. ${known} sites mapped.`);
    }
    // Prune stale known resources periodically
    if(Math.random()<0.01){
      world.knownResources=world.knownResources.filter(r=>{
        if(r.type==='tree')return treeMap.has(r.x+','+r.y);
        if(r.type==='stone')return!!world.stones.find(s=>s.x===r.x&&s.y===r.y&&s.amount>0);
        if(r.type==='food')return foodSet.has(r.x+','+r.y);
        return false;
      });
    }
    if(this.tx===null||mdist(this.x,this.y,this.tx,this.ty)<3){
      if(Math.random()<0.15)this.state='idle';
      else this.exploreWide();
    }
  }
  doWood(){
    const k=this.x+','+this.y;
    const t=treeMap.get(k);
    if(t&&!t.onFire){
      // Don't chop saplings or young trees ‚Äî leave them to grow
      if(t.stage<2){
        // Redirect to a mature tree instead; if none found, idle
        this.findTree();
        if(this.tx===this.x&&this.ty===this.y){this.state='idle';this.tx=null;this.ty=null;}
        return;
      }
      world.trees=world.trees.filter(tt=>tt!==t);treeMap.delete(k);
      // Ancient trees give bonus wood
      const ageMult=t.stage===3?1.5:1.0;
      const bonus=this.profession==='lumberjack'?2.0:1.0;
      const yield2=Math.floor((3+this.str/25)*bonus*ageMult);
      world.res.wood+=yield2;
      if(this.profession==='lumberjack'&&Math.random()<0.05)
        this.lifeEvents.push(`Year ${year}: Felled a tree (+${yield2} wood).`);
      this.state='idle';this.tx=null;this.ty=null;minimapDirty=true;
    }else if(this.tx===null||(this.tx===this.x&&this.ty===this.y))this.findTree();
  }
  doStone(){
    const s=world.stones.find(s=>s.x===this.x&&s.y===this.y);
    if(s&&s.amount>0){
      s.amount--;
      const bonus=this.profession==='miner'?2:1;
      world.res.stone+=Math.floor(bonus+this.str/50);
      if(s.amount<=0)world.stones=world.stones.filter(ss=>ss!==s);
      this.state='idle';this.tx=null;this.ty=null;
    }else if(this.tx===null||(this.tx===this.x&&this.ty===this.y))this.findStone();
  }
  doFood(){
    const k=this.x+','+this.y;
    const f=foodSet.get(k);
    if(f){
      world.food=world.food.filter(ff=>ff!==f);foodSet.delete(k);
      const bonus=(this.profession==='gatherer'||this.profession==='hunter')?3:1;
      world.res.food+=4*bonus;
      this.hunger=Math.max(0,this.hunger-50);
      this.state='idle';this.tx=null;this.ty=null;minimapDirty=true;
    }else if(this.tx===null||(this.tx===this.x&&this.ty===this.y))this.findFood();
  }
  doBuild(){
    if(this.tx===this.x&&this.ty===this.y){
      if(!this.settlement){this.state='idle';return;}
      const n=this.settlement.needs();let type=null;
      const order=['house','farm','workshop','mine','library','market','barracks','castle','temple'];
      for(const t of order){if(n[t]&&this.settlement.canBuild(t)){type=t;break;}}
      if(!type||world.res.wood<3){this.state='idle';return;}
      world.res.wood-=3;
      if(['mine','workshop','library','market','barracks','castle','temple'].includes(type)&&world.res.stone>=2)world.res.stone-=2;
      if(type==='castle'&&world.res.stone>=5)world.res.stone-=5;
      const newB=new Building(this.x,this.y,type);
      const fw=newB.w||1,fh=newB.h||1;
      // Final safety: reject if any existing building overlaps (including 1-tile gap)
      const GAP=1;
      if(world.buildings.find(b=>{const bw=b.w||1,bh=b.h||1;
        return newB.x<b.x+bw+GAP&&newB.x+fw>b.x-GAP&&newB.y<b.y+bh+GAP&&newB.y+fh>b.y-GAP;})){
        this.state='idle';this.tx=null;this.ty=null;return;
      }
      for(let ty2=newB.y;ty2<newB.y+fh;ty2++)for(let tx2=newB.x;tx2<newB.x+fw;tx2++){
        const k2=tx2+','+ty2;if(treeMap.has(k2)){treeMap.delete(k2);}
      }
      world.trees=world.trees.filter(t=>!(t.x>=newB.x&&t.x<newB.x+fw&&t.y>=newB.y&&t.y<newB.y+fh));
      world.stones=world.stones.filter(s=>!(s.x>=newB.x&&s.x<newB.x+fw&&s.y>=newB.y&&s.y<newB.y+fh));
      world.buildings.push(newB);
      if(world.buildings.length>1){
        let nearB=null,nearD=Infinity;
        world.buildings.forEach(b=>{if(b===newB)return;const d=mdist(b.x,b.y,newB.x,newB.y);if(d<nearD){nearD=d;nearB=b;}});
        if(nearB)layPath(newB.x,newB.y,nearB.x,nearB.y);
        if(this.settlement)layPath(newB.x,newB.y,this.settlement.x,this.settlement.y);
      }
      this.lifeEvents.push(`Year ${year}: Built a ${type}.`);
      if(world.buildings.length>world.tech*5)world.tech++;
      this.state='idle';this.tx=null;this.ty=null;minimapDirty=true;
    }
  }
  doFarming(){
    if(!world.crops)world.crops=[];
    const farm=world.buildings.find(b=>b.type==='farm'&&this.settlement&&b.settlement===this.settlement);
    if(!farm){this.findFarm();if(this.tx===null)this.state='idle';return;}
    // Check for ripe crop tiles to harvest
    const ripe=world.crops.find(cr=>cr.farmId===farm.id&&cr.stage>=cr.maxStage&&mdist(this.x,this.y,cr.x,cr.y)<8);
    if(ripe&&mdist(this.x,this.y,ripe.x,ripe.y)<=1){
      // Harvest it
      const yld=Math.floor(4+this.end/20)*(season===1?2:season===3?0:1);
      world.res.food+=yld;
      ripe.stage=0; // reset to empty plot
      this.lifeEvents.push(`Year ${year}: Harvested crops (+${yld} food).`);
      return;
    }
    if(ripe){this.tx=ripe.x;this.ty=ripe.y;return;}
    // Plant new crop tile on empty/reset plots
    const empty=world.crops.find(cr=>cr.farmId===farm.id&&cr.stage===0&&mdist(this.x,this.y,cr.x,cr.y)<8);
    if(empty&&mdist(this.x,this.y,empty.x,empty.y)<=1){
      empty.stage=1; // start growing
      if(Math.random()<0.05)this.state='idle';
      return;
    }
    if(empty){this.tx=empty.x;this.ty=empty.y;return;}
    // Expand farm if fewer than 16 crop tiles
    const myPlots=world.crops.filter(cr=>cr.farmId===farm.id);
    if(myPlots.length<16&&season!==3){
      // Find a nearby grass tile to add a plot
      const ox=farm.x+rnd(farm.w||4)-1,oy=farm.y+rnd(farm.h||3)-1;
      const key=ox+','+oy;
      if(ox>=0&&ox<G&&oy>=0&&oy<G&&world.terrain[oy][ox]==='GRASS'&&!treeMap.has(key)&&!world.crops.find(c=>c.x===ox&&c.y===oy)){
        const maxS=season===1?80:120; // faster growth in spring
        world.crops.push({x:ox,y:oy,stage:0,maxStage:maxS,farmId:farm.id});
        minimapDirty=true;
      }
    }
    if(Math.random()<0.03)this.state='idle';
  }
  doHunting(){
    // Update prey position ‚Äî prey moves
    if(this.prey&&this.prey.health>0){
      this.tx=this.prey.x;this.ty=this.prey.y;
      if(mdist(this.x,this.y,this.prey.x,this.prey.y)<=1){
        // Kill it
        const meat=Math.floor(8+this.str/12);
        world.res.food+=meat;
        this.prey.health=0;
        this.lifeEvents.push(`Year ${year}: Hunted a deer (+${meat} food).`);
        this.prey=null;this.state='idle';this.tx=null;this.ty=null;
      }
    }else{
      // Prey gone ‚Äî find new one
      this.prey=null;
      this.findPrey();
      if(this.tx===null)this.state='idle';
    }
  }
  doPatrolling(){
    // Engage wolves on patrol
    world.animals.forEach(a=>{
      if(a.type==='wolf'&&mdist(a.x,a.y,this.x,this.y)<6){
        a.health-=3+this.str/30;
        this.tx=a.x;this.ty=a.y;
      }
    });
    if(this.tx===null||mdist(this.x,this.y,this.tx,this.ty)<2){
      if(Math.random()<0.08)this.state='idle';
      else this.patrolPoint();
    }
  }
  doHealing(){
    // Heal nearby infected
    const sick=world.entities.find(e=>e!==this&&e.infected&&mdist(e.x,e.y,this.x,this.y)<8);
    if(sick){
      this.tx=sick.x;this.ty=sick.y;
      if(mdist(this.x,this.y,sick.x,sick.y)<=1){
        if(Math.random()<0.18){sick.infected=false;this.lifeEvents.push(`Year ${year}: Cured ${sick.name}.`);}
      }
    }else{
      if(Math.random()<0.06)this.state='idle';
    }
  }
  doTrading(){
    const other=world.settlements.find(s=>s!==this.settlement&&mdist(s.x,s.y,this.x,this.y)<4);
    if(other){
      world.res.food+=4;world.res.wood+=2;
      this.lifeEvents.push(`Year ${year}: Traded with ${other.name}.`);
      this.state='idle';this.tx=null;this.ty=null;
    }else if(this.tx===null||mdist(this.x,this.y,this.tx,this.ty)<2){
      this.findTradeTarget();
      if(this.tx===null)this.state='idle';
    }
  }
  doWork(){
    // Scholar at library
    if(!this.workplace){this.state='idle';return;}
    const d=mdist(this.workplace.x,this.workplace.y,this.x,this.y);
    if(d<2){
      if(this.profession==='scholar'&&Math.random()<0.06){world.res.knowledge++;if(Math.random()<0.02)world.tech=Math.min(10,world.tech+1);}
      if(Math.random()<0.04)this.state='idle';
    }else{this.tx=this.workplace.x;this.ty=this.workplace.y;}
  }
  move(){
    const dx=this.tx-this.x,dy=this.ty-this.y;if(dx===0&&dy===0){this.tx=null;this.ty=null;this.isMoving=false;return;}
    // Try diagonal movement first
    let mx=dx===0?0:dx>0?1:-1;
    let my=dy===0?0:dy>0?1:-1;
    // Update facing direction for rendering
    if(mx!==0)this.facing=mx;
    let nx=this.x+mx,ny=this.y+my;
    if(!this.ok(nx,ny)){
      // Fall back to axis-aligned
      if(Math.abs(dx)>=Math.abs(dy)){
        // Try horizontal
        if(this.ok(this.x+mx,this.y)){nx=this.x+mx;ny=this.y;}
        else if(this.ok(this.x,this.y+my)){nx=this.x;ny=this.y+my;}
        else if(this.ok(this.x,this.y+(my===0?(dy>0?1:-1):my))){nx=this.x;ny=this.y+(my===0?(dy>0?1:-1):-my);}
        else{this.explore(20);this.isMoving=false;return;}
      }else{
        // Try vertical
        if(this.ok(this.x,this.y+my)){nx=this.x;ny=this.y+my;}
        else if(this.ok(this.x+mx,this.y)){nx=this.x+mx;ny=this.y;}
        else if(this.ok(this.x+(mx===0?(dx>0?1:-1):mx),this.y)){nx=this.x+(mx===0?(dx>0?1:-1):-mx);ny=this.y;}
        else{this.explore(20);this.isMoving=false;return;}
      }
    }
    if(this.ok(nx,ny)){
      // Snap render pos to old tile before moving (so lerp animates the step)
      this.rx=this.x; this.ry=this.y;
      this.x=nx;this.y=ny;this.isMoving=true;
      // Animate walk cycle
      this.walkTick++;if(this.walkTick>=3){this.walkTick=0;this.walkFrame=(this.walkFrame+1)%4;}
    }else{this.isMoving=false;}
    if(Math.random()<0.006){
      const k=nx+','+ny;
      const existing=pathMap.get(k);
      if(existing)existing.worn=Math.min(existing.worn+1,20);
      else{const p={x:nx,y:ny,worn:1};world.paths.push(p);pathMap.set(k,p);}
    }
  }
  ok(x,y){return x>=0&&x<G&&y>=0&&y<G&&world.terrain[y]&&TER[world.terrain[y][x]]?.walkable;}
  trySettle(){
    const MIN_SETTLE_DIST=12;
    let nearest=null,nd=Infinity;
    world.settlements.forEach(s=>{const d=mdist(s.x,s.y,this.x,this.y);if(d<nd){nd=d;nearest=s;}});
    if(nearest&&nd<=nearest.radius+8){nearest.add(this);return;}
    if(nearest&&nd<MIN_SETTLE_DIST)return;
    const nearby=world.entities.filter(e=>e!==this&&!e.settlement&&mdist(e.x,e.y,this.x,this.y)<16);
    if(nearby.length>=1){
      const s=new Settlement(this.x,this.y,this);
      world.settlements.push(s);
      nearby.forEach(e=>{if(!e.settlement)s.add(e);});
      // Founder becomes a leader if high charisma
      if(this.cha>60){assignRole(this,'leader');this.lifeEvents.push(`Year ${year}: Founded ${s.name} and became its Leader.`);}
    }
  }
  claimHome(){const h=this.settlement.buildings.filter(b=>b.type==='house'&&b.residents.length<b.maxResidents);if(h.length>0){this.home=h[0];h[0].residents.push(this);}}
  draw(px,py,c){
    const role=ROLES[this.profession]||ROLES['none'];
    let bodyCol=role.color;
    const sleeping=this.state==='sleeping';
    if(sleeping)bodyCol='#3a4030';

    // Selection highlight
    if(this._selected){
      ctx.strokeStyle='#f0d860';ctx.lineWidth=2;
      ctx.strokeRect(px-2,py-2,c+4,c+4);
    }

    // Tiny-zoom fallback dot
    if(c<4){ctx.fillStyle=this.infected?'#904890':bodyCol;ctx.fillRect(px,py,Math.max(2,c),Math.max(2,c));return;}

    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.22)';
    ctx.fillRect(px+c*.15,py+c*.88,c*.75,c*.12);

    // Walk animation offsets
    const wf=this.walkFrame; // 0-3
    const walking=this.isMoving&&!sleeping;
    // Leg swing: frame 0=neutral, 1=left forward, 2=neutral, 3=right forward
    const legL_dy = walking?(wf===1?-c*.05:(wf===3?c*.05:0)):0;
    const legR_dy = walking?(wf===3?-c*.05:(wf===1?c*.05:0)):0;
    // Arm swing: opposite to legs
    const armL_dy = walking?(wf===3?-c*.06:(wf===1?c*.06:0)):0;
    const armR_dy = walking?(wf===1?-c*.06:(wf===3?c*.06:0)):0;
    // Body bob
    const bodyBob = walking&&(wf===1||wf===3)?c*.015:0;

    const skinCol = this.infected?'#d4b0d8':'#f5d9a8';
    const darkSkinVariant = (this.name.charCodeAt(0)%3===0)?'#d4a870':skinCol;
    const finalSkin = darkSkinVariant;

    // Working pose offsets
    const working=this.state==='gwood'||this.state==='gstone'||this.state==='farming';
    const bodyTopY = sleeping?py+c*.55:(working?py+c*.38:py+c*.32)+bodyBob;

    // ‚îÄ‚îÄ‚îÄ LEGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!sleeping){
      // Pants/trousers
      const pantsCol=this.age>600?'#5a5a70':'#3a2e5a';
      // Left leg
      ctx.fillStyle=pantsCol;
      ctx.fillRect(px+c*.28,bodyTopY+c*.44+legL_dy,c*.17,c*.3);
      // Right leg
      ctx.fillRect(px+c*.54,bodyTopY+c*.44+legR_dy,c*.17,c*.3);
      // Boots
      const bootCol='#2a1808';
      ctx.fillStyle=bootCol;
      ctx.fillRect(px+c*.26,bodyTopY+c*.72+legL_dy,c*.20,c*.1);
      ctx.fillRect(px+c*.52,bodyTopY+c*.72+legR_dy,c*.20,c*.1);
    }else{
      // Sleeping ‚Äî horizontal body
      ctx.fillStyle='#3a4030';
      ctx.fillRect(px+c*.1,py+c*.5,c*.8,c*.28);
      // ZZZ indicator (small dots, no emoji)
      ctx.fillStyle='rgba(180,210,255,0.7)';
      ctx.fillRect(px+c*.7,py+c*.2,c*.06,c*.06);
      ctx.fillRect(px+c*.78,py+c*.12,c*.05,c*.05);
      ctx.fillRect(px+c*.85,py+c*.05,c*.04,c*.04);
    }

    // ‚îÄ‚îÄ‚îÄ ARMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!sleeping){
      const armCol=bodyCol;
      const workingRaise=working?-c*.12:0;
      // Left arm
      ctx.fillStyle=armCol;
      ctx.fillRect(px+c*.12,bodyTopY+c*.04+armL_dy+workingRaise,c*.14,c*.34);
      // Right arm
      ctx.fillRect(px+c*.74,bodyTopY+c*.04+armR_dy+(working&&this.facing>0?workingRaise:0),c*.14,c*.34);
      // Hands
      ctx.fillStyle=finalSkin;
      ctx.fillRect(px+c*.12,bodyTopY+c*.36+armL_dy+workingRaise,c*.14,c*.1);
      ctx.fillRect(px+c*.74,bodyTopY+c*.36+armR_dy+(working&&this.facing>0?workingRaise:0),c*.14,c*.1);
    }

    // ‚îÄ‚îÄ‚îÄ BODY/TORSO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!sleeping){
      // Tunic / shirt
      ctx.fillStyle=bodyCol;
      ctx.fillRect(px+c*.26,bodyTopY,c*.48,c*.48);
      // Darker sides for 3D feel
      ctx.fillStyle='rgba(0,0,0,0.15)';
      ctx.fillRect(px+c*.26,bodyTopY,c*.07,c*.48);
      ctx.fillRect(px+c*.67,bodyTopY,c*.07,c*.48);
      // Belt
      ctx.fillStyle='#2a1808';
      ctx.fillRect(px+c*.26,bodyTopY+c*.38,c*.48,c*.06);
      // Belt buckle
      ctx.fillStyle='#c8a040';
      ctx.fillRect(px+c*.46,bodyTopY+c*.37,c*.08,c*.08);
    }

    // ‚îÄ‚îÄ‚îÄ HEAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!sleeping){
      const headY=bodyTopY-c*.25;
      // Neck
      ctx.fillStyle=finalSkin;
      ctx.fillRect(px+c*.43,headY+c*.18,c*.14,c*.1);
      // Head base
      ctx.fillStyle=finalSkin;
      ctx.fillRect(px+c*.30,headY,c*.40,c*.26);
      // Eyes
      const eyeWhite='#fff';const eyePupil='#1a0808';
      // facing right: eyes slightly right
      const eyeOff=this.facing>0?c*.02:-c*.02;
      ctx.fillStyle=eyeWhite;
      ctx.fillRect(px+c*.34+eyeOff,headY+c*.08,c*.10,c*.07);
      ctx.fillRect(px+c*.54+eyeOff,headY+c*.08,c*.10,c*.07);
      ctx.fillStyle=eyePupil;
      ctx.fillRect(px+c*.37+eyeOff,headY+c*.10,c*.05,c*.05);
      ctx.fillRect(px+c*.57+eyeOff,headY+c*.10,c*.05,c*.05);
      // Mouth ‚Äî slight smile or neutral
      ctx.fillStyle='rgba(0,0,0,0.4)';
      ctx.fillRect(px+c*.40,headY+c*.18,c*.20,c*.025);

      // Hair
      const hairCol=this.age>600?'#c8c8c8':
                    (this.name.charCodeAt(1)%4===0?'#1a0808':
                     this.name.charCodeAt(1)%4===1?'#5a3010':
                     this.name.charCodeAt(1)%4===2?'#c89040':'#2a1808');
      ctx.fillStyle=hairCol;
      ctx.fillRect(px+c*.30,headY,c*.40,c*.08); // top hair
      ctx.fillRect(px+c*.30,headY,c*.06,c*.20); // sideburn L
      ctx.fillRect(px+c*.64,headY,c*.06,c*.20); // sideburn R

      // Age beard/wrinkle detail
      if(this.age>400){
        ctx.fillStyle='rgba(200,200,200,0.5)';
        ctx.fillRect(px+c*.35,headY+c*.20,c*.30,c*.06);
      }

      // Role-specific hat/accessory (no emoji)
      if(c>=8){
        if(this.profession==='warrior'){
          // Helmet
          ctx.fillStyle='#888898';
          ctx.fillRect(px+c*.28,headY-c*.08,c*.44,c*.12);
          ctx.fillRect(px+c*.30,headY-c*.04,c*.40,c*.06);
          // Nasal guard
          ctx.fillStyle='#707080';
          ctx.fillRect(px+c*.47,headY,c*.06,c*.14);
        }else if(this.profession==='scholar'){
          // Pointed hat
          ctx.fillStyle='#2840a0';
          ctx.fillRect(px+c*.32,headY-c*.14,c*.36,c*.16);
          ctx.fillRect(px+c*.38,headY-c*.26,c*.24,c*.14);
          ctx.fillRect(px+c*.43,headY-c*.36,c*.14,c*.12);
        }else if(this.profession==='elder'){
          // Wide-brim hat
          ctx.fillStyle='#604820';
          ctx.fillRect(px+c*.20,headY-c*.04,c*.60,c*.06);
          ctx.fillRect(px+c*.30,headY-c*.14,c*.40,c*.12);
        }else if(this.profession==='leader'){
          // Crown-like band
          ctx.fillStyle='#c8a030';
          ctx.fillRect(px+c*.28,headY-c*.06,c*.44,c*.08);
          ctx.fillStyle='#e8c040';
          ctx.fillRect(px+c*.35,headY-c*.10,c*.06,c*.06);
          ctx.fillRect(px+c*.47,headY-c*.12,c*.06,c*.07);
          ctx.fillRect(px+c*.59,headY-c*.10,c*.06,c*.06);
        }else if(this.profession==='hunter'){
          // Leather hood/cap
          ctx.fillStyle='#7a4820';
          ctx.fillRect(px+c*.29,headY-c*.04,c*.42,c*.09);
          ctx.fillRect(px+c*.30,headY,c*.06,c*.12);
        }else if(this.profession==='miner'){
          // Hard hat
          ctx.fillStyle='#c8a020';
          ctx.fillRect(px+c*.27,headY-c*.06,c*.46,c*.1);
          ctx.fillRect(px+c*.29,headY-c*.02,c*.42,c*.07);
        }else if(this.profession==='herbalist'){
          // Flower/leafy crown
          ctx.fillStyle='#2a8a30';
          ctx.fillRect(px+c*.30,headY-c*.04,c*.40,c*.05);
          ctx.fillStyle='#f05060';
          ctx.fillRect(px+c*.33,headY-c*.07,c*.06,c*.05);
          ctx.fillRect(px+c*.61,headY-c*.07,c*.06,c*.05);
        }else if(this.profession==='explorer'){
          // Wide adventurer's hat with brim
          ctx.fillStyle='#6a4010';
          ctx.fillRect(px+c*.18,headY-c*.02,c*.64,c*.06); // brim
          ctx.fillRect(px+c*.30,headY-c*.14,c*.40,c*.14); // crown
          // Hat band
          ctx.fillStyle='#c89040';
          ctx.fillRect(px+c*.30,headY-c*.05,c*.40,c*.04);
        }
      }
    }

    // ‚îÄ‚îÄ‚îÄ TOOL (held in hand, not emoji) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(c>=8&&!sleeping){
      const toolX=this.facing>0?px+c*.82:px-c*.04;
      const toolY=bodyTopY+c*.1;
      if(this.state==='gwood'){
        // Axe
        ctx.fillStyle='#5a3010';ctx.fillRect(toolX,toolY,c*.06,c*.38);
        ctx.fillStyle='#b0b0b8';ctx.fillRect(toolX-c*.02,toolY,c*.10,c*.14);
      }else if(this.state==='gstone'){
        // Pickaxe
        ctx.fillStyle='#5a3010';ctx.fillRect(toolX,toolY,c*.06,c*.36);
        ctx.fillStyle='#909098';ctx.fillRect(toolX-c*.04,toolY-c*.02,c*.14,c*.07);
      }else if(this.state==='farming'){
        // Hoe
        ctx.fillStyle='#7a4818';ctx.fillRect(toolX,toolY-c*.05,c*.05,c*.42);
        ctx.fillStyle='#808888';ctx.fillRect(toolX-c*.06,toolY-c*.04,c*.14,c*.04);
      }else if(this.state==='hunting'){
        // Bow/spear
        ctx.fillStyle='#7a4820';ctx.fillRect(toolX,toolY-c*.05,c*.05,c*.44);
        ctx.fillStyle='#c0c0a0';ctx.fillRect(toolX,toolY-c*.1,c*.05,c*.08);
      }else if(this.state==='patrolling'){
        // Sword
        ctx.fillStyle='#a0a8b0';ctx.fillRect(toolX+c*.01,toolY-c*.08,c*.04,c*.44);
        ctx.fillStyle='#7a4010';ctx.fillRect(toolX-c*.04,toolY+c*.06,c*.12,c*.04);
      }else if(this.state==='building'){
        // Hammer
        ctx.fillStyle='#5a3010';ctx.fillRect(toolX,toolY,c*.05,c*.36);
        ctx.fillStyle='#707080';ctx.fillRect(toolX-c*.03,toolY,c*.11,c*.12);
      }
    }

    // ‚îÄ‚îÄ‚îÄ STATUS INDICATORS (visual, no emoji) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Hunger ring ‚Äî red border
    if(this.hunger>65){
      ctx.strokeStyle='rgba(220,60,40,0.85)';ctx.lineWidth=1.2;
      ctx.strokeRect(px,py,c,c);
    }
    // Disease tint
    if(this.infected){
      ctx.fillStyle='rgba(150,50,170,0.30)';ctx.fillRect(px,py,c,c);
      // Small disease dot indicator at top-right
      if(c>=6){ctx.fillStyle='#c060c8';ctx.fillRect(px+c*.8,py+c*.04,c*.12,c*.12);}
    }
    // Health indicator ‚Äî small bar below if damaged
    if(this.health<80&&c>=6){
      const barW=c*.8,barX=px+c*.1,barY=py+c*1.02;
      ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(barX,barY,barW,c*.08);
      const hpCol=this.health>50?'#4a9030':this.health>25?'#a08020':'#882020';
      ctx.fillStyle=hpCol;ctx.fillRect(barX,barY,barW*(this.health/100),c*.08);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTLEMENT, BUILDING, TREE, ANIMAL (same as before, condensed)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Tree{
  constructor(x,y,initAge){
    this.x=x;this.y=y;
    this.age=initAge!==undefined?initAge:0;
    this.type=Math.random()<.5?'pine':'oak';
    this.onFire=false;this.fireLife=0;
    treeMap.set(x+','+y,this);minimapDirty=true;
  }

  // Growth stages based on age (ticks):
  //   sapling  0‚Äì199   : tiny sprout, 1 small blob
  //   young    200‚Äì799  : small tree, 2 blobs
  //   mature   800‚Äì2999 : full 3-blob canopy
  //   ancient  3000+   : full canopy + slightly larger
  get stage(){
    if(this.age<200)return 0;   // sapling
    if(this.age<800)return 1;   // young
    if(this.age<3000)return 2;  // mature
    return 3;                   // ancient
  }

  update(){
    this.age++;

    // ‚îÄ‚îÄ Fire spread & burn ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(this.onFire){
      this.fireLife++;
      if(this.fireLife%8===0){
        for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
          if(!dx&&!dy)continue;
          const nt=treeMap.get((this.x+dx)+','+(this.y+dy));
          if(nt&&!nt.onFire&&Math.random()<0.18){nt.onFire=true;nt.fireLife=0;minimapDirty=true;}
        }
      }
      if(this.fireLife>45){treeMap.delete(this.x+','+this.y);minimapDirty=true;return true;}
      return false;
    }

    // ‚îÄ‚îÄ Forest spread ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Only mature+ trees seed; saplings and young trees just grow
    if(this.stage<1)return false;

    // Season multiplier: spring = fast growth, winter = dormant
    const seasonMult=season===1?3.0:season===3?0.05:season===2?0.6:1.0;

    // Base spread probability per tick ‚Äî mature trees spread more vigorously
    const baseP=this.stage>=3?0.006:this.stage>=2?0.004:0.0015;
    if(Math.random()>baseP*seasonMult)return false;

    // Forest density check: count trees within r=3; dense forest suppresses spread
    let neighbours=0;
    for(let dy=-3;dy<=3;dy++)for(let dx=-3;dx<=3;dx++){
      if(treeMap.has((this.x+dx)+','+(this.y+dy)))neighbours++;
    }
    // Hard cap at 30 neighbours (7√ó7 = 49 max) ‚Äî prevents total tile saturation
    if(neighbours>30)return false;

    // Prefer spreading to adjacent tiles first (1‚Äì2), occasionally wider (up to 4)
    // Weighted: 70% chance short range (1-2), 30% chance medium (3-4)
    const maxR=Math.random()<0.7?2:4;
    // Try a few candidate tiles; pick the first valid one
    for(let attempt=0;attempt<4;attempt++){
      const angle=Math.random()*Math.PI*2;
      const dist=1+Math.random()*maxR;
      const nx=Math.round(this.x+Math.cos(angle)*dist);
      const ny=Math.round(this.y+Math.sin(angle)*dist);
      const k=nx+','+ny;
      if(nx<0||nx>=G||ny<0||ny>=G)continue;
      if(world.terrain[ny][nx]!=='GRASS')continue;
      if(treeMap.has(k))continue;
      if(world.buildings.find(b=>b.x===nx&&b.y===ny))continue;
      // Extra penalty: don't spread into tiles right next to buildings
      const nearBuilding=world.buildings.some(b=>Math.abs(b.x-nx)<=1&&Math.abs(b.y-ny)<=1);
      if(nearBuilding&&Math.random()<0.85)continue;
      world.trees.push(new Tree(nx,ny));minimapDirty=true;
      break;
    }
    return false;
  }
}
class Settlement{
  constructor(x,y,founder){this.x=x;this.y=y;this.name=genSettName();this.members=[founder];founder.settlement=this;this.level=1;this.radius=14;this.buildings=[];this.tradeRoutes=[];this.faith=0;logEvent(`Year ${year} ‚Äî ${this.name} founded.`);notify(`‚õ∫ ${this.name} founded`,'good');}
  add(e){if(!this.members.includes(e)){this.members.push(e);e.settlement=this;}}
  remove(e){this.members=this.members.filter(m=>m!==e);}
  update(){
    this.members=this.members.filter(m=>m.health>0);
    this.buildings=world.buildings.filter(b=>mdist(b.x,b.y,this.x,this.y)<=this.radius*1.5);
    this.faith=Math.min(100,this.faith+this.buildings.filter(b=>b.type==='temple').length*0.05);
    const p=this.members.length,nb=this.buildings.length,old=this.level;
    if     (p>=120&&nb>=60)this.level=7;else if(p>=70&&nb>=38)this.level=6;
    else if(p>=40&&nb>=22)this.level=5;else if(p>=20&&nb>=14)this.level=4;
    else if(p>=10&&nb>=8)this.level=3;else if(p>=5&&nb>=4)this.level=2;else this.level=1;
    const radii=[6,9,12,16,22,30,40];
    if(this.level!==old){
      this.radius=radii[this.level-1];
      const ln=['Hamlet','Village','Town','City','Large City','Metropolis','Capital'];
      notify(`üèô ${this.name} ‚Üí ${ln[this.level-1]}!`,'good');
      logEvent(`Year ${year} ‚Äî ${this.name} becomes a ${ln[this.level-1]}.`);
      if(this.level>=4){const angle=Math.random()*Math.PI*2,dist=this.radius*0.55;this.subDistricts=this.subDistricts||[];this.subDistricts.push({x:Math.floor(this.x+Math.cos(angle)*dist),y:Math.floor(this.y+Math.sin(angle)*dist)});}
    }else if(!this.radius)this.radius=radii[this.level-1];
    if(tick%90===0&&world.settlements.length>1){world.settlements.forEach(other=>{if(other===this||mdist(other.x,other.y,this.x,this.y)>80)return;if(!this.tradeRoutes.includes(other)){this.tradeRoutes.push(other);layPath(this.x,this.y,other.x,other.y);world.res.food+=5;world.res.wood+=3;}});}
    if(this.buildings.length>=2&&tick%30===0){for(let i=0;i<this.buildings.length;i++){let best=null,bd=Infinity;for(let j=0;j<this.buildings.length;j++){if(i===j)continue;const d=mdist(this.buildings[i].x,this.buildings[i].y,this.buildings[j].x,this.buildings[j].y);if(d<bd){bd=d;best=this.buildings[j];}}if(best&&bd<this.radius*2)layPath(this.buildings[i].x,this.buildings[i].y,best.x,best.y);}this.buildings.forEach(b=>{if(Math.random()<0.4)layPath(b.x,b.y,this.x,this.y);});}
    return this.members.length===0;
  }
  needs(){
    const h=this.buildings.filter(b=>b.type==='house').length,fa=this.buildings.filter(b=>b.type==='farm').length,wo=this.buildings.filter(b=>b.type==='workshop').length,mi=this.buildings.filter(b=>b.type==='mine').length,li=this.buildings.filter(b=>b.type==='library').length,ma=this.buildings.filter(b=>b.type==='market').length,ba=this.buildings.filter(b=>b.type==='barracks').length,ca=this.buildings.filter(b=>b.type==='castle').length,te=this.buildings.filter(b=>b.type==='temple').length,p=this.members.length;
    return{house:p>h*2,farm:p>fa*3,workshop:this.level>=2&&wo<Math.floor(this.level/2),mine:this.level>=2&&mi<Math.floor(this.level/2),library:this.level>=3&&li<Math.ceil(this.level/3),market:this.level>=4&&ma<Math.floor(this.level/2),barracks:this.level>=5&&ba<Math.ceil(this.level/3),castle:this.level>=6&&ca<1,temple:this.level>=4&&te<Math.floor(this.level/3)};
  }
  canBuild(t){return this.level>=({house:1,farm:1,workshop:2,mine:2,library:3,market:4,barracks:5,castle:6,temple:4}[t]||1);}
  spot(){
    const anchors=[{x:this.x,y:this.y}];if(this.subDistricts)this.subDistricts.forEach(d=>anchors.push(d));
    const anchor=anchors[rnd(anchors.length)];
    const GAP=2; // minimum tiles between buildings
    for(let a=0;a<120;a++){
      const angle=Math.random()*Math.PI*2,d=3+Math.random()*(this.radius*0.9-3);
      const bx=Math.floor(anchor.x+Math.cos(angle)*d),by=Math.floor(anchor.y+Math.sin(angle)*d);
      if(bx<0||bx>=G-4||by<0||by>=G-4)continue;
      // Check all tiles in a 4√ó4 footprint are walkable grass
      let ok=true;
      for(let dy=0;dy<4&&ok;dy++)for(let dx=0;dx<4&&ok;dx++){
        const tx=bx+dx,ty=by+dy;
        if(tx>=G||ty>=G||world.terrain[ty][tx]!=='GRASS')ok=false;
      }
      if(!ok)continue;
      // Check no existing building overlaps including GAP tiles around it
      const clash=world.buildings.find(b=>{
        const bw=b.w||1,bh=b.h||1;
        return bx<b.x+bw+GAP&&bx+4>b.x-GAP&&by<b.y+bh+GAP&&by+4>b.y-GAP;
      });
      if(clash)continue;
      // Check no trees in footprint
      if(world.trees.find(t=>t.x>=bx-1&&t.x<bx+4&&t.y>=by-1&&t.y<by+4))continue;
      return{x:bx,y:by};
    }
    return null;
  }
}
// Building footprints in tiles [w, h]
const BSIZE={house:[2,2],farm:[2,2],workshop:[2,2],mine:[2,2],library:[2,3],market:[3,2],barracks:[3,2],castle:[4,4],temple:[3,4]};
class Building{
  constructor(x,y,type){
    this.x=x;this.y=y;this.type=type;this.level=1;this.health=100;this.age=0;this.id=Math.random().toString(36).slice(2);
    this.residents=[];this.maxResidents=4;this.workers=0;
    const sz=BSIZE[type]||[1,1];this.w=sz[0];this.h=sz[1];
  }
  update(){
    this.age++;const eff=Math.max(0.25,Math.min(this.workers/2,1));
    const farmMod=season===1?1.5:season===3?0.2:1.0;
    if(this.type==='farm'&&Math.random()<.14*eff*farmMod)world.res.food+=3*this.level;
    if(this.type==='mine'&&Math.random()<.06*eff)world.res.stone+=2*this.level;
    if(this.type==='library'&&Math.random()<.04*eff){world.res.knowledge++;if(world.res.knowledge>world.tech*20){world.tech++;world.res.knowledge=0;notify(`‚öó Tech Lv ${world.tech}!`,'good');logEvent(`Year ${year} ‚Äî Tech reaches level ${world.tech}.`);}}
    if(this.type==='market'&&Math.random()<.08*eff){world.res.food+=2*this.level;world.res.wood+=1;}
    if(this.type==='barracks'&&Math.random()<.05*eff)world.res.stone+=1*this.level;
    if(this.type==='castle'&&Math.random()<.03*eff){world.tech++;world.res.knowledge+=2;}
    if(this.type==='temple'&&Math.random()<.05*eff){world.res.faith=(world.res.faith||0)+1;worldMorale=Math.min(100,worldMorale+0.05);}
    if(this.age>600*this.level&&this.level<3&&Math.random()<.001&&world.res.wood>5&&world.res.stone>5){world.res.wood-=5;world.res.stone-=5;this.level++;}
  }
}
class Animal{
  constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.health=100;this.age=0;this.hunger=0;this.tx=null;this.ty=null;this.stk=0;this.lx=x;this.ly=y;this.moveTick=rnd(4);}
  update(){
    this.age++;this.hunger+=0.008;
    if(this.age>3200||this.hunger>100||this.health<=0){this.health=0;return;}
    if(this.x===this.lx&&this.y===this.ly){this.stk++;if(this.stk>15){this.explore(30);this.stk=0;}}else this.stk=0;
    this.lx=this.x;this.ly=this.y;
    if(this.type==='deer'){
      const nearH=world.entities.find(e=>(e.profession==='hunter'||true)&&mdist(e.x,e.y,this.x,this.y)<8);
      const nearW=world.animals.find(a=>a.type==='wolf'&&mdist(a.x,a.y,this.x,this.y)<10);
      if(nearH||nearW){const t2=nearH||nearW;const dx=this.x-t2.x,dy=this.y-t2.y;const len=Math.sqrt(dx*dx+dy*dy)||1;this.tx=Math.max(0,Math.min(G-1,Math.floor(this.x+dx/len*20)));this.ty=Math.max(0,Math.min(G-1,Math.floor(this.y+dy/len*20)));}
      else{if(this.hunger>30){const f=foodSet.get(this.x+','+this.y)||world.food.find(f=>mdist(f.x,f.y,this.x,this.y)<15);if(f){this.tx=f.x;this.ty=f.y;}else this.explore(20);}else if(!this.tx)this.explore(20);}
      const f2=foodSet.get(this.x+','+this.y);if(f2){world.food=world.food.filter(ff=>ff!==f2);foodSet.delete(this.x+','+this.y);this.hunger=Math.max(0,this.hunger-40);}
      if(this.age>80&&this.hunger<50&&Math.random()<0.002&&world.animals.filter(a=>a.type==='deer').length<80){const p=world.animals.find(a=>a.type==='deer'&&a!==this&&mdist(a.x,a.y,this.x,this.y)<5);if(p)world.animals.push(new Animal(this.x+rnd(5)-2,this.y+rnd(5)-2,'deer'));}
    }else{
      const prey=world.animals.find(a=>a.type==='deer'&&mdist(a.x,a.y,this.x,this.y)<25);
      if(prey){this.tx=prey.x;this.ty=prey.y;if(mdist(prey.x,prey.y,this.x,this.y)<2){prey.health=0;this.hunger=0;world.res.food+=3;}}
      else{const hu=world.entities.find(e=>e.profession!=='warrior'&&mdist(e.x,e.y,this.x,this.y)<12);if(hu&&Math.random()<0.01)hu.health-=20;else this.explore(25);}
      if(this.age>120&&this.hunger<40&&Math.random()<0.001&&world.animals.filter(a=>a.type==='wolf').length<25){const pw=world.animals.find(a=>a.type==='wolf'&&a!==this&&mdist(a.x,a.y,this.x,this.y)<5);if(pw)world.animals.push(new Animal(this.x+rnd(5)-2,this.y+rnd(5)-2,'wolf'));}
    }
    this.moveTick=(this.moveTick+1)%4;if(this.moveTick===0)this.move();
  }
  explore(r){const a=Math.random()*Math.PI*2,d=r*.4+Math.random()*r*.9;this.tx=Math.max(0,Math.min(G-1,Math.floor(this.x+Math.cos(a)*d)));this.ty=Math.max(0,Math.min(G-1,Math.floor(this.y+Math.sin(a)*d)));}
  move(){if(this.tx===null)return;const dx=this.tx-this.x,dy=this.ty-this.y;if(dx===0&&dy===0){this.tx=null;this.ty=null;return;}let mx=0,my=0;if(Math.abs(dx)>=Math.abs(dy))mx=dx>0?1:-1;else my=dy>0?1:-1;let nx=this.x+mx,ny=this.y+my;if(this.ok(nx,ny)){this.x=nx;this.y=ny;}else this.explore(15);}
  ok(x,y){return x>=0&&x<G&&y>=0&&y<G&&world.terrain[y]&&TER[world.terrain[y][x]]?.walkable;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEEDED RNG (mulberry32)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _seed=0;
function seedRng(s){
  // Hash string seed to number
  let h=0;for(let i=0;i<s.length;i++){h=Math.imul(31,h)+s.charCodeAt(i)|0;}
  _seed=(h>>>0)||12345678;
}
function srnd(){
  _seed+=0x6D2B79F5;let t=_seed;
  t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);
  return((t^t>>>14)>>>0)/4294967296;
}
function srndInt(n){return Math.floor(srnd()*n);}
// Simplex-like noise using seeded RNG (for island shape)
function noise2d(x,y,scale){
  const xi=Math.floor(x/scale),yi=Math.floor(y/scale);
  const xf=x/scale-xi,yf=y/scale-yi;
  // hash corners
  function h(a,b){let v=(a*1619+b*31337+_seed*6971)>>>0;v^=v>>>16;v=Math.imul(v,0x45d9f3b);v^=v>>>16;return(v>>>0)/4294967296;}
  const v00=h(xi,yi),v10=h(xi+1,yi),v01=h(xi,yi+1),v11=h(xi+1,yi+1);
  const fx=xf*xf*(3-2*xf),fy=yf*yf*(3-2*yf);
  return v00*(1-fx)*(1-fy)+v10*fx*(1-fy)+v01*(1-fx)*fy+v11*fx*fy;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genWorld(name,seed,sizeKey){
  worldName=name||'Unnamed Isle';
  worldSeed=seed||(Math.floor(Math.random()*99999).toString());
  seedRng(worldSeed+'_'+sizeKey);
  // Override rnd/Math.random temporarily with seeded version for gen
  const _origRand=Math.random;
  Math.random=srnd;

  freshWorld();
  const sz={small:0.55,medium:0.75,large:0.90}[sizeKey||'medium']||0.75;
  genIsland(sz);
  genOceanDepth(); // BFS distance from shore ‚Üí world.depth
  genMountains();
  genRivers();
  genSmallForests(); // sparse seedings ‚Äî they grow over time
  genStones();genBeaches();genMarshes();genFoodSources();
  for(let i=0;i<8;i++){
    let ax=rnd(G),ay=rnd(G);
    if(TER[world.terrain[ay][ax]]?.walkable)
      world.animals.push(new Animal(ax,ay,Math.random()<0.7?'deer':'wolf'));
  }
  logEvent(`Year 0 ‚Äî ${worldName} emerges from the sea.`);

  // Update world name badge
  const wb=_dom('sBadgeWorld'),ws=_dom('sBadgeWorldSep');
  if(wb){wb.textContent=worldName;wb.style.display='';}
  if(ws)ws.style.display='';

  // ‚îÄ‚îÄ Noise-based tv[] variant re-seeding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Replaces the random per-tile seeding with noise so nearby tiles share
  // similar colour variants ‚Üí organic blobs instead of salt-and-pepper noise
  for(let y=0;y<G;y++){
    for(let x=0;x<G;x++){
      const tname=world.terrain[y][x];
      const t=TER[tname];if(!t)continue;
      const nv=t.v.length;
      if(tname==='GRASS'){
        // Elevation-based gradient: high = dark (#618135 = index 1), low = light (#86b84b = index 0)
        // Add small noise for organic edge blending
        const elev=(world.elev[y]&&world.elev[y][x]!=null)?world.elev[y][x]:0.5;
        const grain=noise2d(x+333,y+777,4)*0.15; // small grain to soften hard boundary
        const blended=Math.min(1,Math.max(0,elev+grain));
        // tv=1 (dark) at high elevation, tv=0 (light) at low
        world.tv[y][x]=blended>0.45?1:0;
      }else{
        // Two noise layers: coarse clusters + fine local grain
        const coarse=noise2d(x,y,14);
        const medium=noise2d(x+400,y+200,6)*0.35;
        const fine  =noise2d(x+777,y+333,2)*0.15;
        const combined=(coarse+medium+fine)%1.0;
        world.tv[y][x]=Math.floor(combined*nv)%nv;
      }
    }
  }

  Math.random=_origRand; // restore
}

function genOceanDepth(){
  // BFS from all land tiles outward ‚Äî water tiles get depth = distance from nearest land
  // Normalised to 0..1 where 0=adjacent to shore, 1=furthest open ocean
  const dist=[];
  for(let y=0;y<G;y++){dist[y]=new Float32Array(G).fill(-1);}
  const queue=[];
  // Seed queue with all water tiles adjacent to land (dist=0 = shallow shoreline)
  for(let y=0;y<G;y++)for(let x=0;x<G;x++){
    if(world.terrain[y][x]==='WATER'){
      const adj=(x>0&&world.terrain[y][x-1]!=='WATER')||(x<G-1&&world.terrain[y][x+1]!=='WATER')||
                (y>0&&world.terrain[y-1][x]!=='WATER')||(y<G-1&&world.terrain[y+1][x]!=='WATER');
      if(adj){dist[y][x]=0;queue.push(x,y);}
    }
  }
  // BFS
  let maxDist=1;
  for(let i=0;i<queue.length;i+=2){
    const x=queue[i],y=queue[i+1],d=dist[y][x];
    const dirs=[[-1,0],[1,0],[0,-1],[0,1]];
    for(const [dx,dy] of dirs){
      const nx=x+dx,ny=y+dy;
      if(nx<0||nx>=G||ny<0||ny>=G)continue;
      if(world.terrain[ny][nx]!=='WATER')continue;
      if(dist[ny][nx]>=0)continue;
      dist[ny][nx]=d+1;
      if(d+1>maxDist)maxDist=d+1;
      queue.push(nx,ny);
    }
  }
  // Normalise and store; any still -1 are landlocked ‚Äî treat as 0
  if(!world.depth)world.depth=[];
  for(let y=0;y<G;y++){
    if(!world.depth[y])world.depth[y]=new Float32Array(G);
    for(let x=0;x<G;x++){
      if(world.terrain[y][x]!=='WATER'){world.depth[y][x]=0;continue;}
      const raw=dist[y][x]<0?0:dist[y][x];
      // Non-linear: sqrt gives gradual darkening then plateau for deep ocean
      world.depth[y][x]=Math.min(1,Math.sqrt(raw/maxDist)*1.4);
    }
  }
}

function genIsland(sizeRatio){
  const cx=G/2,cy=G/2;
  const maxR=(G/2)*sizeRatio;
  // Start everything as deep water
  for(let y=0;y<G;y++){
    world.terrain[y]=[];world.tv[y]=[];
    for(let x=0;x<G;x++){world.terrain[y][x]='WATER';world.tv[y][x]=rnd(8);}
  }
  // Carve landmass using layered noise
  for(let y=0;y<G;y++){
    for(let x=0;x<G;x++){
      const dx=x-cx,dy=y-cy;
      const dist=Math.sqrt(dx*dx+dy*dy);
      // Radial falloff ‚Äî hard 0 at edge, 1 at centre
      const radial=Math.max(0,1-dist/maxR);
      // Warp the edge with multi-octave noise
      const n1=noise2d(x,y,16)*0.5+noise2d(x,y,8)*0.3+noise2d(x,y,4)*0.2;
      const n2=noise2d(x+500,y+500,24)*0.4+noise2d(x+200,y+800,10)*0.3+noise2d(x+100,y+300,5)*0.3;
      const val=radial*0.7+(n1+n2)*0.3;
      if(val>0.38){setT(x,y,'GRASS');
        if(!world.elev[y])world.elev[y]=[];
        world.elev[y][x]=Math.min(1,Math.max(0,(val-0.38)/0.62));
      }
    }
  }
}

function genSmallForests(){
  // Scatter sparse seed-trees ‚Äî forests grow organically from these
  const count=6+rnd(8); // few clusters only
  for(let i=0;i<count;i++){
    const cx=Math.floor(G/2)+(rnd(G/2)-G/4);
    const cy=Math.floor(G/2)+(rnd(G/2)-G/4);
    const r=2+rnd(3);
    const dens=0.5+Math.random()*0.35;
    for(let yy=cy-r;yy<=cy+r;yy++)for(let xx=cx-r;xx<=cx+r;xx++){
      if(xx<0||xx>=G||yy<0||yy>=G)continue;
      const k=xx+','+yy;
      if(Math.sqrt((xx-cx)**2+(yy-cy)**2)<=r&&Math.random()<dens
        &&world.terrain[yy][xx]==='GRASS'&&!treeMap.has(k))
        world.trees.push(new Tree(xx,yy,800+rnd(2400))); // start as mature forest
    }
  }
}

function genRivers(){
  // Rivers start inland and flow to coast
  const numRivers=2+rnd(3);
  for(let i=0;i<numRivers;i++){
    // Start near centre, wander outward
    let x=Math.floor(G/2)+rnd(16)-8;
    let y=Math.floor(G/2)+rnd(16)-8;
    let dx=rnd(3)-1||1,dy=rnd(3)-1;
    const w=1+rnd(2);
    for(let s=0;s<40+rnd(30);s++){
      for(let dw=-w;dw<=w;dw++){
        const wx=x+(dy!==0?dw:0),wy=y+(dx!==0?dw:0);
        setT(wx,wy,'WATER');
      }
      if(Math.random()<0.18){
        if(dx!==0){dy=Math.random()<0.5?1:-1;dx=0;}
        else{dx=Math.random()<0.5?1:-1;dy=0;}
      }
      x+=dx;y+=dy;
      if(x<0||x>=G||y<0||y>=G)break;
      if(world.terrain[y][x]==='WATER')break; // reached sea
    }
  }
}

function genMountains(){
  const num=1+rnd(2);
  for(let i=0;i<num;i++){
    let x=Math.floor(G/2)+rnd(G/2)-G/4;
    let y=Math.floor(G/2)+rnd(G/2)-G/4;
    const angle=Math.random()*Math.PI*2,len=2+rnd(3);
    for(let s=0;s<len;s++){
      const r=1; // always radius 1 ‚Äî small tight clusters only
      for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){
        if(Math.sqrt(dx*dx+dy*dy)>r)continue;
        const mx=Math.floor(x+dx),my=Math.floor(y+dy);
        if(mx>=0&&mx<G&&my>=0&&my<G&&world.terrain[my][mx]==='GRASS')
          setT(mx,my,'MOUNTAIN');
      }
      x+=Math.cos(angle+(Math.random()-.5)*.8)*2;
      y+=Math.sin(angle+(Math.random()-.5)*.8)*2;
      if(x<5||x>=G-5||y<5||y>=G-5)break;
    }
  }
}

function genStones(){
  for(let y=0;y<G;y++)for(let x=0;x<G;x++){
    if(world.terrain[y][x]!=='GRASS')continue;
    let nm=false;
    for(let dy=-4;dy<=4&&!nm;dy++)for(let dx=-4;dx<=4&&!nm;dx++){
      const nx=x+dx,ny=y+dy;
      if(nx>=0&&nx<G&&ny>=0&&ny<G&&world.terrain[ny][nx]==='MOUNTAIN')nm=true;
    }
    if(nm&&Math.random()<0.04&&!world.stones.find(s=>s.x===x&&s.y===y))
      world.stones.push({x,y,amount:5+rnd(6)});
  }
  // Scattered stones
  for(let i=0;i<20;i++){
    const x=rnd(G),y=rnd(G);
    if(world.terrain[y][x]==='GRASS'&&!world.stones.find(s=>s.x===x&&s.y===y))
      world.stones.push({x,y,amount:4+rnd(5)});
  }
}

function genBeaches(){
  for(let y=1;y<G-1;y++)for(let x=1;x<G-1;x++){
    if(world.terrain[y][x]!=='GRASS')continue;
    let near=false;
    for(let dy=-1;dy<=1&&!near;dy++)for(let dx=-1;dx<=1&&!near;dx++)
      if(world.terrain[y+dy]&&world.terrain[y+dy][x+dx]==='WATER')near=true;
    if(near&&Math.random()<0.7)setT(x,y,'SAND');
  }
}

function genMarshes(){
  for(let i=0;i<3+rnd(3);i++){
    const cx=Math.floor(G/2)+rnd(G/2)-G/4;
    const cy=Math.floor(G/2)+rnd(G/2)-G/4;
    if(world.terrain[cy]&&world.terrain[cy][cx]!=='GRASS')continue;
    const r=2+rnd(4);
    for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){
      if(Math.sqrt(dx*dx+dy*dy)>r)continue;
      const mx=cx+dx,my=cy+dy;
      if(mx>=0&&mx<G&&my>=0&&my<G&&world.terrain[my][mx]==='GRASS'&&Math.random()<0.6)
        setT(mx,my,'MARSH');
    }
  }
}

function genFoodSources(){
  world.trees.forEach(t=>{if(Math.random()<0.12)addFood(t.x+rnd(5)-2,t.y+rnd(5)-2);});
  for(let i=0;i<60;i++){
    const x=rnd(G),y=rnd(G);
    if(world.terrain[y]&&TER[world.terrain[y][x]]?.walkable)addFood(x,y);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYSTEMS: SEASONS, WEATHER, DISEASE, DAY/NIGHT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSeasons(){
  seasonTick++;
  if(seasonTick>=1800){seasonTick=0;season=(season+1)%4;const names=['üå∏ Spring','‚òÄ Summer','üçÇ Autumn','‚ùÑ Winter'];notify(names[season]+' begins');logEvent(`Year ${year} ‚Äî ${names[season]} arrives.`);
    if(season===3){for(let y=0;y<G;y+=3)for(let x=0;x<G;x+=3){if(world.terrain[y][x]==='GRASS'&&Math.random()<0.15)setT(x,y,'SNOW');}}
    else if(season===0){for(let y=0;y<G;y++)for(let x=0;x<G;x++){if(world.terrain[y][x]==='SNOW')setT(x,y,'GRASS');}}
  }
}
function updateWeather(){
  weather.ticks--;
  if(weather.ticks<=0){const types=['clear','rain','storm','drought','fog'];const weights=[0.5,0.25,0.1,0.1,0.05];let r=Math.random(),cum=0,chosen='clear';for(let i=0;i<types.length;i++){cum+=weights[i];if(r<cum){chosen=types[i];break;}}weather.type=chosen;weather.intensity=0.3+Math.random()*0.7;weather.ticks=120+rnd(180);if(chosen!=='clear'){const wn={rain:'üåß Rain falls',storm:'‚õà Storm rages',drought:'‚òÄ Drought',fog:'üå´ Fog rolls in'};if(wn[chosen])notify(wn[chosen]);}}
  if(weather.type==='rain'&&Math.random()<0.01)world.res.food+=2;
  if(weather.type==='drought'){if(Math.random()<0.008&&world.res.food>0)world.res.food--;if(Math.random()<0.005){const t=world.trees[rnd(world.trees.length)];if(t&&!t.onFire){t.onFire=true;t.fireLife=0;}}}
  if(weather.type==='storm'&&Math.random()<0.01&&world.entities.length>0){const e=world.entities[rnd(world.entities.length)];if(e){e.health-=15;world.fires.push({x:e.x+rnd(5)-2,y:e.y+rnd(5)-2,life:40});}}
}
function updateDisease(){
  if(!diseaseActive){if(world.entities.length>30&&Math.random()<0.0002){diseaseActive=true;diseaseName=DN[rnd(DN.length)];diseaseSeverity=0.5+Math.random()*1.5;for(let i=0;i<3;i++){const e=world.entities[rnd(world.entities.length)];if(e)e.infected=true;}notify(`ü¶† ${diseaseName} breaks out!`,'danger');logEvent(`Year ${year} ‚Äî ${diseaseName} sweeps the land!`);}}
  else{const infected=world.entities.filter(e=>e.infected).length;if(infected===0){diseaseActive=false;notify(`‚úÖ ${diseaseName} eradicated`,'good');logEvent(`Year ${year} ‚Äî ${diseaseName} overcome.`);diseaseName='';diseaseSeverity=0;worldMorale=Math.min(100,worldMorale+10);}}
}
function updateDayNight(){dayTick++;if(dayTick>=600){dayTick=0;dayPhase=(dayPhase+1)%4;}}
let _lastDayPhase=-1;
function applyNightOverlay(){
  // Day/night is now handled by PixiJS ColorMatrixFilter in _applyDayNightFilter()
  // Clear the CSS overlay so it doesn't double up
  const el=_dom('nightOverlay');
  if(el)el.style.background='transparent';
}
function updateLava(){
  world.lavaFlows=world.lavaFlows.filter(l=>{l.life--;if(l.life<=0)return false;if(l.life%8===0&&Math.random()<0.5){const dirs=[[-1,0],[1,0],[0,-1],[0,1]];const d=dirs[rnd(dirs.length)];const nx=l.x+d[0],ny=l.y+d[1];if(nx>=0&&nx<G&&ny>=0&&ny<G&&world.terrain[ny][nx]!=='WATER'){setT(nx,ny,'LAVA');world.lavaFlows.push({x:nx,y:ny,life:80+rnd(40)});world.trees=world.trees.filter(t=>!(t.x===nx&&t.y===ny));world.buildings=world.buildings.filter(b=>!(b.x===nx&&b.y===ny));world.entities.filter(e=>e.x===nx&&e.y===ny).forEach(e=>e.health=0);}}return true;});
}
function updateMorale(){
  const food=world.res.food;
  if(food>50)worldMorale=Math.min(100,worldMorale+0.02);else if(food<10)worldMorale=Math.max(0,worldMorale-0.05);
  if(_infectedCount>5)worldMorale=Math.max(0,worldMorale-0.1);
  if(weather.type==='drought')worldMorale=Math.max(0,worldMorale-0.03);
  if(weather.type==='rain')worldMorale=Math.min(100,worldMorale+0.01);
  worldMorale=Math.min(100,worldMorale+world.buildings.filter(b=>b.type==='temple').length*0.005);
  const fill=_dom('moraleFill');
  if(fill){fill.style.width=worldMorale+'%';fill.style.background=worldMorale>60?'#4a8830':worldMorale>30?'#a07820':'#882020';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILDING RENDERING ‚Äî multi-tile, richly detailed
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawBuilding(b,px,py,c){
  const bw=Math.round((b.w||1)*c), bh=Math.round((b.h||1)*c);
  const f=Math.floor;

  switch(b.type){

  // ‚îÄ‚îÄ HOUSE (2√ó2) ‚Äî WorldBox reference: pointy blue-grey roof, warm brown walls, twin windows ‚îÄ‚îÄ
  case'house':{
    // Reference image analysis:
    // - Tall pointy triangular blue-grey roof taking top ~55% of building
    //   with checkerboard tile pattern (alternating lighter/darker squares)
    // - Warm brown/tan wood walls (lower ~45%)
    // - Two small square BLACK windows, side by side, near top of wall
    // - Small brown door protrusion at bottom centre
    // - Roof overhangs left and right slightly
    // - Roof has distinct darker tip at very top

    // Ground shadow
    ctx.fillStyle='#1a2210';ctx.fillRect(px+f(bw*.08),py+f(bh*.9),f(bw*.9),f(bh*.12));

    // ‚îÄ‚îÄ WALLS ‚Äî warm brown wood ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#c07840';ctx.fillRect(px+f(bw*.06),py+f(bh*.52),f(bw*.88),f(bh*.52));
    // Left lit face
    ctx.fillStyle='#d08850';ctx.fillRect(px+f(bw*.06),py+f(bh*.52),f(bw*.12),f(bh*.52));
    // Right shadow face
    ctx.fillStyle='#8a5028';ctx.fillRect(px+f(bw*.82),py+f(bh*.52),f(bw*.12),f(bh*.52));
    // Dark base strip
    ctx.fillStyle='#6a3818';ctx.fillRect(px+f(bw*.06),py+f(bh*.9),f(bw*.88),f(bh*.12));

    // ‚îÄ‚îÄ DOOR BUMP ‚Äî small rectangle protruding at bottom centre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#c07840';ctx.fillRect(px+f(bw*.38),py+f(bh*.78),f(bw*.24),f(bh*.22));
    ctx.fillStyle='#d08850';ctx.fillRect(px+f(bw*.38),py+f(bh*.78),f(bw*.04),f(bh*.22));
    ctx.fillStyle='#7a4020';ctx.fillRect(px+f(bw*.38),py+f(bh*.88),f(bw*.24),f(bh*.04));
    // Door opening (dark)
    ctx.fillStyle='#1e1008';ctx.fillRect(px+f(bw*.42),py+f(bh*.78),f(bw*.16),f(bh*.22));

    // ‚îÄ‚îÄ TWO WINDOWS ‚Äî square black, side by side ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#141008';
    ctx.fillRect(px+f(bw*.12),py+f(bh*.60),f(bw*.22),f(bh*.2));  // left window
    ctx.fillRect(px+f(bw*.66),py+f(bh*.60),f(bw*.22),f(bh*.2));  // right window
    // Window frame ‚Äî thin lighter border
    ctx.fillStyle='#8a5828';
    ctx.fillRect(px+f(bw*.10),py+f(bh*.58),f(bw*.26),f(bh*.02));
    ctx.fillRect(px+f(bw*.64),py+f(bh*.58),f(bw*.26),f(bh*.02));

    // ‚îÄ‚îÄ ROOF ‚Äî steep pointy blue-grey with checkerboard tiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Roof is a tall diamond/triangle pointing up, overhangs wall left+right
    // Main roof fill ‚Äî medium blue-grey
    ctx.fillStyle='#7a90a8';
    // Draw as stacked rows narrowing toward top (pixel pyramid)
    const roofRows=10;
    const roofH=f(bh*.58);
    const roofTop=py-f(bh*.05); // rises slightly above building top
    for(let r=0;r<roofRows;r++){
      const rowY=roofTop+f(r*(roofH/roofRows));
      const rowH=Math.max(1,f(roofH/roofRows)+1);
      // Width narrows from full+overhang at bottom to 2px at tip
      const frac=r/roofRows;
      const rowW=Math.max(2,f(bw*(0.28+frac*0.96)));
      const rowX=px+f(bw/2)-f(rowW/2);
      // Checkerboard ‚Äî alternate row tint
      const even=r%2===0;
      ctx.fillStyle=even?'#8aa0b8':'#6880a0';
      ctx.fillRect(rowX,rowY,rowW,rowH);
      // Checkerboard column pattern within row (every other tile-width segment)
      if(rowW>8){
        const segW=Math.max(3,f(rowW/5));
        ctx.fillStyle=even?'#6880a0':'#8aa0b8';
        for(let sx2=rowX+(segW);sx2<rowX+rowW-segW;sx2+=segW*2){
          ctx.fillRect(sx2,rowY,segW,rowH);
        }
      }
    }
    // Roof left lit slope strip
    ctx.fillStyle='#a0b8d0';
    for(let r=0;r<roofRows;r++){
      const rowY=roofTop+f(r*(roofH/roofRows));
      const rowH=Math.max(1,f(roofH/roofRows)+1);
      const frac=r/roofRows;
      const rowW=Math.max(2,f(bw*(0.28+frac*0.96)));
      const rowX=px+f(bw/2)-f(rowW/2);
      ctx.fillRect(rowX,rowY,Math.max(1,f(rowW*.1)),rowH);
    }
    // Roof dark right shadow strip
    ctx.fillStyle='#4a6070';
    for(let r=0;r<roofRows;r++){
      const rowY=roofTop+f(r*(roofH/roofRows));
      const rowH=Math.max(1,f(roofH/roofRows)+1);
      const frac=r/roofRows;
      const rowW=Math.max(2,f(bw*(0.28+frac*0.96)));
      const rowX=px+f(bw/2)-f(rowW/2);
      ctx.fillRect(rowX+rowW-Math.max(1,f(rowW*.12)),rowY,Math.max(1,f(rowW*.12)),rowH);
    }
    // Roof bottom overhang shadow line
    ctx.fillStyle='#3a4858';ctx.fillRect(px-f(bw*.04),py+f(bh*.52),f(bw*1.08),f(bh*.03));
    // Roof tip ‚Äî darkest
    ctx.fillStyle='#2a3848';ctx.fillRect(px+f(bw*.46),roofTop,f(bw*.08),f(bh*.05));

    // Winter snow
    if(season===3){ctx.fillStyle='#dceef8';ctx.fillRect(px,py+f(bh*.5),bw,f(bh*.04));}
    break;}

  // ‚îÄ‚îÄ FARM (2√ó2) ‚Äî just a small farmhouse/barn marker; crops grow separately ‚îÄ‚îÄ
  case'farm':{
    // Small barn marker ‚Äî red wood barn
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    // Barn walls ‚Äî red
    ctx.fillStyle='#a82818';ctx.fillRect(px,py+f(bh*.32),bw,f(bh*.68));
    ctx.fillStyle='#c03020';ctx.fillRect(px,py+f(bh*.32),f(bw*.12),f(bh*.68));
    ctx.fillStyle='#701808';ctx.fillRect(px+f(bw*.88),py+f(bh*.32),f(bw*.12),f(bh*.68));
    // Roof ‚Äî dark triangular = stacked shrinking rows
    ctx.fillStyle='#2e2218';ctx.fillRect(px-f(bw*.06),py+f(bh*.08),f(bw*1.12),f(bh*.26));
    ctx.fillStyle='#4a3828';ctx.fillRect(px-f(bw*.06),py+f(bh*.08),f(bw*1.12),f(bh*.06));
    ctx.fillStyle='#221810';ctx.fillRect(px+f(bw*.12),py,f(bw*.76),f(bh*.1));
    // Loft window
    ctx.fillStyle='#e8c040';ctx.fillRect(px+f(bw*.3),py+f(bh*.14),f(bw*.4),f(bh*.12));
    // Barn door
    ctx.fillStyle='#180c04';ctx.fillRect(px+f(bw*.28),py+f(bh*.6),f(bw*.44),f(bh*.4));
    ctx.fillStyle='#3a1e0c';ctx.fillRect(px+f(bw*.28),py+f(bh*.6),f(bw*.06),f(bh*.4));
    ctx.fillStyle='#3a1e0c';ctx.fillRect(px+f(bw*.66),py+f(bh*.6),f(bw*.06),f(bh*.4));
    break;}

  // ‚îÄ‚îÄ WORKSHOP (2√ó2) ‚Äî stone smithy, dark roof, tall chimney ‚îÄ‚îÄ
  case'workshop':{
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    // Stone walls ‚Äî medium grey-brown
    ctx.fillStyle='#787060';ctx.fillRect(px,py+f(bh*.3),bw,f(bh*.7));
    ctx.fillStyle='#888070';ctx.fillRect(px,py+f(bh*.3),f(bw*.12),f(bh*.7));
    ctx.fillStyle='#585048';ctx.fillRect(px+f(bw*.88),py+f(bh*.3),f(bw*.12),f(bh*.7));
    // Stone mortar grid
    ctx.fillStyle='#484038';
    ctx.fillRect(px,py+f(bh*.48),bw,1);ctx.fillRect(px,py+f(bh*.66),bw,1);
    ctx.fillRect(px+f(bw*.25),py+f(bh*.3),1,f(bh*.18));ctx.fillRect(px+f(bw*.5),py+f(bh*.3),1,f(bh*.18));ctx.fillRect(px+f(bw*.75),py+f(bh*.3),1,f(bh*.18));
    // Dark pitched roof
    ctx.fillStyle='#252018';ctx.fillRect(px-f(bw*.05),py+f(bh*.08),f(bw*1.1),f(bh*.24));
    ctx.fillStyle='#353028';ctx.fillRect(px-f(bw*.05),py+f(bh*.08),f(bw*1.1),f(bh*.06));
    ctx.fillStyle='#181410';ctx.fillRect(px+f(bw*.1),py,f(bw*.8),f(bh*.1));
    // Tall chimney ‚Äî left
    ctx.fillStyle='#504030';ctx.fillRect(px+f(bw*.1),py-f(bh*.16),f(bw*.15),f(bh*.3));
    ctx.fillStyle='#605040';ctx.fillRect(px+f(bw*.1),py-f(bh*.16),f(bw*.15),f(bh*.05));
    ctx.fillStyle='#302018';ctx.fillRect(px+f(bw*.08),py-f(bh*.19),f(bw*.19),f(bh*.04));
    // Smoke
    const st=Math.floor(_frameNow/320)%4;
    ctx.fillStyle='#706860';ctx.fillRect(px+f(bw*.13),py-f(bh*.24)-st,f(bw*.09),f(bh*.05));
    // Forge glow ‚Äî hot orange, solid blocks
    ctx.fillStyle='#d84800';ctx.fillRect(px+f(bw*.2),py+f(bh*.52),f(bw*.44),f(bh*.14));
    ctx.fillStyle='#f06000';ctx.fillRect(px+f(bw*.3),py+f(bh*.46),f(bw*.24),f(bh*.09));
    ctx.fillStyle='#ff7800';ctx.fillRect(px+f(bw*.38),py+f(bh*.41),f(bw*.08),f(bh*.07));
    // Door
    ctx.fillStyle='#140804';ctx.fillRect(px+f(bw*.36),py+f(bh*.62),f(bw*.28),f(bh*.38));
    ctx.fillStyle='#3a1e08';ctx.fillRect(px+f(bw*.36),py+f(bh*.62),f(bw*.04),f(bh*.38));
    // Window ‚Äî glowing from forge
    ctx.fillStyle='#0e0804';ctx.fillRect(px+f(bw*.06),py+f(bh*.38),f(bw*.16),f(bh*.14));
    ctx.fillStyle='#e09030';ctx.fillRect(px+f(bw*.08),py+f(bh*.4),f(bw*.06),f(bh*.05));
    ctx.fillStyle='#e09030';ctx.fillRect(px+f(bw*.14),py+f(bh*.4),f(bw*.06),f(bh*.05));
    break;}

  // ‚îÄ‚îÄ MINE (2√ó2) ‚Äî boulder dome with timber entrance ‚îÄ‚îÄ
  case'mine':{
    // No drop shadow ‚Äî dome sits on ground
    // Boulder dome ‚Äî rounded pile of dark grey/purple rocks
    // Layer from back (top) to front (bottom)
    const f2=Math.floor;
    // Back rocks ‚Äî darkest
    ctx.fillStyle='#2a2838';
    ctx.fillRect(px+f2(bw*.2),py,f2(bw*.6),f2(bh*.2));
    // Upper dome ‚Äî main grey-purple
    ctx.fillStyle='#4a4858';
    ctx.fillRect(px+f2(bw*.08),py+f2(bh*.08),f2(bw*.84),f2(bh*.32));
    // Mid dome ‚Äî wider
    ctx.fillStyle='#545268';
    ctx.fillRect(px,py+f2(bh*.28),bw,f2(bh*.32));
    // Lower dome ‚Äî ground level, widest
    ctx.fillStyle='#3e3c4c';
    ctx.fillRect(px,py+f2(bh*.52),bw,f2(bh*.28));
    // Rock highlight blocks (top-left lit face) ‚Äî scattered lighter pixels
    ctx.fillStyle='#706e80';
    ctx.fillRect(px+f2(bw*.1),py+f2(bh*.1),f2(bw*.2),f2(bh*.12));
    ctx.fillRect(px+f2(bw*.6),py+f2(bh*.15),f2(bw*.15),f2(bh*.1));
    ctx.fillRect(px+f2(bw*.08),py+f2(bh*.3),f2(bw*.18),f2(bh*.1));
    ctx.fillRect(px+f2(bw*.72),py+f2(bh*.32),f2(bw*.16),f2(bh*.1));
    ctx.fillRect(px+f2(bw*.35),py+f2(bh*.08),f2(bw*.22),f2(bh*.1));
    // Rock dark crevice lines
    ctx.fillStyle='#1e1c2c';
    ctx.fillRect(px+f2(bw*.3),py+f2(bh*.18),f2(bw*.3),1);
    ctx.fillRect(px+f2(bw*.15),py+f2(bh*.38),f2(bw*.25),1);
    ctx.fillRect(px+f2(bw*.55),py+f2(bh*.42),f2(bw*.3),1);
    // Purple accent rocks
    ctx.fillStyle='#5c4870';
    ctx.fillRect(px+f2(bw*.28),py+f2(bh*.12),f2(bw*.18),f2(bh*.1));
    ctx.fillRect(px+f2(bw*.62),py+f2(bh*.28),f2(bw*.2),f2(bh*.12));
    ctx.fillRect(px+f2(bw*.06),py+f2(bh*.44),f2(bw*.2),f2(bh*.1));
    // Orange timber entrance frame ‚Äî bottom center
    ctx.fillStyle='#c86820';
    ctx.fillRect(px+f2(bw*.28),py+f2(bh*.54),f2(bw*.1),f2(bh*.28));
    ctx.fillRect(px+f2(bw*.62),py+f2(bh*.54),f2(bw*.1),f2(bh*.28));
    ctx.fillRect(px+f2(bw*.26),py+f2(bh*.52),f2(bw*.48),f2(bh*.06));
    // Lintel highlight
    ctx.fillStyle='#e08030';ctx.fillRect(px+f2(bw*.26),py+f2(bh*.52),f2(bw*.48),f2(bh*.02));
    // Dark tunnel entrance
    ctx.fillStyle='#080608';ctx.fillRect(px+f2(bw*.36),py+f2(bh*.56),f2(bw*.28),f2(bh*.44));
    // Ground beneath mine (dark earth)
    ctx.fillStyle='#3a2c1a';ctx.fillRect(px,py+f2(bh*.78),bw,f2(bh*.22));
    ctx.fillStyle='#2a1e0e';ctx.fillRect(px,py+f2(bh*.9),bw,f2(bh*.1));
    // Ore sparkle inside tunnel
    ctx.fillStyle='#90a8c8';ctx.fillRect(px+f2(bw*.4),py+f2(bh*.68),f2(bw*.04),f2(bh*.03));
    ctx.fillStyle='#b0c8e0';ctx.fillRect(px+f2(bw*.41),py+f2(bh*.68),f2(bw*.02),f2(bh*.015));
    break;}

  // ‚îÄ‚îÄ LIBRARY (2√ó3) ‚Äî tall stone building, arched windows, steep roof ‚îÄ‚îÄ
  case'library':{
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    // Cream stone walls
    ctx.fillStyle='#c8b888';ctx.fillRect(px,py+f(bh*.18),bw,f(bh*.82));
    ctx.fillStyle='#d8c898';ctx.fillRect(px,py+f(bh*.18),f(bw*.12),f(bh*.82));
    ctx.fillStyle='#a09070';ctx.fillRect(px+f(bw*.88),py+f(bh*.18),f(bw*.12),f(bh*.82));
    ctx.fillStyle='#806848';
    ctx.fillRect(px,py+f(bh*.38),bw,1);ctx.fillRect(px,py+f(bh*.58),bw,1);ctx.fillRect(px,py+f(bh*.78),bw,1);
    ctx.fillRect(px+f(bw*.33),py+f(bh*.18),1,f(bh*.2));ctx.fillRect(px+f(bw*.66),py+f(bh*.18),1,f(bh*.2));
    // Steep dark roof
    ctx.fillStyle='#2a2018';ctx.fillRect(px-f(bw*.06),py+f(bh*.04),f(bw*1.12),f(bh*.16));
    ctx.fillStyle='#3a3028';ctx.fillRect(px-f(bw*.06),py+f(bh*.04),f(bw*1.12),f(bh*.05));
    ctx.fillStyle='#1a1410';ctx.fillRect(px+f(bw*.12),py,f(bw*.76),f(bh*.06));
    // 2 arched windows (pixel-art arch = rect + dark-top row)
    for(let i=0;i<2;i++){
      const wx=px+f(bw*(i===0?.08:.54));
      ctx.fillStyle='#1a1408';ctx.fillRect(wx,py+f(bh*.24),f(bw*.36),f(bh*.26));
      ctx.fillStyle='#c0a840';ctx.fillRect(wx+f(bw*.04),py+f(bh*.28),f(bw*.12),f(bh*.09));
      ctx.fillStyle='#c0a840';ctx.fillRect(wx+f(bw*.2),py+f(bh*.28),f(bw*.12),f(bh*.09));
      ctx.fillStyle='#c0a840';ctx.fillRect(wx+f(bw*.04),py+f(bh*.38),f(bw*.12),f(bh*.09));
      ctx.fillStyle='#c0a840';ctx.fillRect(wx+f(bw*.2),py+f(bh*.38),f(bw*.12),f(bh*.09));
    }
    // Wide lower window
    ctx.fillStyle='#1a1408';ctx.fillRect(px+f(bw*.12),py+f(bh*.6),f(bw*.76),f(bh*.18));
    ctx.fillStyle='#d8b840';ctx.fillRect(px+f(bw*.16),py+f(bh*.63),f(bw*.67),f(bh*.12));
    ctx.fillStyle='#302820';ctx.fillRect(px+f(bw*.32),py+f(bh*.63),f(bw*.04),f(bh*.12));
    ctx.fillStyle='#302820';ctx.fillRect(px+f(bw*.52),py+f(bh*.63),f(bw*.04),f(bh*.12));
    // Door
    ctx.fillStyle='#2a1808';ctx.fillRect(px+f(bw*.36),py+f(bh*.8),f(bw*.28),f(bh*.2));
    break;}

  // ‚îÄ‚îÄ MARKET (3√ó2) ‚Äî open stall with bright striped canopy ‚îÄ‚îÄ
  case'market':{
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    ctx.fillStyle='#806848';ctx.fillRect(px,py+f(bh*.55),bw,f(bh*.45));
    ctx.fillStyle='#907858';ctx.fillRect(px,py+f(bh*.55),f(bw*.08),f(bh*.45));
    const sw=f(bw/6);
    const cols=['#c02818','#e03828','#c02818','#d03020','#c02818','#e03828'];
    cols.forEach((col,i)=>{ctx.fillStyle=col;ctx.fillRect(px+i*sw,py+f(bh*.1),sw,f(bh*.3));});
    ctx.fillStyle='#801808';ctx.fillRect(px-f(bw*.02),py+f(bh*.08),f(bw*1.04),f(bh*.05));
    // Scallop edge ‚Äî pixel stepped
    ctx.fillStyle='#600f06';
    for(let i=0;i<6;i++){
      ctx.fillRect(px+i*sw,py+f(bh*.38),sw,f(bh*.04));
      ctx.fillRect(px+i*sw+f(sw*.2),py+f(bh*.42),f(sw*.6),f(bh*.03));
    }
    // Posts
    ctx.fillStyle='#5a3818';
    ctx.fillRect(px+f(bw*.04),py+f(bh*.3),f(bw*.04),f(bh*.28));
    ctx.fillRect(px+f(bw*.48),py+f(bh*.3),f(bw*.04),f(bh*.28));
    ctx.fillRect(px+f(bw*.92),py+f(bh*.3),f(bw*.04),f(bh*.28));
    // Goods
    ctx.fillStyle='#c82818';ctx.fillRect(px+f(bw*.08),py+f(bh*.6),f(bw*.12),f(bh*.12));
    ctx.fillStyle='#e09020';ctx.fillRect(px+f(bw*.26),py+f(bh*.62),f(bw*.14),f(bh*.1));
    ctx.fillStyle='#408018';ctx.fillRect(px+f(bw*.46),py+f(bh*.6),f(bw*.14),f(bh*.12));
    ctx.fillStyle='#4858a0';ctx.fillRect(px+f(bw*.68),py+f(bh*.6),f(bw*.12),f(bh*.12));
    ctx.fillStyle='#786030';ctx.fillRect(px+f(bw*.06),py+f(bh*.72),f(bw*.88),f(bh*.05));
    break;}

  // ‚îÄ‚îÄ BARRACKS (3√ó2) ‚Äî fortified stone, battlements, red banner ‚îÄ‚îÄ
  case'barracks':{
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    ctx.fillStyle='#7a7868';ctx.fillRect(px,py+f(bh*.2),bw,f(bh*.8));
    ctx.fillStyle='#8a8878';ctx.fillRect(px,py+f(bh*.2),f(bw*.1),f(bh*.8));
    ctx.fillStyle='#585848';ctx.fillRect(px+f(bw*.9),py+f(bh*.2),f(bw*.1),f(bh*.8));
    ctx.fillStyle='#484840';
    ctx.fillRect(px,py+f(bh*.42),bw,1);ctx.fillRect(px,py+f(bh*.62),bw,1);
    ctx.fillRect(px+f(bw*.33),py+f(bh*.2),1,f(bh*.22));ctx.fillRect(px+f(bw*.66),py+f(bh*.2),1,f(bh*.22));
    // Battlements
    ctx.fillStyle='#686858';
    const cw=f(bw/8);
    for(let m=0;m<8;m+=2)ctx.fillRect(px+m*cw,py+f(bh*.06),cw,f(bh*.15));
    ctx.fillStyle='#585848';ctx.fillRect(px,py+f(bh*.19),bw,f(bh*.04));
    ctx.fillStyle='#323228';ctx.fillRect(px+f(bw*.04),py+f(bh*.1),f(bw*.92),f(bh*.1));
    // Arrow slits
    for(let sl=0;sl<3;sl++){
      ctx.fillStyle='#181408';
      ctx.fillRect(px+f(sl*(bw*.32))+f(bw*.14),py+f(bh*.28),f(bw*.04),f(bh*.2));
      ctx.fillRect(px+f(sl*(bw*.32))+f(bw*.1),py+f(bh*.34),f(bw*.12),f(bh*.07));
    }
    // Gate
    ctx.fillStyle='#141008';ctx.fillRect(px+f(bw*.38),py+f(bh*.58),f(bw*.24),f(bh*.42));
    ctx.fillStyle='#2a1e10';ctx.fillRect(px+f(bw*.38),py+f(bh*.58),f(bw*.24),f(bh*.05));
    // Banner
    ctx.fillStyle='#302008';ctx.fillRect(px+f(bw*.47),py-f(bh*.1),f(bw*.05),f(bh*.2));
    ctx.fillStyle='#a81808';ctx.fillRect(px+f(bw*.52),py-f(bh*.09),f(bw*.18),f(bh*.12));
    ctx.fillStyle='#c82010';ctx.fillRect(px+f(bw*.52),py-f(bh*.09),f(bw*.18),f(bh*.04));
    if(dayPhase===2||dayPhase===3){
      const tt=Math.floor(_frameNow/260)%2;
      ctx.fillStyle=tt===0?'#e07800':'#c06000';
      ctx.fillRect(px+f(bw*.07),py+f(bh*.18),f(bw*.05),f(bh*.09));
      ctx.fillRect(px+f(bw*.88),py+f(bh*.18),f(bw*.05),f(bh*.09));
    }
    break;}

  // ‚îÄ‚îÄ CASTLE (4√ó4) ‚Äî massive stone fortress ‚îÄ‚îÄ
  case'castle':{
    ctx.fillStyle='#0e1608';ctx.fillRect(px+4,py+4,bw,bh);
    ctx.fillStyle='#909080';ctx.fillRect(px,py+f(bh*.26),bw,f(bh*.74));
    ctx.fillStyle='#a0a090';ctx.fillRect(px,py+f(bh*.26),f(bw*.07),f(bh*.74));
    ctx.fillStyle='#686860';ctx.fillRect(px+f(bw*.93),py+f(bh*.26),f(bw*.07),f(bh*.74));
    ctx.fillStyle='#585850';
    for(let r=1;r<5;r++)ctx.fillRect(px,py+f(bh*.26)+r*f(bh*.14),bw,1);
    for(let r=0;r<5;r++){const off=r%2?f(bw*.12):0;for(let col=1;col<7;col++)ctx.fillRect(px+off+col*f(bw*.14),py+f(bh*.26)+r*f(bh*.14),1,f(bh*.14));}
    // Towers
    const tw=f(bw*.24),th=f(bh*.88);
    [{x:px-f(bw*.02),y:py+f(bh*.06),big:true},{x:px+f(bw*.78),y:py+f(bh*.06),big:true},{x:px+f(bw*.07),y:py+f(bh*.06),big:false},{x:px+f(bw*.69),y:py+f(bh*.06),big:false}].forEach((t)=>{
      ctx.fillStyle=t.big?'#a09888':'#908878';ctx.fillRect(t.x,t.y,tw,t.big?th:f(th*.56));
      ctx.fillStyle=t.big?'#b0a898':'#a09888';ctx.fillRect(t.x,t.y,f(tw*.14),t.big?th:f(th*.56));
      ctx.fillStyle=t.big?'#888070':'#787060';
      for(let m=0;m<5;m+=2)ctx.fillRect(t.x+m*f(tw/5),t.y-f(bh*.04),f(tw/5),f(bh*.06));
      if(t.big){ctx.fillStyle='#e8d838';for(let r=0;r<2;r++){ctx.fillRect(t.x+f(tw*.22),t.y+f(th*(.2+r*.22)),f(tw*.2),f(th*.1));ctx.fillRect(t.x+f(tw*.58),t.y+f(th*(.2+r*.22)),f(tw*.2),f(th*.1));}}
    });
    // Central keep
    ctx.fillStyle='#b0a898';ctx.fillRect(px+f(bw*.28),py,f(bw*.44),f(bh*.88));
    ctx.fillStyle='#c0b8a8';ctx.fillRect(px+f(bw*.28),py,f(bw*.07),f(bh*.88));
    ctx.fillStyle='#888078';ctx.fillRect(px+f(bw*.65),py,f(bw*.07),f(bh*.88));
    ctx.fillStyle='#908880';
    for(let m=0;m<5;m++){if(m%2===0)ctx.fillRect(px+f(bw*.28)+m*f(bw*.09),py-f(bh*.05),f(bw*.09),f(bh*.06));}
    ctx.fillStyle='#e0d038';
    for(let r=0;r<3;r++){ctx.fillRect(px+f(bw*.33),py+f(bh*.1)+r*f(bh*.22),f(bw*.09),f(bh*.09));ctx.fillRect(px+f(bw*.58),py+f(bh*.1)+r*f(bh*.22),f(bw*.09),f(bh*.09));}
    ctx.fillStyle='#100c06';ctx.fillRect(px+f(bw*.37),py+f(bh*.56),f(bw*.26),f(bh*.44));
    ctx.fillStyle='#484840';
    for(let pg=0;pg<3;pg++)ctx.fillRect(px+f(bw*.38)+pg*f(bw*.08),py+f(bh*.58),f(bw*.03),f(bh*.42));
    // Flags
    ctx.fillStyle='#282010';ctx.fillRect(px+f(bw*.02),py+f(bh*.02),f(bw*.04),f(bh*.1));
    ctx.fillStyle='#b81808';ctx.fillRect(px+f(bw*.06),py+f(bh*.03),f(bw*.12),f(bh*.07));
    ctx.fillStyle='#282010';ctx.fillRect(px+f(bw*.74),py+f(bh*.02),f(bw*.04),f(bh*.1));
    ctx.fillStyle='#b81808';ctx.fillRect(px+f(bw*.78),py+f(bh*.03),f(bw*.12),f(bh*.07));
    if(dayPhase===2||dayPhase===3){const tf=Math.floor(_frameNow/280)%2;ctx.fillStyle=tf===0?'#e07800':'#c06000';ctx.fillRect(px+f(bw*.24),py+f(bh*.28),f(bw*.04),f(bh*.07));ctx.fillRect(px+f(bw*.72),py+f(bh*.28),f(bw*.04),f(bh*.07));}
    break;}

  // ‚îÄ‚îÄ TEMPLE (3√ó4) ‚Äî marble columns, gold stepped pediment ‚îÄ‚îÄ
  case'temple':{
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    // Steps
    ctx.fillStyle='#bea870';ctx.fillRect(px-f(bw*.06),py+f(bh*.82),f(bw*1.12),f(bh*.18));
    ctx.fillStyle='#ceb880';ctx.fillRect(px-f(bw*.03),py+f(bh*.74),f(bw*1.06),f(bh*.1));
    ctx.fillStyle='#dec890';ctx.fillRect(px,py+f(bh*.68),bw,f(bh*.08));
    ctx.fillStyle='#e8d8a0';ctx.fillRect(px-f(bw*.06),py+f(bh*.82),f(bw*1.12),1);ctx.fillRect(px-f(bw*.03),py+f(bh*.74),f(bw*1.06),1);ctx.fillRect(px,py+f(bh*.68),bw,1);
    // Main body
    ctx.fillStyle='#e8e0c8';ctx.fillRect(px+f(bw*.06),py+f(bh*.2),f(bw*.88),f(bh*.5));
    ctx.fillStyle='#d0c8b0';ctx.fillRect(px+f(bw*.06),py+f(bh*.2),f(bw*.08),f(bh*.5));
    // Columns
    [.06,.22,.38,.55,.71,.87].forEach(cx=>{
      ctx.fillStyle='#ede5ce';ctx.fillRect(px+f(cx*bw),py+f(bh*.2),f(bw*.1),f(bh*.48));
      ctx.fillStyle='#c8c0a0';ctx.fillRect(px+f(cx*bw)+f(bw*.05),py+f(bh*.2),1,f(bh*.48));
      ctx.fillStyle='#f8f0d8';ctx.fillRect(px+f(cx*bw)-f(bw*.02),py+f(bh*.2),f(bw*.14),f(bh*.02));
    });
    // Entablature ‚Äî gold
    ctx.fillStyle='#c8a028';ctx.fillRect(px-f(bw*.05),py+f(bh*.1),f(bw*1.1),f(bh*.12));
    ctx.fillStyle='#e0b830';ctx.fillRect(px-f(bw*.05),py+f(bh*.1),f(bw*1.1),f(bh*.04));
    // Stepped pediment
    ctx.fillStyle='#b89028';ctx.fillRect(px+f(bw*.05),py+f(bh*.03),f(bw*.9),f(bh*.09));
    ctx.fillStyle='#c8a030';ctx.fillRect(px+f(bw*.18),py-f(bh*.01),f(bw*.64),f(bh*.06));
    ctx.fillStyle='#d8b038';ctx.fillRect(px+f(bw*.3),py-f(bh*.06),f(bw*.4),f(bh*.07));
    ctx.fillStyle='#e8c040';ctx.fillRect(px+f(bw*.4),py-f(bh*.12),f(bw*.2),f(bh*.07));
    // Door + glow
    ctx.fillStyle='#3a2208';ctx.fillRect(px+f(bw*.38),py+f(bh*.5),f(bw*.24),f(bh*.18));
    const gt=Math.floor(_frameNow/500)%3;
    ctx.fillStyle=gt===0?'#c8a010':gt===1?'#d8b018':'#b89010';
    ctx.fillRect(px+f(bw*.44),py+f(bh*.46),f(bw*.12),f(bh*.06));
    break;}

  default:
    ctx.fillStyle='#1a2210';ctx.fillRect(px+2,py+2,bw,bh);
    ctx.fillStyle='#787060';ctx.fillRect(px,py,bw,bh);
  }

  // Level pips
  if(b.level>1&&c>=3){
    for(let i=0;i<b.level-1;i++){ctx.fillStyle='#e8c030';ctx.fillRect(px+bw-f(c*.22),py+f(c*.06)+i*f(c*.16),f(c*.14),f(c*.1));}
  }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// Architecture: 2D canvas draws everything ‚Üí uploaded as PixiJS
// texture ‚Üí GPU post-processing filters applied ‚Üí screen.
// The 2D canvas (z-index:2) is transparent so the PixiJS WebGL
// canvas (z-index:1) shows through with its filter effects.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Make the 2D canvas transparent so PixiJS shows behind it.
// We draw game content on ctx normally ‚Äî PixiJS composites a
// colour-graded copy below using the canvas-as-texture approach.
// For fire bloom we draw PIXI.Graphics bright rects directly.

function render(){
  if(!world)return;
  try{
    _frameNow=Date.now();
    const c=cz();
    const W=canvas.width, H=canvas.height;

    // ‚îÄ‚îÄ 2D canvas: clear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#1a2a38';
    ctx.fillRect(0,0,W,H);

    const x0=Math.max(0,Math.floor(cam.x)),y0=Math.max(0,Math.floor(cam.y));
    const x1=Math.min(G,Math.ceil(cam.x+W/c)+1),y1=Math.min(G,Math.ceil(cam.y+H/c)+1);

    // ‚îÄ‚îÄ TERRAIN PRIORITY for edge shading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const TPRI={WATER:0,MARSH:1,SAND:2,GRASS:3,SNOW:4,MOUNTAIN:5,LAVA:6};
    function tpri(n){return TPRI[n]??3;}
    function gt(gx,gy){return world.terrain[gy]?.[gx]||null;}
    function tlite(n){return TER[n]?.lite||TER[n]?.color||'#fff';}
    function tdark(n){return TER[n]?.dark||TER[n]?.color||'#000';}
    function tdkk(n){return TER[n]?.dkk||TER[n]?.dark||'#000';}
    function tbase(n){const t=TER[n];if(!t)return'#000';return t.v[2]||t.color;}
    function tcolor(n){const t=TER[n];if(!t)return null;return t.v[Math.floor(t.v.length/2)]||t.color;}

    // Water colour depth palette
    const WDEPTH=[
      [4, 12, 40],[8, 22, 72],[14,40,110],
      [22,64,148],[38,108,188],[80,168,220],
    ];
    function waterBaseRGB(depth01){
      const idx=depth01*(WDEPTH.length-1);
      const lo=Math.floor(idx),hi=Math.min(WDEPTH.length-1,lo+1),f=idx-lo;
      return[
        Math.round(WDEPTH[lo][0]+(WDEPTH[hi][0]-WDEPTH[lo][0])*f),
        Math.round(WDEPTH[lo][1]+(WDEPTH[hi][1]-WDEPTH[lo][1])*f),
        Math.round(WDEPTH[lo][2]+(WDEPTH[hi][2]-WDEPTH[lo][2])*f),
      ];
    }

    // ‚ïê‚ïê PASS 1 ‚Äî Base tiles ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    for(let y=y0;y<y1;y++)for(let x=x0;x<x1;x++){
      const tname=gt(x,y);const t=TER[tname];if(!t)continue;
      const vi=world.tv[y][x]||0;
      const px2=Math.floor(sx(x)),py2=Math.floor(sy(y));
      const cs=Math.ceil(sx(x+1))-px2;
      ctx.fillStyle=t.v[vi%t.v.length];
      ctx.fillRect(px2,py2,cs,cs);
      if(cs<4)continue;
      const hsh=(x*2749+y*3541+vi*13)&0xffff;
      const F=Math.floor;
      if(tname==='WATER'){
        const rawDepth=(world.depth[y]&&world.depth[y][x]!=null)?world.depth[y][x]:0;
        const depth01=Math.max(0,Math.min(1,1-rawDepth));
        const T2=_frameNow;
        const S1=0.0020*(S?S.waveSpeed/100:1);
        const S2=0.0014*(S?S.waveSpeed/100:1);
        const _wi=(S&&!S.waves)?0:(S?S.waveIntensity/100:1);
        const wave=(Math.sin((x*0.55+y*0.22-T2*S1)*Math.PI*2)*0.65
                   +Math.sin((x*0.18+y*0.60-T2*S2)*Math.PI*2)*0.35)*_wi;
        const wAmp=0.10+depth01*0.40;
        const waveT=(wave+1)*0.5;
        const shading=depth01+wave*wAmp*0.5;
        const [br,bg,bb]=waterBaseRGB(Math.max(0,Math.min(1,shading)));
        ctx.fillStyle=`rgb(${br},${bg},${bb})`;
        ctx.fillRect(px2,py2,cs,cs);
        if(cs>=4&&depth01>0.35&&waveT>0.78){
          const foamStr=Math.min(1,(waveT-0.78)/0.22)*Math.min(1,(depth01-0.35)/0.35);
          const fh=Math.max(1,Math.floor(cs*(0.09+foamStr*0.10)));
          const fr=Math.round(br+(255-br)*foamStr*0.7);
          const fg_=Math.round(bg+(240-bg)*foamStr*0.7);
          const fb=Math.round(bb+(255-bb)*foamStr*0.7);
          ctx.fillStyle=`rgb(${fr},${fg_},${fb})`;
          ctx.fillRect(px2+Math.floor(cs*0.06),py2+Math.floor(cs*0.30),Math.floor(cs*0.88),fh);
          if(cs>=8&&foamStr>0.5){
            ctx.fillStyle='#d8f0ff';
            ctx.fillRect(px2+Math.floor(cs*0.20),py2+Math.floor(cs*0.28)-1,Math.floor(cs*0.60),Math.max(1,Math.floor(fh*0.45)));
          }
        }
      }else if(tname==='MOUNTAIN'){
        const lk=t.lite,dk=t.dark,dkk=t.dkk;
        ctx.fillStyle=lk;ctx.fillRect(px2,py2,F(cs*.56),F(cs*.50));
        ctx.fillStyle=dk;ctx.fillRect(px2+F(cs*.50),py2+F(cs*.18),F(cs*.50),F(cs*.82));
        ctx.fillStyle=dkk;ctx.fillRect(px2,py2+F(cs*.70),F(cs*.50),F(cs*.30));
        ctx.fillStyle='#d8d0c8';ctx.fillRect(px2,py2,cs,F(cs*.055));
        if((hsh&7)<3){ctx.fillStyle=dkk;ctx.fillRect(px2+F(cs*(0.28+((hsh>>3)&3)*0.1)),py2+F(cs*.26),F(cs*.06),F(cs*.38));}
      }else if(tname==='SNOW'){
        ctx.fillStyle='#eef8ff';ctx.fillRect(px2,py2,cs,F(cs*.60));
        ctx.fillStyle=t.dark;ctx.fillRect(px2,py2+F(cs*.60),cs,F(cs*.40));
        if((hsh&7)<3){ctx.fillStyle='#ffffff';ctx.fillRect(px2+F(cs*((hsh>>4&7)/8*.70+0.08)),py2+F(cs*((hsh>>8&3)/4*.50+0.04)),Math.max(1,F(cs*.1)),Math.max(1,F(cs*.1)));}
      }else if(tname==='LAVA'){
        const lt=Math.floor(_frameNow/210)%3;
        ctx.fillStyle=['#f04820','#e03010','#d82008'][lt];ctx.fillRect(px2,py2,cs,cs);
        if((hsh&3)<2){ctx.fillStyle=t.dkk;ctx.fillRect(px2+F(cs*((hsh&7)/8*.44)),py2+F(cs*(((hsh>>3)&7)/8*.44)),F(cs*.43),F(cs*.38));}
        ctx.fillStyle='#ffcc00';ctx.fillRect(px2+F(cs*((hsh>>6&7)/8*.50+0.10)),py2+F(cs*.45),F(cs*.42),1);
      }else if(tname==='MARSH'){
        if(cs>=5&&(hsh&3)<3){ctx.fillStyle='#1c5878';ctx.fillRect(px2+F(cs*((hsh&7)/8*.40+0.12)),py2+F(cs*(((hsh>>3)&7)/8*.30+0.32)),F(cs*.38),F(cs*.22));}
        if(cs>=10){
          const rx=F(cs*(((hsh>>6)&7)/8*.65+0.13));
          ctx.fillStyle=t.dkk;ctx.fillRect(px2+rx,py2+F(cs*.08),1,F(cs*.74));
          ctx.fillStyle=t.lite;ctx.fillRect(px2+rx+1,py2+F(cs*.08),1,F(cs*.30));
        }
      }
    }

    // ‚ïê‚ïê PASS 2 ‚Äî Edge shading ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if(c>=3){
      const E=Math.max(1,Math.round(c/7));
      const E2=Math.max(1,Math.round(c/14));
      for(let y=y0;y<y1;y++)for(let x=x0;x<x1;x++){
        const tname=gt(x,y);if(!TER[tname])continue;
        const px2=Math.floor(sx(x)),py2=Math.floor(sy(y));
        const cs=Math.ceil(sx(x+1))-px2;
        const myP=tpri(tname);
        const nT=gt(x,y-1),nB=gt(x,y+1),nL=gt(x-1,y),nR=gt(x+1,y);
        const pT=tpri(nT),pB=tpri(nB),pL=tpri(nL),pR=tpri(nR);
        const hiCol=tlite(tname),shCol=tdark(tname),dkCol=tdkk(tname);
        if(nT&&nT!==tname){
          if(myP>pT){ctx.fillStyle=hiCol;ctx.fillRect(px2,py2,cs,E);if(E2>0){ctx.fillStyle=tbase(tname);ctx.fillRect(px2,py2+E,cs,E2);}}
          else{ctx.fillStyle=shCol;ctx.fillRect(px2,py2,cs,E);}
        }
        if(nB&&nB!==tname){
          if(myP>pB){ctx.fillStyle=dkCol;ctx.fillRect(px2,py2+cs-E,cs,E);if(E2>0){ctx.fillStyle=shCol;ctx.fillRect(px2,py2+cs-E-E2,cs,E2);}}
          else{ctx.fillStyle=hiCol;ctx.fillRect(px2,py2+cs-E,cs,E);}
        }
        if(nL&&nL!==tname){
          if(myP>pL){ctx.fillStyle=hiCol;ctx.fillRect(px2,py2,E,cs);}
          else{ctx.fillStyle=shCol;ctx.fillRect(px2,py2,E,cs);}
        }
        if(nR&&nR!==tname){
          if(myP>pR){ctx.fillStyle=dkCol;ctx.fillRect(px2+cs-E,py2,E,cs);}
          else{ctx.fillStyle=hiCol;ctx.fillRect(px2+cs-E,py2,E,cs);}
        }
        // Corner cuts
        const nTL=gt(x-1,y-1),nTR=gt(x+1,y-1),nBR=gt(x+1,y+1),nBL=gt(x-1,y+1);
        function tcol(tn){const t=TER[tn];if(!t)return null;return t.v[Math.floor(t.v.length/2)]||t.color;}
        if(nT&&nT!==tname&&nL&&nL!==tname){const col=tcol(nTL)||tcol(nT);if(col){ctx.fillStyle=col;ctx.fillRect(px2,py2,E,E);}}
        if(nT&&nT!==tname&&nR&&nR!==tname){const col=tcol(nTR)||tcol(nT);if(col){ctx.fillStyle=col;ctx.fillRect(px2+cs-E,py2,E,E);}}
        if(nB&&nB!==tname&&nR&&nR!==tname){const col=tcol(nBR)||tcol(nB);if(col){ctx.fillStyle=col;ctx.fillRect(px2+cs-E,py2+cs-E,E,E);}}
        if(nB&&nB!==tname&&nL&&nL!==tname){const col=tcol(nBL)||tcol(nB);if(col){ctx.fillStyle=col;ctx.fillRect(px2,py2+cs-E,E,E);}}
        // Water foam strip
        if(tname==='WATER'&&cs>=6){
          const ft=Math.floor(_frameNow/500)%2;
          if(ft===0){
            ctx.fillStyle=tlite('WATER');
            if(nT&&nT!=='WATER')ctx.fillRect(px2+E,py2+E,cs-E*2,1);
            if(nL&&nL!=='WATER')ctx.fillRect(px2+E,py2+E,1,cs-E*2);
          }
        }
      }
    }

    // ‚ïê‚ïê WEATHER ‚Äî drawn on 2D canvas (handled by PixiJS filters for fog) ‚ïê‚ïê
    if((weather.type==='rain'||weather.type==='storm')&&c>=1){
      const isStorm=weather.type==='storm';
      const T2=_frameNow;
      if(isStorm){ctx.fillStyle='rgba(40,55,90,0.18)';ctx.fillRect(0,0,W,H);}
      const angle=isStorm?0.38:0.18;
      const layers=isStorm?
        [[0.55,9, 5,0.22,1,0.0],[0.85,7, 9,0.42,1,0.1],[1.30,5,14,0.72,2,0.2]]:
        [[0.40,13,4,0.18,1,0.0],[0.70,11,6,0.32,1,0.08],[1.00,8, 9,0.55,1,0.14]];
      layers.forEach(([spd,sp,dropH,alpha,w2,splashP],li)=>{
        const scrollY=(T2*0.22*spd)%(sp*2);
        const scrollX=(T2*0.22*spd*angle)%(sp*2);
        ctx.save();ctx.globalAlpha=alpha;
        ctx.fillStyle=isStorm?'#7888b8':'#90a8c8';
        const extLeft=Math.ceil(H*angle)+sp*2;
        for(let bx=-extLeft;bx<W+sp;bx+=sp){
          const jx=((bx*2749+li*3541)^(bx*57+li*131))&0xff;
          const jy=((bx*1619+li*7331)^(bx*131+li*57))&0xff;
          const cx2=bx+(jx%Math.floor(sp*0.5))-(sp*0.2);
          for(let by=-dropH*2;by<H+dropH;by+=sp*2){
            const cy2=by+(jy%sp);
            const rx2=cx2+scrollX+(cy2*angle);
            const ry2=((cy2+scrollY)%(H+dropH*2))-dropH;
            if(ry2<-dropH||ry2>H+4)continue;
            const steps=Math.max(1,Math.round(dropH/3));
            for(let s=0;s<steps;s++){
              const frac=s/steps;
              const sx2=Math.round(rx2+dropH*angle*frac);
              const sy2=Math.round(ry2+s*3);
              ctx.fillRect(sx2,sy2,w2,3);
            }
            if(splashP>0&&ry2+dropH>H*0.7&&Math.random()<splashP*0.012){
              const sx2=Math.round(rx2+dropH*angle);
              const sy2=Math.min(H-1,Math.round(ry2+dropH));
              ctx.fillRect(sx2-3,sy2,2,1);ctx.fillRect(sx2+2,sy2,2,1);ctx.fillRect(sx2-1,sy2-1,1,1);
            }
          }
        }
        ctx.restore();
      });
    }
    if(weather.type==='fog'){
      // Fog handled by PixiJS BlurFilter on _worldContainer ‚Äî just draw haze overlay
      const T2=_frameNow;
      const bands=[[0.000060,0.38,H*0.12,'rgba(185,200,215,0.22)'],[0.000038,0.55,H*0.45,'rgba(170,188,205,0.16)'],[0.000022,0.72,H*0.78,'rgba(160,178,198,0.12)']];
      bands.forEach(([spd,yscale,yOff,col])=>{
        const drift=(T2*spd*W)%W;ctx.fillStyle=col;
        for(let rep=0;rep<2;rep++){const bx=(-drift+rep*W)%W-W*0.1;ctx.fillRect(bx,yOff,W*1.2,H*yscale*0.5);ctx.fillRect(bx+W*0.3,yOff+H*yscale*0.08,W*0.9,H*yscale*0.3);}
      });
      ctx.fillStyle='rgba(185,200,215,0.14)';ctx.fillRect(0,0,W,H);
    }
    if(season===3){
      const T2=_frameNow;
      [{n:60,spd:0.030,drift:0.012,sz:1,alpha:0.55},{n:35,spd:0.055,drift:0.022,sz:2,alpha:0.70},{n:15,spd:0.090,drift:0.038,sz:3,alpha:0.85}]
      .forEach(({n,spd,drift,sz,alpha},li)=>{
        ctx.save();ctx.globalAlpha=alpha;ctx.fillStyle='#d8eef8';
        for(let i=0;i<n;i++){
          const h1=(i*1619+li*3541+7)>>>0,h2=(i*2749+li*7331+13)>>>0;
          const baseX=(h1%10000)/10000*W,baseY=(h2%10000)/10000*H;
          const driftX=Math.sin(T2*drift*0.001+i*1.3)*W*0.04;
          const fx=(baseX+driftX+T2*drift*0.08)%W;
          const fy=(baseY+T2*spd)%(H+sz*4)-sz*2;
          ctx.fillRect(Math.round(fx),Math.round(fy),sz,sz);
          if(sz>=2)ctx.fillRect(Math.round(fx)-1,Math.round(fy)+Math.floor(sz/2),sz+2,1);
        }
        ctx.restore();
      });
    }

    // ‚ïê‚ïê PATHS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if(c>=2)world.paths.forEach(p=>{
      if(p.x<x0||p.x>x1||p.y<y0||p.y>y1)return;
      const worn=p.worn,op=Math.min(0.9,0.2+worn/18);
      ctx.fillStyle=`rgba(152,108,52,${op})`;ctx.fillRect(sx(p.x),sy(p.y),c,c);
      if(worn>8&&c>=4){ctx.fillStyle=`rgba(176,138,82,${op*0.6})`;ctx.fillRect(sx(p.x)+c*.2,sy(p.y)+c*.2,c*.6,c*.6);}
    });

    // ‚ïê‚ïê SETTLEMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    world.settlements.forEach(s=>{
      const cx2=sx(s.x)+c/2,cy2=sy(s.y)+c/2,r=s.radius*c;
      const rc=['rgba(140,140,120,.4)','rgba(80,160,80,.4)','rgba(200,175,0,.4)','rgba(200,100,0,.45)','rgba(120,60,200,.5)','rgba(180,40,40,.55)','rgba(220,220,255,.7)'];
      const ln=['Hamlet','Village','Town','City','Large City','Metropolis','Capital'];
      ctx.strokeStyle=rc[s.level-1];ctx.lineWidth=s.level>=5?3:2;ctx.setLineDash(s.level>=6?[]:[4,4]);
      ctx.beginPath();ctx.arc(cx2,cy2,r,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);
      if(c>=1.5)s.tradeRoutes.forEach(o=>{ctx.strokeStyle='rgba(200,170,60,0.2)';ctx.lineWidth=1;ctx.setLineDash([3,6]);ctx.beginPath();ctx.moveTo(cx2,cy2);ctx.lineTo(sx(o.x)+c/2,sy(o.y)+c/2);ctx.stroke();ctx.setLineDash([]);});
      ctx.fillStyle='rgba(200,175,0,.8)';ctx.fillRect(sx(s.x)+c*.1,sy(s.y)+c*.1,c*.8,c*.8);
      if(c>=3){
        const fs=Math.max(9,Math.min(13,c));
        ctx.font=`bold ${fs}px Cinzel, serif`;
        const label=s.name+(c>=5?` [${ln[s.level-1]}]`:'');
        const tw=ctx.measureText(label).width;
        ctx.fillStyle='rgba(0,0,0,0.82)';ctx.fillRect(cx2-tw/2-4,cy2-r-19,tw+8,15);
        ctx.fillStyle=rc[s.level-1].replace(/[\d.]+\)$/,'1)');ctx.fillText(label,cx2-tw/2,cy2-r-7);
      }
      if(s.faith>20){ctx.strokeStyle=`rgba(255,215,0,${s.faith/400})`;ctx.lineWidth=s.faith/30;ctx.beginPath();ctx.arc(cx2,cy2,r*.3,0,Math.PI*2);ctx.stroke();}
    });

    // ‚ïê‚ïê TREES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    world.trees.forEach(t=>{
      if(t.x<x0||t.x>x1||t.y<y0||t.y>y1)return;
      const px=Math.round(sx(t.x)),py=Math.round(sy(t.y));
      const cs=Math.round(sx(t.x+1))-px;
      const F=Math.floor;
      const stage=t.stage;
      if(t.onFire){
        ctx.fillStyle='#c03000';ctx.fillRect(px,py,cs,cs);
        ctx.fillStyle='#e86000';ctx.fillRect(px+F(cs*.2),py+F(cs*.1),F(cs*.6),F(cs*.6));
        ctx.fillStyle='#f8c000';ctx.fillRect(px+F(cs*.35),py+F(cs*.2),F(cs*.3),F(cs*.3));
        return;
      }
      const isA=season===2,isW=season===3;
      const shadow=isA?'#5c3808':isW?'#2a3820':'#355e18';
      const mid=isA?'#8a5010':isW?'#3a5030':'#5a9428';
      const hi=isA?'#b87020':isW?'#4e6840':'#7ab648';
      const tip=isA?'#d09030':isW?'#607850':'#9ad050';
      const tkMain='#7a4a1a',tkDark='#4a2a0a',tkLight='#9a6030';
      if(stage===0){
        if(cs<3){ctx.fillStyle=mid;ctx.fillRect(px,py,Math.max(1,cs),Math.max(1,cs));return;}
        ctx.fillStyle=tkMain;ctx.fillRect(px+F(cs*.44),py+F(cs*.55),F(cs*.12),F(cs*.45));
        ctx.fillStyle=mid;ctx.fillRect(px+F(cs*.30),py+F(cs*.28),F(cs*.40),F(cs*.34));
        ctx.fillStyle=hi;ctx.fillRect(px+F(cs*.32),py+F(cs*.28),F(cs*.22),F(cs*.20));
        ctx.fillStyle=tip;ctx.fillRect(px+F(cs*.33),py+F(cs*.29),F(cs*.10),F(cs*.10));
        return;
      }
      if(stage===1){
        if(cs<3){ctx.fillStyle='#4a7820';ctx.fillRect(px,py,Math.max(2,cs),Math.max(2,cs));return;}
        ctx.fillStyle='#1a220a';ctx.fillRect(px+F(cs*.20),py+F(cs*.87),F(cs*.60),F(cs*.08));
        ctx.fillStyle=tkMain;ctx.fillRect(px+F(cs*.41),py+F(cs*.68),F(cs*.18),F(cs*.32));
        ctx.fillStyle=tkDark;ctx.fillRect(px+F(cs*.41),py+F(cs*.68),F(cs*.06),F(cs*.32));
        [[0.18,0.08,0.64,0.46],[0.06,0.36,0.50,0.40]].forEach(([bx,by,bw2,bh2])=>{
          const x1=px+F(cs*bx),y1=py+F(cs*by),w1=F(cs*bw2),h1=F(cs*bh2);
          ctx.fillStyle=shadow;ctx.fillRect(x1,y1,w1,h1);
          ctx.fillStyle=mid;ctx.fillRect(x1,y1,w1,F(h1*.75));
          ctx.fillStyle=hi;ctx.fillRect(x1,y1,F(w1*.55),F(h1*.60));
          ctx.fillStyle=tip;ctx.fillRect(x1+F(cs*.01),y1+F(cs*.01),F(w1*.28),F(h1*.28));
        });
        ctx.fillStyle=shadow;ctx.fillRect(px+F(cs*.80),py+F(cs*.08),F(cs*.04),F(cs*.68));ctx.fillRect(px+F(cs*.04),py+F(cs*.72),F(cs*.80),F(cs*.04));
        return;
      }
      if(cs<3){ctx.fillStyle='#4a7820';ctx.fillRect(px,py,Math.max(2,cs),Math.max(2,cs));return;}
      const sc=stage===3?1.05:1.0;
      ctx.fillStyle='#1a220a';ctx.fillRect(px+F(cs*.15),py+F(cs*.84),F(cs*.72),F(cs*.1));
      ctx.fillStyle=tkMain;ctx.fillRect(px+F(cs*.38),py+F(cs*.65),F(cs*.22),F(cs*.35));
      ctx.fillStyle=tkDark;ctx.fillRect(px+F(cs*.38),py+F(cs*.65),F(cs*.07),F(cs*.35));
      ctx.fillStyle=tkLight;ctx.fillRect(px+F(cs*.38),py+F(cs*.65),F(cs*.07),F(cs*.08));
      ctx.fillStyle=tkMain;ctx.fillRect(px+F(cs*.32),py+F(cs*.84),F(cs*.34),F(cs*.1));
      ctx.fillStyle=tkDark;ctx.fillRect(px+F(cs*.32),py+F(cs*.84),F(cs*.08),F(cs*.1));
      if(stage===3){ctx.fillStyle=tkDark;ctx.fillRect(px+F(cs*.34),py+F(cs*.72),F(cs*.04),F(cs*.18));ctx.fillRect(px+F(cs*.58),py+F(cs*.75),F(cs*.04),F(cs*.15));}
      [[0.15,0.04,0.70*sc,0.52*sc],[0.02,0.32,0.52*sc,0.44*sc],[0.44,0.32,0.52*sc,0.44*sc]].forEach(([bx,by,bw2,bh2])=>{
        const x1=px+F(cs*bx),y1=py+F(cs*by),w1=F(cs*bw2),h1=F(cs*bh2);
        ctx.fillStyle=shadow;ctx.fillRect(x1,y1,w1,h1);
        ctx.fillStyle=mid;ctx.fillRect(x1,y1,w1,F(h1*.75));
        ctx.fillStyle=hi;ctx.fillRect(x1,y1,F(w1*.55),F(h1*.60));
        ctx.fillStyle=tip;ctx.fillRect(x1+F(cs*.01),y1+F(cs*.01),F(w1*.28),F(h1*.28));
      });
      ctx.fillStyle=shadow;ctx.fillRect(px+F(cs*.82),py+F(cs*.04),F(cs*.04),F(cs*.72));ctx.fillRect(px+F(cs*.02),py+F(cs*.72),F(cs*.84),F(cs*.04));
    });

    // ‚ïê‚ïê STONES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    world.stones.forEach(s=>{
      if(s.x<x0||s.x>x1||s.y<y0||s.y>y1)return;
      const px=sx(s.x),py=sy(s.y);
      ctx.fillStyle='rgba(0,0,0,0.18)';ctx.fillRect(px+c*.1,py+c*.7,c*.9,c*.3);
      ctx.fillStyle=s.amount<=2?'#8a6050':'#787068';ctx.fillRect(px+c*.1,py+c*.3,c*.8,c*.6);
      ctx.fillStyle=s.amount<=2?'#6a4040':'#605a50';ctx.fillRect(px+c*.5,py+c*.15,c*.45,c*.5);
      ctx.fillStyle='rgba(255,255,255,0.18)';ctx.fillRect(px+c*.15,py+c*.33,c*.22,c*.12);
    });

    // ‚ïê‚ïê ANIMALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    world.animals.forEach(a=>{
      if(!a||a.x<x0||a.x>x1||a.y<y0||a.y>y1)return;
      const px=sx(a.x),py=sy(a.y);
      if(c<3){ctx.fillStyle=a.type==='wolf'?'#5a4a38':'#b8986a';ctx.fillRect(px,py,Math.max(2,c),Math.max(2,c));return;}
      if(a.type==='deer'){ctx.fillStyle='#c09060';ctx.fillRect(px+c*.2,py+c*.35,c*.65,c*.4);ctx.fillStyle='#b88858';ctx.fillRect(px+c*.7,py+c*.2,c*.28,c*.25);ctx.fillStyle='#a07848';ctx.fillRect(px+c*.25,py+c*.7,c*.1,c*.3);ctx.fillRect(px+c*.45,py+c*.7,c*.1,c*.3);ctx.fillRect(px+c*.62,py+c*.7,c*.1,c*.3);ctx.fillStyle='#7a5030';ctx.fillRect(px+c*.73,py+c*.08,c*.04,c*.14);ctx.fillRect(px+c*.83,py+c*.08,c*.04,c*.14);ctx.fillRect(px+c*.7,py+c*.08,c*.17,c*.04);}
      else{ctx.fillStyle='#5a5048';ctx.fillRect(px+c*.15,py+c*.35,c*.7,c*.38);ctx.fillStyle='#4a4038';ctx.fillRect(px+c*.72,py+c*.22,c*.26,c*.22);ctx.fillStyle='#3a3028';ctx.fillRect(px+c*.2,py+c*.7,c*.1,c*.28);ctx.fillRect(px+c*.4,py+c*.7,c*.1,c*.28);ctx.fillRect(px+c*.6,py+c*.7,c*.1,c*.28);ctx.fillStyle='#e03020';ctx.fillRect(px+c*.76,py+c*.26,c*.06,c*.06);}
    });

    // ‚ïê‚ïê CROPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if(world.crops&&c>=2){
      world.crops.forEach(cr=>{
        if(cr.x<x0||cr.x>x1||cr.y<y0||cr.y>y1)return;
        const cpx=Math.floor(sx(cr.x)),cpy=Math.floor(sy(cr.y));
        const cs2=Math.ceil(sx(cr.x+1))-cpx;
        const progress=cr.maxStage>0?cr.stage/cr.maxStage:0;
        ctx.fillStyle=progress===0?'#5a3410':'#4a2c0e';ctx.fillRect(cpx,cpy,cs2,cs2);
        if(progress>0.05){
          const h=Math.floor(cs2*(0.15+progress*0.65));
          const green=progress>0.8?'#70c020':progress>0.4?'#58a818':'#3a8010';
          const stem=progress>0.8?'#508010':progress>0.4?'#387008':'#256006';
          ctx.fillStyle=stem;ctx.fillRect(cpx+Math.floor(cs2*.42),cpy+cs2-h,Math.floor(cs2*.16),h);
          const headH=Math.floor(h*.4);
          ctx.fillStyle=green;ctx.fillRect(cpx+Math.floor(cs2*.28),cpy+cs2-h,Math.floor(cs2*.44),headH);
          if(progress>0.8){ctx.fillStyle='#f0d040';ctx.fillRect(cpx+Math.floor(cs2*.36),cpy+cs2-h-Math.floor(cs2*.06),Math.floor(cs2*.28),Math.floor(cs2*.08));}
        }
        if(progress>=1){ctx.fillStyle='#f8e040';ctx.fillRect(cpx,cpy,cs2,1);ctx.fillRect(cpx,cpy,1,cs2);}
      });
    }

    // ‚ïê‚ïê BUILDINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    world.buildings.forEach(b=>{
      const bw2=b.w||1,bh2=b.h||1;
      if(b.x+bw2<x0||b.x>x1||b.y+bh2<y0||b.y>y1)return;
      drawBuilding(b,sx(b.x),sy(b.y),c);
    });

    // ‚ïê‚ïê FIRES ‚Äî drawn on 2D canvas; bloom added by PixiJS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Draw fires on 2D canvas
    world.fires.forEach(f=>{
      if(!f||f.x<x0||f.x>x1||f.y<y0||f.y>y1)return;
      const fpx=sx(f.x),fpy=sy(f.y);
      ctx.fillStyle=f.life>50?'#e85000':f.life>25?'#c84000':'#a03000';
      ctx.fillRect(fpx+c*.15,fpy+c*.15,c*.7,c*.85);
      ctx.fillStyle=f.life>50?'#f87800':'#c04000';
      ctx.fillRect(fpx+c*.28,fpy,c*.44,c*.55);
      ctx.fillStyle='#f0b000';ctx.fillRect(fpx+c*.36,fpy+c*.1,c*.28,c*.28);
      ctx.fillStyle='#fff8a0';ctx.fillRect(fpx+c*.42,fpy+c*.08,c*.16,c*.16);
    });
    // PixiJS bloom layer ‚Äî additive glowing halos for fires
    _gBloom.clear();
    const _hasFires=world.fires.some(f=>f&&f.x>=x0&&f.x<=x1&&f.y>=y0&&f.y<=y1);
    if(_hasFires){
      world.fires.forEach(f=>{
        if(!f||f.x<x0||f.x>x1||f.y<y0||f.y>y1)return;
        const fpx=sx(f.x),fpy=sy(f.y);
        const intensity=f.life>50?1.0:f.life>25?0.7:0.4;
        // Large outer glow
        _gBloom.beginFill(0xff6000,0.12*intensity);
        _gBloom.drawRect(fpx-c*.8,fpy-c*.8,c*2.6,c*2.6);
        _gBloom.endFill();
        // Tighter warm halo
        _gBloom.beginFill(0xff8800,0.22*intensity);
        _gBloom.drawRect(fpx-c*.3,fpy-c*.3,c*1.6,c*1.6);
        _gBloom.endFill();
        // Bright core
        _gBloom.beginFill(0xffdd00,0.35*intensity);
        _gBloom.drawRect(fpx+c*.2,fpy+c*.1,c*.6,c*.5);
        _gBloom.endFill();
      });
      // Also bloom for lava tiles
      for(let y=y0;y<y1;y++)for(let x=x0;x<x1;x++){
        if(gt(x,y)==='LAVA'){
          const px2=Math.floor(sx(x)),py2=Math.floor(sy(y)),cs=Math.ceil(sx(x+1))-px2;
          _gBloom.beginFill(0xff3800,0.08);_gBloom.drawRect(px2-2,py2-2,cs+4,cs+4);_gBloom.endFill();
        }
      }
    }

    // ‚ïê‚ïê ENTITIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    world.entities.forEach(e=>{
      if(!e)return;
      const lerpSpeed=0.18;
      e.rx=e.rx+(e.x-e.rx)*lerpSpeed;
      e.ry=e.ry+(e.y-e.ry)*lerpSpeed;
      if(Math.abs(e.rx-e.x)<0.01)e.rx=e.x;
      if(Math.abs(e.ry-e.y)<0.01)e.ry=e.y;
      if(e.rx<x0-1||e.rx>x1+1||e.ry<y0-1||e.ry>y1+1)return;
      e._selected=(e===selectedEntity);
      e.draw(sx(e.rx),sy(e.ry),c);
    });

    // Name tag for selected entity
    if(selectedEntity&&selectedEntity.health>0&&c>=5){
      const ex=sx(selectedEntity.rx??selectedEntity.x),ey=sy(selectedEntity.ry??selectedEntity.y);
      const role=ROLES[selectedEntity.profession]||ROLES['none'];
      ctx.font='bold 10px Cinzel, serif';
      const tw=ctx.measureText(selectedEntity.name).width;
      ctx.fillStyle='rgba(0,0,0,0.82)';ctx.fillRect(ex+c/2-tw/2-3,ey-14,tw+6,13);
      ctx.fillStyle=role.color;ctx.fillText(selectedEntity.name,ex+c/2-tw/2,ey-4);
    }

    drawMinimap(x0,y0,x1,y1,c);

    // ‚îÄ‚îÄ PixiJS pass ‚Äî upload 2D canvas texture, apply filters, render ‚îÄ
    _baseTexture.update();          // push 2D canvas pixels to GPU
    _applyDayNightFilter();         // set colour matrix + fog blur
    _pApp.renderer.render(_pApp.stage); // composite to screen

    // Update HUD badges
    const sn=['üå∏ Spring','‚òÄ Summer','üçÇ Autumn','‚ùÑ Winter'];
    const wi={clear:'‚òÄ Clear',rain:'üåß Rain',storm:'‚õà Storm',drought:'üåµ Drought',fog:'üå´ Foggy'};
    const dn=['üå§ Day','üåÖ Dusk','üåô Night','üåÑ Dawn'];
    const curZ=Math.round(cam.zoom*100);
    const bSeason=_dom('sBadgeSeason'),bWeather=_dom('sBadgeWeather'),bTime=_dom('sBadgeTime'),bZoom=_dom('sBadgeZoom');
    if(bSeason._v!==season){bSeason.textContent=sn[season];bSeason._v=season;}
    if(bWeather._v!==weather.type){bWeather.textContent=wi[weather.type]||'‚òÄ Clear';bWeather._v=weather.type;}
    if(bTime._v!==dayPhase){bTime.textContent=dn[dayPhase];bTime._v=dayPhase;}
    if(bZoom._v!==curZ){bZoom.textContent=curZ+'%';bZoom._v=curZ;}
  }catch(err){console.error('Render err:',err);}
}
function drawMinimap(x0,y0,x1,y1,c){
  const mw=mmEl.width,mh=mmEl.height,rx=mw/G,ry=mh/G;
  if(minimapDirty){
    minimapDirty=false;
    mmc.fillStyle='#0a1008';mmc.fillRect(0,0,mw,mh);
    for(let y=0;y<G;y+=2)for(let x=0;x<G;x+=2){
      const tn=world.terrain[y]?.[x];const t=TER[tn];if(!t)continue;
      if(tn==='WATER'&&world.depth[y]){
        // Depth-based minimap water colour
        const rawD=world.depth[y][x]??0; // 0=shore, 1=abyss
        // Interpolate shore(38,108,188) ‚Üí abyss(4,12,40)
        const r=Math.round(38+(4-38)*rawD),g=Math.round(108+(12-108)*rawD),b=Math.round(188+(40-188)*rawD);
        mmc.fillStyle=`rgb(${r},${g},${b})`;
      }else{mmc.fillStyle=t.color;}
      mmc.fillRect(x*rx,y*ry,rx*2+1,ry*2+1);
    }
    mmc.fillStyle='rgba(140,100,50,0.5)';world.paths.forEach(p=>{if(p.worn>4)mmc.fillRect(p.x*rx,p.y*ry,rx+1,ry+1);});
    world.trees.forEach(t=>{
      const stage=t.stage;
      mmc.fillStyle=stage===0?'#2a5a20':stage===1?'#2a6a20':stage===3?'#0e3010':'#1e4a18';
      mmc.fillRect(t.x*rx,t.y*ry,rx+(stage>=2?1:0.5),ry+(stage>=2?1:0.5));
    });
    mmc.fillStyle='#a08050';world.animals.filter(a=>a.type==='deer').forEach(a=>mmc.fillRect(a.x*rx,a.y*ry,rx+1,ry+1));
    mmc.fillStyle='#504838';world.animals.filter(a=>a.type==='wolf').forEach(a=>mmc.fillRect(a.x*rx,a.y*ry,rx+1,ry+1));
    world.buildings.forEach(b=>{const bw2=b.w||1,bh2=b.h||1;const buildingColors={house:'#c8b870',farm:'#7a9040',workshop:'#907060',mine:'#605848',library:'#c09030',market:'#b87030',barracks:'#506040',castle:'#a09080',temple:'#d4b840'};mmc.fillStyle=buildingColors[b.type]||'#888070';mmc.fillRect(b.x*rx,b.y*ry,Math.max(2,bw2*rx),Math.max(2,bh2*ry));});
    world.settlements.forEach(s=>{const sz=1+s.level;mmc.fillStyle=['#aaa','#4c4','#fd0','#f80','#a0f','#f44','#fff'][s.level-1];mmc.fillRect(s.x*rx-sz/2,s.y*ry-sz/2,sz,sz);});
    world.entities.forEach(e=>{mmc.fillStyle=e.infected?'#904890':e===selectedEntity?'#ffdd00':(ROLES[e.profession]||ROLES['none']).color;mmc.fillRect(e.x*rx,e.y*ry,rx+1,ry+1);});
  }
  // Always redraw viewport rect (cheap)
  const _pw=_pApp.renderer.width,_ph=_pApp.renderer.height;mmc.strokeStyle='rgba(200,180,100,.9)';mmc.lineWidth=1;mmc.strokeRect(cam.x*rx,cam.y*ry,(_pw/c)*rx,(_ph/c)*ry);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function update(){
  if(speed===0||!world)return;
  try{
    for(let s=0;s<speed;s++){
      tick++;if(tick>=7200){tick=0;year++;}
      updateSeasons();updateWeather();updateDayNight();updateDisease();updateLava();updateMorale();
      world.entities.forEach(e=>e&&e.update());world.entities=world.entities.filter(e=>e&&e.health>0);
      world.settlements.forEach(s=>s&&s.update());world.settlements=world.settlements.filter(s=>s&&s.members.length>0);
      world.trees=world.trees.filter(t=>t&&!t.update());
      // Occasional forest growth notification (rare, ~once per 5 years)
      if(tick%600===0&&world.trees.length>30){
        const saplings=world.trees.filter(t=>t.stage===0).length;
        const mature=world.trees.filter(t=>t.stage>=2).length;
        if(saplings>5&&tick%3600===0)logEvent(`Year ${year} ‚Äî ${saplings} saplings sprouting across the island.`);
        if(mature>50&&tick%7200===0)logEvent(`Year ${year} ‚Äî The forests have grown thick (${mature} mature trees).`);
      }
      world.buildings.forEach(b=>b&&b.update());
      // Crop growth ‚Äî each crop tile advances toward harvest
      if(tick%60===0&&world.crops){
        world.crops.forEach(cr=>{
          if(cr.stage<cr.maxStage){cr.stage++;}
        });
      }
      world.fires=world.fires.filter(f=>{if(!f)return false;f.life--;return f.life>0;});
      world.animals.forEach(a=>a&&a.update());world.animals=world.animals.filter(a=>a&&a.health>0);
      if(world.paths.length>2000){
        world.paths=world.paths.sort((a,b)=>b.worn-a.worn).slice(0,1500);
        // Rebuild pathMap after pruning
        pathMap.clear();world.paths.forEach(p=>pathMap.set(p.x+','+p.y,p));
        minimapDirty=true;
      }
      if(world.food.length<400){
        if(world.trees.length>0){const t=world.trees[rnd(world.trees.length)];addFood(t.x+rnd(7)-3,t.y+rnd(7)-3);}
        if(Math.random()<0.5)addFood(rnd(G),rnd(G));
      }
      // Passive food baseline ‚Äî small settlements get free food to survive early game
      if(world.settlements.length>0&&tick%30===0){
        const pop=world.entities.length;
        if(pop>0&&world.res.food<pop*2){world.res.food+=Math.max(1,Math.floor(pop*0.3));}
      }
      if(Math.random()<0.0005&&world.animals.filter(a=>a.type==='deer').length<60){const x=rnd(G),y=rnd(G);if(TER[world.terrain[y][x]]?.walkable)world.animals.push(new Animal(x,y,'deer'));}
    }
    applyNightOverlay();flushNotifs();
    // Compute infected count once
    _infectedCount=world.entities.filter(e=>e.infected).length;
    const _s=(id,v)=>{const e=_dom(id);if(e)e.textContent=v;};
    const _c=(id,p,v)=>{const e=_dom(id);if(e)e.style[p]=v;};
    _s('sY',year);
    const pop=world.entities.length;_s('sP',pop);_c('sPopBar','width',Math.min(100,pop/2)+'%');
    _s('sS',world.settlements.length);_s('sB',world.buildings.length);
    _s('sW',world.res.wood);_s('sSt',world.res.stone);
    const food=world.res.food;_s('sF',food);_c('sFoodBar','width',Math.min(100,food/4)+'%');
    _s('sT',world.tech);_s('sAnimal',world.animals.length);
    _s('sDisease',diseaseActive?`${diseaseName} (${_infectedCount})`:'None');
    _c('sDisease','color',diseaseActive?'#c06020':'#5a7840');
    _s('sMoraleVal',Math.floor(worldMorale));
    const ageNames=['Age of Dawn','Age of Tribes','Age of Villages','Age of Cities','Age of Kingdoms','Age of Empires','Golden Age'];
    _s('sAgeName',ageNames[Math.min(6,Math.floor(year/80))]);
    minimapDirty=true; // entities moved
  }catch(err){console.error('Update error:',err);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{keys[e.code]=true;if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))e.preventDefault();});
document.addEventListener('keyup',e=>{keys[e.code]=false;});
function panCamera(){
  const spd=(5/cam.zoom)*(S?S.panSpeed/100:1);
  if(keys['ArrowLeft']||keys['KeyA'])cam.x-=spd;if(keys['ArrowRight']||keys['KeyD'])cam.x+=spd;
  if(keys['ArrowUp']||keys['KeyW'])cam.y-=spd;if(keys['ArrowDown']||keys['KeyS'])cam.y+=spd;
  if(keys['Equal']||keys['NumpadAdd'])cam.zoom=Math.min(cam.max,cam.zoom*1.03);
  if(keys['Minus']||keys['NumpadSubtract'])cam.zoom=Math.max(cam.min,cam.zoom/1.03);
  clamp();
}

let drag=false,dsx=0,dsy=0,dcx=0,dcy=0;
// Route mouse/wheel events to Pixi WebGL canvas (canvas 2D overlay has pointer-events:none)
const _evCanvas = _pApp.view; // Pixi WebGL canvas receives all pointer events
_evCanvas.addEventListener('mousedown',e=>{
  if(e.button===1||e.button===2){e.preventDefault();drag=true;dsx=e.clientX;dsy=e.clientY;dcx=cam.x;dcy=cam.y;}
  else if(e.button===0)handleClick(e);
});
_evCanvas.addEventListener('mousemove',e=>{if(drag){const c=cz();cam.x=dcx-(e.clientX-dsx)/c;cam.y=dcy-(e.clientY-dsy)/c;clamp();}});
_evCanvas.addEventListener('mouseup',()=>drag=false);
_evCanvas.addEventListener('mouseleave',()=>drag=false);
_evCanvas.addEventListener('contextmenu',e=>e.preventDefault());
_evCanvas.addEventListener('wheel',e=>{
  e.preventDefault();const wxx=wxf(e.offsetX),wyy=wyf(e.offsetY);
  const zs=S?S.zoomSpeed/100:1;const base=e.deltaY<0?1.15:1/1.15;
  const f=e.deltaY<0?1+(base-1)*zs:1-(1-base)*zs;
  cam.zoom=Math.max(cam.min,Math.min(cam.max,cam.zoom*f));cam.x=wxx-e.offsetX/cz();cam.y=wyy-e.offsetY/cz();clamp();
},{passive:false});
mmEl.addEventListener('click',e=>{
  const r=mmEl.getBoundingClientRect(),mx=(e.clientX-r.left)/mmEl.width*G,my=(e.clientY-r.top)/mmEl.height*G;
  const c=cz();cam.x=mx-_pApp.renderer.width/c/2;cam.y=my-_pApp.renderer.height/c/2;clamp();
});

function handleClick(e){
  if(e.button!==0)return;
  const gx=Math.floor(wxf(e.offsetX)),gy=Math.floor(wyf(e.offsetY));
  if(gx<0||gx>=G||gy<0||gy>=G)return;

  // Always try to inspect on left click when tool is inspect
  // Also inspect on any click if we hit a human regardless of tool
  if(tool==='inspect'||tool==='human'||tool==='heal'||tool==='erase'){
    // Check for entity click (any tool tries to click humans first if nearby)
    const hit=world.entities.find(e=>Math.abs(e.x-gx)<=1&&Math.abs(e.y-gy)<=1);
    if(hit&&(tool==='inspect'||e.shiftKey)){
      openCharCard(hit);
      return;
    }
  }

  switch(tool){
  case'inspect':{const hit=world.entities.find(e=>Math.abs(e.x-gx)<=1&&Math.abs(e.y-gy)<=1);if(hit)openCharCard(hit);break;}
  case'human':if(TER[world.terrain[gy][gx]]?.walkable){const en=new Entity(gx,gy);world.entities.push(en);notify(`üßë ${en.name} enters the world`);}break;
  case'tree':if(world.terrain[gy][gx]==='GRASS'&&!treeMap.has(gx+','+gy))world.trees.push(new Tree(gx,gy));break;
  case'animal':if(TER[world.terrain[gy][gx]]?.walkable){world.animals.push(new Animal(gx,gy,Math.random()<0.7?'deer':'wolf'));}break;
  case'fire':world.fires.push({x:gx,y:gy,life:80});{const t=treeMap.get(gx+','+gy);if(t){t.onFire=true;t.fireLife=0;}}break;
  case'lightning':world.entities.filter(e=>mdist(e.x,e.y,gx,gy)<3).forEach(e=>e.health-=50);for(let i=0;i<6;i++)world.fires.push({x:gx+rnd(5)-2,y:gy+rnd(5)-2,life:50});notify('‚ö° Lightning!','danger');break;
  case'meteor':
    for(let dy=-5;dy<=5;dy++)for(let dx=-5;dx<=5;dx++){if(Math.sqrt(dx*dx+dy*dy)>5)continue;const mx=gx+dx,my=gy+dy;if(mx<0||mx>=G||my<0||my>=G)continue;if(Math.random()<.5)world.fires.push({x:mx,y:my,life:90});
      const k=mx+','+my;if(treeMap.has(k)){treeMap.delete(k);}
      world.trees=world.trees.filter(t=>t.x!==mx||t.y!==my);world.entities.filter(e=>e.x===mx&&e.y===my).forEach(e=>e.health=0);world.buildings=world.buildings.filter(b=>b.x!==mx||b.y!==my);setT(mx,my,world.terrain[my][mx]==='WATER'?'WATER':'SAND');}
    notify('‚òÑ Meteor!','danger');logEvent(`Year ${year} ‚Äî A meteor strikes!`);minimapDirty=true;break;
  case'flood':
    for(let dy=-8;dy<=8;dy++)for(let dx=-8;dx<=8;dx++){if(Math.sqrt(dx*dx+dy*dy)>8)continue;const mx=gx+dx,my=gy+dy;if(mx<0||mx>=G||my<0||my>=G)continue;if(Math.random()<0.7){setT(mx,my,'WATER');world.entities.filter(e=>e.x===mx&&e.y===my).forEach(e=>e.health-=60);const k=mx+','+my;if(treeMap.has(k))treeMap.delete(k);world.trees=world.trees.filter(t=>!(t.x===mx&&t.y===my));world.buildings=world.buildings.filter(b=>!(b.x===mx&&b.y===my));}}
    notify('üåä Flood!','danger');logEvent(`Year ${year} ‚Äî A great flood!`);minimapDirty=true;break;
  case'plague':
    world.entities.filter(e=>mdist(e.x,e.y,gx,gy)<10).forEach(e=>{if(Math.random()<0.6)e.infected=true;});
    if(!diseaseActive){diseaseActive=true;diseaseName=DN[rnd(DN.length)];diseaseSeverity=1.0+Math.random();}
    notify(`ü¶† ${diseaseName} unleashed!`,'danger');logEvent(`Year ${year} ‚Äî ${diseaseName} unleashed!`);break;
  case'volcano':
    setT(gx,gy,'MOUNTAIN');for(let i=0;i<12;i++){const angle=Math.random()*Math.PI*2,dist=2+rnd(6);const lx=Math.floor(gx+Math.cos(angle)*dist),ly=Math.floor(gy+Math.sin(angle)*dist);if(lx>=0&&lx<G&&ly>=0&&ly<G){setT(lx,ly,'LAVA');world.lavaFlows.push({x:lx,y:ly,life:120+rnd(80)});}}
    for(let i=0;i<10;i++)world.fires.push({x:gx+rnd(11)-5,y:gy+rnd(11)-5,life:100});
    notify('üåã Volcano erupts!','danger');logEvent(`Year ${year} ‚Äî Volcano erupts!`);break;
  case'heal':
    world.entities.filter(e=>mdist(e.x,e.y,gx,gy)<8).forEach(e=>{e.health=100;e.hunger=0;e.tiredness=0;e.infected=false;e.lifeEvents.push(`Year ${year}: Healed by divine power.`);});
    world.res.food+=25;worldMorale=Math.min(100,worldMorale+15);notify('üíö Divine healing!','good');break;
  case'rain':weather.type='rain';weather.intensity=0.8;weather.ticks=200;world.res.food+=10;notify('üåß Rain granted','good');break;
  case'fertility':for(let i=0;i<20;i++)addFood(gx+rnd(15)-7,gy+rnd(15)-7);for(let i=0;i<8;i++){const tx2=gx+rnd(13)-6,ty2=gy+rnd(13)-6;if(tx2>=0&&tx2<G&&ty2>=0&&ty2<G&&world.terrain[ty2][tx2]==='GRASS')world.trees.push(new Tree(tx2,ty2));}notify('üåæ Fertility granted','good');break;
  case'inspire':
    world.entities.filter(e=>mdist(e.x,e.y,gx,gy)<10).forEach(e=>{e.int=Math.min(100,e.int+20);e.wis=Math.min(100,(e.wis||50)+10);e.lifeEvents.push(`Year ${year}: Touched by divine inspiration.`);});
    world.res.knowledge+=10;world.tech=Math.min(10,world.tech+1);
    notify('‚ú® Inspiration flows!','good');logEvent(`Year ${year} ‚Äî Divine inspiration!`);break;
  case'tGrass':setT(gx,gy,'GRASS');minimapDirty=true;break;
  case'tWater':setT(gx,gy,'WATER');minimapDirty=true;break;
  case'tSand':setT(gx,gy,'SAND');minimapDirty=true;break;
  case'tMtn':setT(gx,gy,'MOUNTAIN');minimapDirty=true;break;
  case'tLava':setT(gx,gy,'LAVA');minimapDirty=true;break;
  case'erase':
    world.entities=world.entities.filter(e=>e.x!==gx||e.y!==gy);
    const erasedB=world.buildings.filter(b=>b.x===gx&&b.y===gy);
    erasedB.forEach(b=>{if(b.type==='farm'&&world.crops)world.crops=world.crops.filter(cr=>cr.farmId!==b.id);});
    world.buildings=world.buildings.filter(b=>b.x!==gx||b.y!==gy);
    {const k=gx+','+gy;if(treeMap.has(k))treeMap.delete(k);if(foodSet.has(k))foodSet.delete(k);if(pathMap.has(k))pathMap.delete(k);}
    world.trees=world.trees.filter(t=>t.x!==gx||t.y!==gy);world.food=world.food.filter(f=>f.x!==gx||f.y!==gy);world.animals=world.animals.filter(a=>a.x!==gx||a.y!==gy);world.paths=world.paths.filter(p=>p.x!==gx||p.y!==gy);
    minimapDirty=true;break;
  }
}

document.querySelectorAll('.tool-btn[data-tool]').forEach(btn=>btn.addEventListener('click',()=>{
  document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');tool=btn.dataset.tool;
}));

// Mouse wheel scrolls the toolbar horizontally
(function(){
  const tg=document.getElementById('toolGroups');
  tg.addEventListener('wheel',ev=>{ev.preventDefault();tg.scrollLeft+=ev.deltaY||ev.deltaX;},{passive:false});
})();
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN MENU & SAVE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAX_SAVES=6;
const SAVE_KEY='worldsandbox_saves';

function getSaves(){
  try{return JSON.parse(localStorage.getItem(SAVE_KEY))||[];}catch{return[];}
}
function putSaves(arr){
  try{localStorage.setItem(SAVE_KEY,JSON.stringify(arr));}catch(e){notify('‚ö† Save failed (storage full?)','danger');}
}

function saveWorld(slotIndex){
  if(!world)return;
  const saves=getSaves();
  // Trim entities/trees/etc to just the data we need (no circular refs)
  const snap={
    name:worldName,seed:worldSeed,
    savedAt:new Date().toLocaleString(),
    year,season,seasonTick,dayTick,dayPhase,tick,
    worldMorale,weather:{...weather},
    diseaseActive,diseaseName,diseaseSeverity,
    res:{...world.res},tech:world.tech,
    terrain:world.terrain,tv:world.tv,
    paths:world.paths.map(p=>({x:p.x,y:p.y,worn:p.worn})),
    trees:world.trees.map(t=>({x:t.x,y:t.y,age:t.age,type:t.type})),
    stones:world.stones.map(s=>({x:s.x,y:s.y,amount:s.amount})),
    food:world.food.map(f=>({x:f.x,y:f.y})),
    entities:world.entities.map(e=>({
      x:e.x,y:e.y,health:e.health,age:e.age,hunger:e.hunger,tiredness:e.tiredness,
      profession:e.profession,name:e.name,traits:e.traits,lifeEvents:e.lifeEvents.slice(-10),
      str:e.str,int:e.int,wis:e.wis,agi:e.agi,cha:e.cha,end:e.end,infected:e.infected,
    })),
    settlements:world.settlements.map(s=>({
      x:s.x,y:s.y,name:s.name,level:s.level,radius:s.radius,faith:s.faith,
    })),
    buildings:world.buildings.map(b=>({x:b.x,y:b.y,type:b.type,level:b.level,age:b.age,w:b.w,h:b.h})),
    animals:world.animals.map(a=>({x:a.x,y:a.y,type:a.type,health:a.health,age:a.age,hunger:a.hunger})),
    knownResources:world.knownResources.slice(0,500), // cap to avoid huge saves
    eventLog:[...eventLog],
  };
  saves[slotIndex]=snap;
  putSaves(saves);
  notify(`üíæ "${worldName}" saved`,'good');
}

function loadWorld(snap){
  freshWorld();
  worldName=snap.name||'Saved World';
  worldSeed=snap.seed||'';
  year=snap.year||0;season=snap.season||0;seasonTick=snap.seasonTick||0;
  dayTick=snap.dayTick||0;dayPhase=snap.dayPhase||0;tick=snap.tick||0;
  worldMorale=snap.worldMorale??70;
  weather={...snap.weather};
  diseaseActive=snap.diseaseActive||false;
  diseaseName=snap.diseaseName||'';
  diseaseSeverity=snap.diseaseSeverity||0;
  world.res={...snap.res};world.tech=snap.tech||1;
  world.knownResources=snap.knownResources||[];
  world.terrain=snap.terrain;world.tv=snap.tv;
  genOceanDepth(); // recompute depth from loaded terrain
  // Rebuild spatial maps
  snap.trees.forEach(td=>{const t=new Tree(td.x,td.y,td.age);t.type=td.type;});
  snap.stones.forEach(sd=>world.stones.push({...sd}));
  snap.food.forEach(fd=>addFood(fd.x,fd.y));
  snap.paths.forEach(pd=>{const p={...pd};world.paths.push(p);pathMap.set(pd.x+','+pd.y,p);});
  snap.animals.forEach(ad=>{const a=new Animal(ad.x,ad.y,ad.type);a.health=ad.health;a.age=ad.age;a.hunger=ad.hunger;world.animals.push(a);});
  // Rebuild settlements
  snap.settlements.forEach(sd=>{
    const dummy={settlement:null,health:1,lifeEvents:[],traits:[],profession:'none'};
    const s=new Settlement(sd.x,sd.y,dummy);
    s.name=sd.name;s.level=sd.level;s.radius=sd.radius;s.faith=sd.faith||0;
    s.members=[];
    world.settlements.push(s);
  });
  // Rebuild entities and link to settlements
  snap.entities.forEach(ed=>{
    const e=new Entity(ed.x,ed.y);
    Object.assign(e,{health:ed.health,age:ed.age,hunger:ed.hunger,tiredness:ed.tiredness,
      profession:ed.profession,name:ed.name,traits:ed.traits||[],
      lifeEvents:ed.lifeEvents||[],str:ed.str,int:ed.int,wis:ed.wis,agi:ed.agi,
      cha:ed.cha,end:ed.end,infected:ed.infected||false});
    world.entities.push(e);
    // Snap settlement ‚Äî link to nearest saved settlement centre
    const near=world.settlements.find(s=>mdist(s.x,s.y,e.x,e.y)<s.radius*2);
    if(near)near.add(e);
  });
  snap.buildings.forEach(bd=>{
    const b=new Building(bd.x,bd.y,bd.type);b.level=bd.level||1;b.age=bd.age||0;
    world.buildings.push(b);
  });
  eventLog=snap.eventLog||[];
  _dom('eventLogBody').innerHTML=eventLog.slice(0,10).map(m=>`<div>${m}</div>`).join('');
  minimapDirty=true;
  // Update world name badge
  const wb=_dom('sBadgeWorld'),ws=_dom('sBadgeWorldSep');
  if(wb){wb.textContent=worldName;wb.style.display='';}
  if(ws)ws.style.display='';
  notify(`üìú "${worldName}" loaded`,'good');
}

// ‚îÄ‚îÄ Menu UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openMenu(tab){
  const menu=document.getElementById('mainMenu');
  menu.classList.remove('hidden');
  if(tab)showTab(tab);
  renderSaves();
  speed=0;
}
function closeMenu(){
  document.getElementById('mainMenu').classList.add('hidden');
  if(world)speed=1;
}
function showTab(name){
  document.querySelectorAll('.mm-tab').forEach(t=>t.classList.toggle('on',t.dataset.tab===name));
  document.querySelectorAll('.mm-pane').forEach(p=>p.classList.toggle('on',p.id==='pane-'+name));
}
function renderSaves(){
  const saves=getSaves();
  const list=document.getElementById('mm-saves-list');
  list.innerHTML='';
  for(let i=0;i<MAX_SAVES;i++){
    const sv=saves[i];
    const el=document.createElement('div');
    el.className='sv-slot'+(sv?'':' empty');
    if(sv){
      el.innerHTML=`
        <div class="sv-icon">üèù</div>
        <div class="sv-info">
          <div class="sv-name">${sv.name||'Unnamed'}</div>
          <div class="sv-meta">Year ${sv.year||0} ¬∑ ${sv.savedAt||'Unknown date'} ¬∑ Seed: ${sv.seed||'?'}</div>
        </div>
        <button class="sv-del" data-slot="${i}">‚úï</button>`;
      el.addEventListener('click',e=>{
        if(e.target.dataset.slot!==undefined)return;
        loadWorld(sv);
        closeMenu();
        cam.x=G/2-_pApp.renderer.width/cz()/2;cam.y=G/2-_pApp.renderer.height/cz()/2;clamp();
      });
      el.querySelector('.sv-del').addEventListener('click',e=>{
        e.stopPropagation();
        if(confirm(`Delete save "${sv.name}"?`)){
          const arr=getSaves();arr[i]=null;putSaves(arr);renderSaves();
        }
      });
    }else{
      el.innerHTML=`<div class="sv-icon">Ôºã</div><div class="sv-info"><div class="sv-name" style="color:var(--text-dim)">Empty Slot ${i+1}</div></div>`;
    }
    list.appendChild(el);
  }
}

// ‚îÄ‚îÄ Quick save (picks first empty slot or overwrites slot 0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function quickSave(){
  const saves=getSaves();
  let slot=saves.findIndex(s=>!s);
  if(slot===-1)slot=0;
  saveWorld(slot);
  renderSaves();
}

// ‚îÄ‚îÄ Menu tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.mm-tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

// ‚îÄ‚îÄ New world from menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('mm-start').addEventListener('click',()=>{
  const name=document.getElementById('mm-wname').value.trim()||
    (SET_NP[rnd(SET_NP.length)]+' Isle');
  const seed=document.getElementById('mm-seed').value.trim()||
    Math.floor(Math.random()*99999).toString();
  const size=document.getElementById('mm-size').value;
  closeMenu();
  genWorld(name,seed,size);
  cam.x=G/2-_pApp.renderer.width/cz()/2;cam.y=G/2-_pApp.renderer.height/cz()/2;clamp();
  speed=1;
});

// ‚îÄ‚îÄ Existing HUD buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('newWorldBtn').addEventListener('click',()=>{
  openMenu('new');
});
document.getElementById('saveBtn').addEventListener('click',()=>{
  if(!world){notify('No world to save!','danger');return;}
  quickSave();
});
document.getElementById('menuBtn').addEventListener('click',()=>openMenu('load'));
document.querySelectorAll('.sp').forEach(btn=>btn.addEventListener('click',()=>{
  document.querySelectorAll('.sp').forEach(b=>b.classList.remove('active'));btn.classList.add('active');speed=+btn.dataset.speed;
}));

// Add keyboard shortcut: I = inspect, Escape = close card
document.addEventListener('keydown',e=>{
  if(e.code==='KeyI'){tool='inspect';document.querySelectorAll('.tool-btn').forEach(b=>{b.classList.toggle('active',b.dataset.tool==='inspect');});}
  if(e.code==='Escape'){selectedEntity=null;_dom('charCard').style.display='none';}
});

// ‚îÄ‚îÄ Decorative starfield on menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  const c=document.createElement('canvas');
  const mmStars=document.getElementById('mmStars');
  mmStars.appendChild(c);
  function rsz(){c.width=window.innerWidth;c.height=window.innerHeight;}
  rsz();window.addEventListener('resize',rsz);
  const cx2=c.getContext('2d');
  const stars=Array.from({length:120},()=>({
    x:Math.random(),y:Math.random(),r:Math.random()*1.5+0.3,
    twinkle:Math.random()*Math.PI*2,sp:0.002+Math.random()*0.004
  }));
  function drawStars(){
    cx2.clearRect(0,0,c.width,c.height);
    stars.forEach(s=>{
      s.twinkle+=s.sp;
      const a=0.3+0.5*Math.abs(Math.sin(s.twinkle));
      cx2.fillStyle=`rgba(200,220,180,${a})`;
      cx2.beginPath();cx2.arc(s.x*c.width,s.y*c.height,s.r,0,Math.PI*2);cx2.fill();
    });
    requestAnimationFrame(drawStars);
  }
  drawStars();
})();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SETTINGS_KEY='worldsandbox_settings';
const SETTINGS_DEFAULTS={
  waves:true, waveSpeed:100, waveIntensity:100,
  panSpeed:100, zoomSpeed:100,
  mobileForce:false,
  joySens:100, joySize:96, joyOpacity:75,
  tapTool:true, pinchZoom:true,
  notifs:true, daynight:true,
};
let S={...SETTINGS_DEFAULTS};

function loadSettings(){
  try{const raw=localStorage.getItem(SETTINGS_KEY);if(raw){Object.assign(S,JSON.parse(raw));}}catch(e){}
  applySettings();
}
function saveSettings(){
  try{localStorage.setItem(SETTINGS_KEY,JSON.stringify(S));}catch(e){}
}
function applySettings(){
  // Wave settings are read per-frame so no action needed here
  // Joystick size
  const jw=document.getElementById('joystickWrap');
  if(jw){jw.style.width=S.joySize+'px';jw.style.height=S.joySize+'px';}
  const jb=document.getElementById('joystickBase');
  if(jb){jb.style.width=S.joySize+'px';jb.style.height=S.joySize+'px';}
  const jk=document.getElementById('joystickKnob');
  if(jk){const ks=Math.round(S.joySize*0.40);jk.style.width=ks+'px';jk.style.height=ks+'px';}
  // Joystick opacity
  const mc=document.getElementById('mobileControls');
  if(mc)mc.style.opacity=(S.joyOpacity/100).toFixed(2);
  // Day/night handled by PixiJS ColorMatrixFilter (_applyDayNightFilter)
  // Notification feed
  const nf=document.getElementById('notifFeed');
  if(nf)nf.style.display=S.notifs?'':'none';
  // Force Pixi day/night filter re-apply
  if(typeof _applyDayNightFilter!=='undefined')_applyDayNightFilter();
  // Mobile mode
  applyMobileMode();
}

// ‚îÄ‚îÄ Mobile detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isTouchDevice(){
  return (('ontouchstart' in window)||navigator.maxTouchPoints>0||
    window.matchMedia('(pointer:coarse)').matches);
}
function applyMobileMode(){
  const mobile=isTouchDevice()||S.mobileForce;
  document.body.classList.toggle('mobile',mobile);
}
// Re-check on resize (e.g. devtools device toggle)
window.addEventListener('resize',applyMobileMode);

// ‚îÄ‚îÄ Settings UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSettingsUI(){
  const overlay=document.getElementById('settingsOverlay');
  document.getElementById('settingsBtn').addEventListener('click',openSettings);
  document.getElementById('settingsClose').addEventListener('click',closeSettings);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeSettings();});

  function openSettings(){
    syncUIFromSettings();
    overlay.classList.add('open');
  }
  function closeSettings(){
    overlay.classList.remove('open');
  }

  // Build slider update helper
  function bindSlider(id,key,fmt){
    const el=document.getElementById('st-'+id);
    const valEl=document.getElementById('st-'+id+'-val');
    if(!el)return;
    function update(v){
      S[key]=+v;
      el.value=v;
      // Update gradient fill
      const pct=((v-el.min)/(el.max-el.min)*100).toFixed(1);
      el.style.setProperty('--pct',pct+'%');
      if(valEl)valEl.textContent=fmt(+v);
      saveSettings();applySettings();
    }
    el.addEventListener('input',e=>update(e.target.value));
    return update;
  }
  function bindToggle(id,key,onChange){
    const el=document.getElementById('st-'+id);
    if(!el)return;
    el.addEventListener('change',e=>{
      S[key]=e.target.checked;
      saveSettings();applySettings();
      if(onChange)onChange(S[key]);
    });
  }

  // Sliders
  bindSlider('waveSpeed','waveSpeed',v=>Math.round(v)+'%');
  bindSlider('waveIntensity','waveIntensity',v=>Math.round(v)+'%');
  bindSlider('panSpeed','panSpeed',v=>Math.round(v)+'%');
  bindSlider('zoomSpeed','zoomSpeed',v=>Math.round(v)+'%');
  bindSlider('joySens','joySens',v=>Math.round(v)+'%');
  bindSlider('joySize','joySize',v=>Math.round(v)+'px');
  bindSlider('joyOpacity','joyOpacity',v=>Math.round(v)+'%');

  // Toggles
  bindToggle('waves','waves');
  bindToggle('mobileForce','mobileForce');
  bindToggle('tapTool','tapTool');
  bindToggle('pinchZoom','pinchZoom');
  bindToggle('notifs','notifs');
  bindToggle('daynight','daynight');

  // Reset
  document.getElementById('st-reset').addEventListener('click',()=>{
    Object.assign(S,SETTINGS_DEFAULTS);
    saveSettings();syncUIFromSettings();applySettings();
  });

  function syncUIFromSettings(){
    // Sliders
    [['waveSpeed',20,200],['waveIntensity',0,200],['panSpeed',20,300],
     ['zoomSpeed',50,250],['joySens',20,300],['joySize',60,160],['joyOpacity',20,100]]
    .forEach(([id,min,max])=>{
      const el=document.getElementById('st-'+id);
      if(!el)return;
      el.value=S[id];
      const pct=((S[id]-min)/(max-min)*100).toFixed(1);
      el.style.setProperty('--pct',pct+'%');
    });
    // Slider value labels
    const fmts={waveSpeed:v=>Math.round(v)+'%',waveIntensity:v=>Math.round(v)+'%',
      panSpeed:v=>Math.round(v)+'%',zoomSpeed:v=>Math.round(v)+'%',
      joySens:v=>Math.round(v)+'%',joySize:v=>Math.round(v)+'px',joyOpacity:v=>Math.round(v)+'%'};
    Object.entries(fmts).forEach(([id,fmt])=>{
      const el=document.getElementById('st-'+id+'-val');
      if(el)el.textContent=fmt(S[id]);
    });
    // Toggles
    ['waves','mobileForce','tapTool','pinchZoom','notifs','daynight'].forEach(id=>{
      const el=document.getElementById('st-'+id);
      if(el)el.checked=!!S[id];
    });
  }
}

loadSettings();
// Settings UI needs DOM so run after it
document.addEventListener('DOMContentLoaded',initSettingsUI);
// But in case DOMContentLoaded already fired (inline script), call directly
if(document.readyState!=='loading')initSettingsUI();

(function initMobile(){

  // ‚îÄ‚îÄ Canvas touch: pan (1 finger) + pinch zoom (2 fingers) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let touches={};  // id ‚Üí {x,y}
  let lastPinchDist=null;

  function getTouchPos(t){
    const r=_pApp.view.getBoundingClientRect();
    return{x:t.clientX-r.left, y:t.clientY-r.top};
  }

  _pApp.view.addEventListener('touchstart',e=>{
    e.preventDefault();
    for(const t of e.changedTouches){
      touches[t.identifier]=getTouchPos(t);
    }
    // Single tap ‚Üí handleClick with synthetic offset
    if(e.touches.length===1 && Object.keys(touches).length===1){
      const pos=touches[e.changedTouches[0].identifier];
      _tapStartPos={x:pos.x,y:pos.y};
      _tapMoved=false;
    }
    lastPinchDist=null;
  },{passive:false});

  _pApp.view.addEventListener('touchmove',e=>{
    e.preventDefault();
    const ids=Object.keys(touches);
    // Update positions
    for(const t of e.changedTouches){
      if(touches[t.identifier]) touches[t.identifier]=getTouchPos(t);
    }

    if(e.touches.length===1){
      // Pan
      const t=e.touches[0];
      const cur=getTouchPos(t);
      const prev=touches[t.identifier]||cur;
      const c=cz();
      cam.x-=(cur.x-prev.x)/c;
      cam.y-=(cur.y-prev.y)/c;
      clamp();
      touches[t.identifier]=cur;
      // Mark as moved so tap doesn't fire
      if(_tapStartPos){
        const dx=cur.x-_tapStartPos.x, dy=cur.y-_tapStartPos.y;
        if(Math.sqrt(dx*dx+dy*dy)>6) _tapMoved=true;
      }
    } else if(e.touches.length===2 && (!S||S.pinchZoom)){
      // Pinch zoom
      const [ta,tb]=[e.touches[0],e.touches[1]];
      const pa=getTouchPos(ta), pb=getTouchPos(tb);
      const dist=Math.hypot(pa.x-pb.x, pa.y-pb.y);
      if(lastPinchDist!==null){
        const f=dist/lastPinchDist;
        const mx=(pa.x+pb.x)/2, my=(pa.y+pb.y)/2;
        const wxx=wxf(mx), wyy=wyf(my);
        cam.zoom=Math.max(cam.min,Math.min(cam.max,cam.zoom*f));
        cam.x=wxx-mx/cz(); cam.y=wyy-my/cz();
        clamp();
      }
      lastPinchDist=dist;
      _tapMoved=true; // pinch is never a tap
    }
  },{passive:false});

  _pApp.view.addEventListener('touchend',e=>{
    e.preventDefault();
    for(const t of e.changedTouches) delete touches[t.identifier];
    lastPinchDist=null;
    // Fire tap as click if finger didn't move (and tapTool setting is on)
    if(e.touches.length===0 && _tapStartPos && !_tapMoved && (!S||S.tapTool)){
      const fakeEvt={button:0, offsetX:_tapStartPos.x, offsetY:_tapStartPos.y, shiftKey:false};
      handleClick(fakeEvt);
    }
    if(e.touches.length===0){_tapStartPos=null;_tapMoved=false;}
  },{passive:false});

  // ‚îÄ‚îÄ Joystick ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const knob=document.getElementById('joystickKnob');
  const base=document.getElementById('joystickBase');
  let jActive=false, jId=null, jCx=0, jCy=0;
  let jDx=0, jDy=0; // -1..1

  const R=29; // max knob travel radius

  base.parentElement.addEventListener('touchstart',e=>{
    e.preventDefault();e.stopPropagation();
    if(jActive)return;
    const t=e.changedTouches[0];
    const r=base.getBoundingClientRect();
    jCx=r.left+r.width/2; jCy=r.top+r.height/2;
    jId=t.identifier; jActive=true;
  },{passive:false});

  document.addEventListener('touchmove',e=>{
    if(!jActive)return;
    for(const t of e.touches){
      if(t.identifier!==jId)continue;
      let dx=t.clientX-jCx, dy=t.clientY-jCy;
      const len=Math.hypot(dx,dy);
      if(len>R){dx=dx/len*R;dy=dy/len*R;}
      jDx=dx/R; jDy=dy/R;
      knob.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }
  },{passive:true});

  document.addEventListener('touchend',e=>{
    for(const t of e.changedTouches){
      if(t.identifier===jId){
        jActive=false;jId=null;jDx=0;jDy=0;
        knob.style.transform='translate(-50%,-50%)';
      }
    }
  });

  // Inject joystick pan into panCamera
  const _origPanCamera=panCamera;
  window.panCamera=function(){
    _origPanCamera();
    if(jActive&&(jDx!==0||jDy!==0)){
      const spd=(4/cam.zoom)*(S?S.joySens/100:1);
      cam.x+=jDx*spd*2.5;
      cam.y+=jDy*spd*2.5;
      clamp();
    }
  };

  // ‚îÄ‚îÄ Zoom buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let zoomInterval=null;
  function startZoom(dir){
    const step=()=>{cam.zoom=Math.max(cam.min,Math.min(cam.max,cam.zoom*(dir>0?1.06:1/1.06)));clamp();};
    step();zoomInterval=setInterval(step,80);
  }
  function stopZoom(){clearInterval(zoomInterval);zoomInterval=null;}

  const ziBtn=document.getElementById('zoomInBtn');
  const zoBtn=document.getElementById('zoomOutBtn');
  ['touchstart','mousedown'].forEach(ev=>{
    ziBtn.addEventListener(ev,e=>{e.preventDefault();startZoom(1);},{passive:false});
    zoBtn.addEventListener(ev,e=>{e.preventDefault();startZoom(-1);},{passive:false});
  });
  ['touchend','mouseup','touchcancel'].forEach(ev=>{
    ziBtn.addEventListener(ev,stopZoom);
    zoBtn.addEventListener(ev,stopZoom);
  });

  // ‚îÄ‚îÄ Mobile speed buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.mob-sp').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.mob-sp').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.sp').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const s=+btn.dataset.speed;
      speed=s;
      // Sync desktop speed buttons
      document.querySelectorAll('.sp[data-speed="'+s+'"]').forEach(b=>b.classList.add('active'));
    });
  });

  // ‚îÄ‚îÄ Tool drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const drawer=document.getElementById('toolDrawer');
  const overlay=document.getElementById('toolDrawerOverlay');
  const toggleBtn=document.getElementById('toolDrawerBtn');

  function openDrawer(){drawer.classList.add('open');overlay.classList.add('open');}
  function closeDrawer(){drawer.classList.remove('open');overlay.classList.remove('open');}

  toggleBtn.addEventListener('click',()=>drawer.classList.contains('open')?closeDrawer():openDrawer());
  overlay.addEventListener('click',closeDrawer);

  // Sync tool selection between drawer and HUD
  function setToolActive(toolName){
    tool=toolName;
    // HUD buttons
    document.querySelectorAll('.tool-btn').forEach(b=>{
      b.classList.toggle('active',b.dataset.tool===toolName);
    });
    // Drawer buttons
    document.querySelectorAll('.td-btn[data-tool]').forEach(b=>{
      b.classList.toggle('active',b.dataset.tool===toolName);
    });
  }

  document.querySelectorAll('.td-btn[data-tool]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      setToolActive(btn.dataset.tool);
      closeDrawer();
    });
  });

  // Keep HUD tool buttons also syncing drawer
  document.querySelectorAll('.tool-btn[data-tool]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.td-btn[data-tool]').forEach(b=>{
        b.classList.toggle('active',b.dataset.tool===btn.dataset.tool);
      });
    });
  });

  // Swipe down on drawer to close
  let swipeY0=null;
  drawer.addEventListener('touchstart',e=>{swipeY0=e.touches[0].clientY;},{passive:true});
  drawer.addEventListener('touchmove',e=>{
    if(swipeY0!==null&&e.touches[0].clientY-swipeY0>50)closeDrawer();
  },{passive:true});
  drawer.addEventListener('touchend',()=>{swipeY0=null;},{passive:true});

})();

// Tap state for canvas touch handler (declared in outer scope so touchend can see it)
let _tapStartPos=null, _tapMoved=false;

// ‚îÄ‚îÄ Start: show menu, don't auto-generate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
openMenu('new');
let last=0;
function loop(t){requestAnimationFrame(loop);if(t-last<16)return;last=t;panCamera();update();render();}
requestAnimationFrame(loop);
</script>
</body>
</html>
