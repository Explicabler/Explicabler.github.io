<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="KnowledgeBase ‚Äî Interactive educational tools and learning resources for students.">
<meta name="robots" content="noindex,nofollow">
<title id="pageTitle">KnowledgeBase ‚Äî Learning Resources</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0f0f13;--surface:#18181f;--surface2:#222230;--surface3:#2a2a3a;
    --border:#2e2e40;--accent:#7c6af7;--accent-hover:#9585ff;
    --accent-dim:rgba(124,106,247,0.15);
    --text:#f0f0f8;--text-2:#a0a0c0;--text-3:#606080;
    --green:#3ecf6f;--cyan:#38c9e8;--red:#f05656;
    --orange:#f0873a;--pink:#e560c8;--yellow:#f0d03a;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;overflow:hidden;-webkit-font-smoothing:antialiased}
  .app{display:flex;flex-direction:column;height:100vh}
  body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");opacity:.025;pointer-events:none;z-index:9999;mix-blend-mode:overlay}

  /* NAV */
  nav{height:56px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;padding:0 16px;flex-shrink:0;z-index:200}
  .nav-logo{display:flex;align-items:center;gap:8px;text-decoration:none;flex-shrink:0}
  .logo-icon{width:32px;height:32px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px}
  .logo-text{font-size:17px;font-weight:800;color:var(--text);letter-spacing:-0.5px;font-family:'Syne',sans-serif}
  .nav-search-btn{flex:1;max-width:360px;height:36px;display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;color:var(--text-3);font-family:'DM Sans',sans-serif;font-size:13px;padding:0 12px 0 14px;cursor:pointer;transition:border-color .15s,background .15s;text-align:left}
  .nav-search-btn:hover{border-color:var(--accent);background:var(--surface3);color:var(--text-2)}
  .nav-right{margin-left:auto;display:flex;align-items:center;gap:6px}
  .nav-count{font-size:12px;font-weight:500;color:var(--text-3);white-space:nowrap;padding-right:4px}
  .nav-btn-group{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:9px;overflow:hidden}
  .nav-btn-group button{height:32px;padding:0 11px;background:transparent;border:none;border-left:1px solid var(--border);color:var(--text-2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap;display:flex;align-items:center;gap:5px}
  .nav-btn-group button:first-child{border-left:none}
  .nav-btn-group button:hover{background:var(--surface3);color:var(--text)}
  .panic-btn{display:flex;align-items:center;gap:5px;height:32px;padding:0 11px;background:rgba(240,86,86,.1);border:1px solid rgba(240,86,86,.3);border-radius:8px;color:#f05656;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0}
  .panic-btn:hover{background:rgba(240,86,86,.2);border-color:#f05656}

  /* LAYOUT */
  .body-layout{display:flex;flex:1;overflow:hidden}

  /* SIDEBAR */
  .sidebar{width:210px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;padding:16px 10px;gap:2px}
  .sidebar::-webkit-scrollbar{display:none}
  .sb-label{font-size:10px;font-weight:700;color:var(--text-3);letter-spacing:1px;text-transform:uppercase;padding:8px 10px 4px}
  .sb-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .12s;color:var(--text-2);font-size:13px;font-weight:500}
  .sb-item:hover{background:var(--surface2);color:var(--text)}
  .sb-item.active{background:var(--accent-dim);border-color:rgba(124,106,247,.3);color:var(--text)}
  .sb-item.active .sb-icon{color:var(--accent)}
  .sb-icon{font-size:16px;flex-shrink:0;width:20px;text-align:center}
  .sb-name{flex:1}
  .sb-badge{font-size:11px;font-weight:600;color:var(--text-3);background:var(--surface2);border-radius:10px;padding:1px 7px;min-width:24px;text-align:center}
  .sb-item.active .sb-badge{background:rgba(124,106,247,.2);color:var(--accent)}
  .sb-divider{height:1px;background:var(--border);margin:8px 4px}

  /* MAIN */
  .main-area{flex:1;overflow:hidden;display:flex;flex-direction:column;min-width:0}
  .filter-bar{background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:4px;padding:0 12px;height:44px;flex-shrink:0;overflow-x:auto;position:relative}
  .filter-bar::-webkit-scrollbar{display:none}
  .chip{display:flex;align-items:center;gap:5px;height:28px;padding:0 12px;border-radius:14px;border:none;background:transparent;color:var(--text-3);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:color .15s;flex-shrink:0;position:relative;z-index:1}
  .chip:hover{color:var(--text)}
  .chip.active{color:#fff;font-weight:600}
  .chip-count{font-size:10px;font-weight:600;opacity:.7}
  .chip.active .chip-count{opacity:.85}
  .filter-pill{position:absolute;height:28px;background:var(--accent);border-radius:14px;transition:left .22s cubic-bezier(.4,0,.2,1),width .22s cubic-bezier(.4,0,.2,1);pointer-events:none;top:8px;z-index:0;box-shadow:0 2px 12px rgba(124,106,247,.35)}

  /* HOME VIEW */
  #homeView{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:6px;position:relative}
  #homeView::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 60% 20%,rgba(124,106,247,0.07) 0%,transparent 70%);pointer-events:none;z-index:0}
  #homeView>*{position:relative;z-index:1}
  #homeView::-webkit-scrollbar{width:5px}
  #homeView::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
  .section-title{font-size:15px;font-weight:700;color:var(--text)}
  .section-count{font-size:12px;color:var(--text-3);font-weight:500}
  .loading-state{display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:80px 20px;flex:1}
  .loading-state.show{display:flex}
  .spinner{width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-label{font-size:13px;color:var(--text-3);font-weight:500}

  /* GAME GRID */
  .game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
  .game-grid.compact{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:9px}
  .game-card{background:var(--surface);border-radius:12px;overflow:hidden;cursor:pointer;border:1px solid var(--border);transition:transform .18s,box-shadow .18s,border-color .18s;animation:cardIn .2s ease both;display:flex;flex-direction:column}
  @keyframes cardIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .game-card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.6);border-color:var(--accent)}
  .card-thumb{width:100%;aspect-ratio:4/3;position:relative;overflow:hidden;background:var(--surface2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .card-thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .3s}
  .game-card:hover .card-thumb img{transform:scale(1.04)}
  .thumb-fallback{font-size:40px;opacity:.6}
  .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0);transition:background .2s;z-index:2}
  .game-card:hover .play-overlay{background:rgba(0,0,0,.5)}
  .play-btn{width:44px;height:44px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.8);transition:all .15s;box-shadow:0 4px 20px rgba(124,106,247,.6)}
  .game-card:hover .play-btn{opacity:1;transform:scale(1)}
  .play-btn svg{margin-left:3px}
  .card-badge{position:absolute;top:7px;left:7px;z-index:3;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px}
  .badge-html{background:#d04010;color:#fff}
  .badge-unity{background:#111;color:var(--cyan);border:1px solid rgba(56,201,232,.4)}
  .card-body{padding:10px 11px 11px;display:flex;flex-direction:column;gap:4px;flex:1}
  .card-title{font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3;font-family:'DM Sans',sans-serif}
  .card-desc{font-size:11px;color:var(--text-3);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;max-height:0;opacity:0;transition:max-height .2s ease,opacity .2s ease,margin-top .2s ease;margin-top:0}
  .game-card:hover .card-desc{max-height:40px;opacity:1;margin-top:2px}
  .card-meta{display:flex;align-items:center;gap:5px;margin-top:3px}
  .meta-tag{font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;border:1px solid var(--border);color:var(--text-3);text-transform:capitalize}
  .meta-tag.type-tag{border-color:rgba(124,106,247,.4);color:var(--accent);background:var(--accent-dim)}
  .empty-state{display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:80px 20px;text-align:center}
  .empty-state.show{display:flex}
  .empty-icon{font-size:40px;opacity:.4}
  .empty-title{font-size:15px;font-weight:700;color:var(--text-2)}
  .empty-sub{font-size:13px;color:var(--text-3)}
  .empty-reset{margin-top:8px;height:32px;padding:0 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text-2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .12s}
  .empty-reset:hover{border-color:var(--accent);color:var(--text);background:var(--accent-dim)}

  /* PLAY VIEW */
  #playView{display:none;flex:1;flex-direction:column;overflow:hidden}
  #playView.show{display:flex}
  .play-bar{height:44px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 14px;flex-shrink:0}
  .back-btn{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;padding:5px 11px;cursor:pointer;transition:all .12s}
  .back-btn:hover{border-color:var(--accent);color:var(--text)}
  .play-title{font-size:14px;font-weight:700;color:var(--text)}
  .play-type-badge{font-size:11px;font-weight:600;padding:3px 9px;border-radius:5px;background:var(--accent-dim);border:1px solid rgba(124,106,247,.3);color:var(--accent);text-transform:capitalize}
  .play-bar-right{margin-left:auto;display:flex;align-items:center;gap:6px}
  .icon-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);cursor:pointer;transition:all .12s}
  .icon-btn:hover{border-color:var(--accent);color:var(--text)}
  .blank-btn{display:flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;padding:5px 10px;cursor:pointer;transition:all .12s;white-space:nowrap}
  .blank-btn:hover{border-color:var(--green);color:var(--green)}
  .play-body{display:flex;flex:1;overflow:hidden}
  .iframe-col{flex:1;display:flex;flex-direction:column;background:#000;min-width:0;position:relative}
  .iframe-loader{position:absolute;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:10;transition:opacity .3s}
  .iframe-loader.hidden{opacity:0;pointer-events:none}
  .loader-label{font-size:12px;color:var(--text-3);font-weight:500}
  .iframe-col iframe{flex:1;width:100%;border:none}
  .play-sidebar{width:200px;background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column}
  .play-sidebar::-webkit-scrollbar{width:3px}
  .play-sidebar::-webkit-scrollbar-thumb{background:var(--border)}
  .ps-head{padding:12px 12px 8px;font-size:10px;font-weight:700;color:var(--text-3);letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);flex-shrink:0}
  .ps-list{padding:8px;display:flex;flex-direction:column;gap:2px}
  .ps-card{display:flex;align-items:center;gap:9px;padding:7px 8px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .12s}
  .ps-card:hover{background:var(--surface2);border-color:var(--border)}
  .ps-card.active{background:var(--accent-dim);border-color:rgba(124,106,247,.3);cursor:default}
  .ps-thumb{width:40px;height:30px;border-radius:5px;overflow:hidden;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
  .ps-thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .ps-info{min-width:0;flex:1}
  .ps-title{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4}
  .ps-type{font-size:10px;color:var(--text-3);text-transform:capitalize;margin-top:1px}
  .ps-card.active .ps-type{color:var(--accent)}
  .ps-now{font-size:9px;font-weight:700;color:var(--green);margin-top:2px}

  /* COLOR HELPERS */
  .bg-cyan{background:rgba(56,201,232,.15)}.bg-pink{background:rgba(229,96,200,.15)}.bg-green{background:rgba(62,207,111,.15)}.bg-orange{background:rgba(240,135,58,.15)}.bg-yellow{background:rgba(240,208,58,.15)}.bg-accent{background:rgba(124,106,247,.15)}
  .col-cyan{color:var(--cyan)}.col-pink{color:var(--pink)}.col-green{color:var(--green)}.col-orange{color:var(--orange)}.col-yellow{color:var(--yellow)}.col-accent{color:var(--accent)}

  /* SETTINGS MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
  .modal-overlay.open{opacity:1;pointer-events:all}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:500px;max-width:calc(100vw - 32px);max-height:calc(100vh - 60px);overflow-y:auto;transform:translateY(14px) scale(.98);transition:transform .2s;box-shadow:0 24px 60px rgba(0,0,0,.6)}
  .modal-overlay.open .modal{transform:none}
  .modal::-webkit-scrollbar{width:4px}
  .modal::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:1}
  .modal-title{font-size:15px;font-weight:700;color:var(--text)}
  .modal-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text-2);cursor:pointer;font-size:16px;line-height:1;transition:all .12s}
  .modal-close:hover{border-color:var(--red);color:var(--red)}
  .modal-body{padding:18px 20px;display:flex;flex-direction:column;gap:24px}
  .settings-section{display:flex;flex-direction:column;gap:8px}
  .settings-section-title{font-size:10px;font-weight:700;color:var(--text-3);letter-spacing:1px;text-transform:uppercase;margin-bottom:2px}
  .setting-row{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px}
  .setting-row-info{flex:1;min-width:0}
  .setting-label{font-size:13px;font-weight:600;color:var(--text)}
  .setting-desc{font-size:11px;color:var(--text-3);margin-top:2px;line-height:1.4}
  .toggle{position:relative;flex-shrink:0}
  .toggle input{position:absolute;opacity:0;width:0;height:0}
  .toggle-track{display:block;width:42px;height:24px;background:var(--surface3);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:background .2s;position:relative}
  .toggle input:checked+.toggle-track{background:var(--accent);border-color:var(--accent)}
  .toggle-track::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
  .toggle input:checked+.toggle-track::after{transform:translateX(18px)}
  .theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
  .theme-card{border:2px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:all .15s;position:relative}
  .theme-card:hover{border-color:var(--text-2);transform:translateY(-1px)}
  .theme-card.active{border-color:var(--accent)}
  .theme-check{position:absolute;top:5px;right:5px;width:18px;height:18px;border-radius:50%;background:var(--accent);color:#fff;font-size:9px;font-weight:700;display:none;align-items:center;justify-content:center}
  .theme-card.active .theme-check{display:flex}
  .theme-preview{height:52px;display:flex;align-items:flex-end;padding:5px 5px 0;gap:3px;position:relative}
  .tp-bar{border-radius:3px 3px 0 0;flex:1}
  .theme-name{font-size:11px;font-weight:600;color:var(--text);padding:6px 8px;border-top:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .danger-btn{display:flex;align-items:flex-start;gap:10px;width:100%;padding:12px 14px;background:rgba(240,86,86,.07);border:1px solid rgba(240,86,86,.25);border-radius:10px;color:var(--red);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;text-align:left}
  .danger-btn:hover{background:rgba(240,86,86,.14);border-color:var(--red)}
  .danger-btn svg{margin-top:1px;flex-shrink:0}
  .danger-btn-sub{font-size:11px;font-weight:400;color:var(--text-3);margin-top:2px}
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 18px;font-size:13px;font-weight:500;color:var(--text);z-index:2000;transition:transform .3s,opacity .3s;opacity:0;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

  /* ‚îÄ‚îÄ‚îÄ FAV BUTTON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .fav-btn{position:absolute;top:7px;right:7px;z-index:4;width:26px;height:26px;border-radius:50%;background:rgba(0,0,0,.5);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity .15s,transform .15s;backdrop-filter:blur(4px)}
  .fav-btn svg{transition:all .15s}
  .game-card:hover .fav-btn{opacity:1}
  .fav-btn.faved{opacity:1}
  .fav-btn.faved svg{fill:#f05656;stroke:#f05656}
  .fav-btn:hover{transform:scale(1.2)}

  /* ‚îÄ‚îÄ‚îÄ RECENTLY PLAYED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .recents-section{display:none;flex-direction:column;gap:8px;padding-bottom:4px}
  .recents-section.show{display:flex}
  .recents-label{display:flex;align-items:center;justify-content:space-between}
  .recents-title{font-size:11px;font-weight:700;color:var(--text-3);letter-spacing:.8px;text-transform:uppercase}
  .recents-clear{font-size:10px;font-weight:600;color:var(--text-3);cursor:pointer;padding:2px 6px;border-radius:4px;transition:all .12s}
  .recents-clear:hover{color:var(--red);background:rgba(240,86,86,.1)}
  .recents-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
  .recents-row::-webkit-scrollbar{height:3px}
  .recents-row::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
  .recent-card{flex-shrink:0;width:100px;border-radius:8px;overflow:hidden;cursor:pointer;border:1px solid var(--border);background:var(--surface2);transition:transform .12s,border-color .12s}
  .recent-card:hover{transform:translateY(-2px);border-color:var(--accent)}
  .recent-card-thumb{width:100%;aspect-ratio:16/9;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
  .recent-card-thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .recent-card-name{font-size:10px;font-weight:600;color:var(--text);padding:4px 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .section-divider{height:1px;background:var(--border);margin:4px 0 12px}

  .mini-tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .mini-btn{height:28px;padding:0 10px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-2);font-size:11px;font-weight:600;cursor:pointer}
  .mini-btn:hover{border-color:var(--accent);color:var(--text)}
  .rating-row{display:flex;align-items:center;justify-content:space-between;margin-top:7px;font-size:11px;color:var(--text-3)}
  .rate-controls{display:flex;align-items:center;gap:6px}
  .rate-btn{border:1px solid var(--border);background:var(--surface2);color:var(--text-2);border-radius:6px;padding:2px 7px;font-size:11px;cursor:pointer}
  .rate-btn.active{border-color:var(--green);color:var(--green)}

  /* ‚îÄ‚îÄ‚îÄ SCROLL TO TOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .scroll-top{position:fixed;bottom:24px;right:24px;width:38px;height:38px;background:var(--accent);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;z-index:400;opacity:0;transform:translateY(12px) scale(.8);transition:all .2s;pointer-events:none;box-shadow:0 4px 16px rgba(124,106,247,.5)}
  .scroll-top.show{opacity:1;transform:none;pointer-events:all}
  .scroll-top:hover{background:var(--accent-hover);transform:translateY(-2px)!important}

  /* ‚îÄ‚îÄ‚îÄ PLAY BAR FAVOURITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .play-fav-btn{display:flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;padding:5px 10px;cursor:pointer;transition:all .12s;white-space:nowrap;height:32px}
  .play-fav-btn:hover{border-color:#f05656;color:#f05656}
  .play-fav-btn.faved{border-color:#f05656;color:#f05656;background:rgba(240,86,86,.1)}
  .play-fav-btn.faved svg{fill:#f05656}

  /* SIDEBAR COLLAPSED */
  .sidebar.collapsed{width:0;padding:0;overflow:hidden;border:none}
  #sidebarToggle:hover{border-color:var(--accent);color:var(--text)}

  /* SORT SELECT */
  #sortSelect option{background:var(--surface2);color:var(--text)}
  #sortSelect:hover{border-color:var(--accent)}

  /* PANIC HINT */
  .panic-hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--text-3);white-space:nowrap;pointer-events:none;opacity:.5}

  /* ‚îÄ‚îÄ‚îÄ ACCENT COLOUR PICKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .accent-picker-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:4px}
  .accent-swatch{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .12s,border-color .12s;flex-shrink:0}
  .accent-swatch:hover{transform:scale(1.15)}
  .accent-swatch.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}
  .accent-custom-wrap{position:relative;width:28px;height:28px;flex-shrink:0}
  .accent-custom-wrap input[type=color]{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;border:none;padding:0}
  .accent-custom-btn{width:28px;height:28px;border-radius:50%;border:2px dashed var(--border);background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red);display:flex;align-items:center;justify-content:center;pointer-events:none;transition:border-color .12s}
  .accent-custom-wrap:hover .accent-custom-btn{border-color:var(--text-2)}
  .accent-custom-wrap.active .accent-custom-btn{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}
  .play-timer{font-size:11px;font-weight:700;color:var(--text-3);font-variant-numeric:tabular-nums;letter-spacing:.5px;padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;white-space:nowrap}

  /* ‚îÄ‚îÄ‚îÄ HOTKEY BADGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .kbd{display:inline-flex;align-items:center;justify-content:min-content;min-width:18px;height:18px;padding:0 4px;background:var(--surface3);border:1px solid var(--border);border-radius:4px;font-size:9px;font-weight:700;color:var(--text-3);font-family:'DM Sans',sans-serif;letter-spacing:.2px}

  /* ‚îÄ‚îÄ‚îÄ HOTKEYS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .hk-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .hk-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px}
  .hk-desc{font-size:12px;font-weight:500;color:var(--text-2)}
  .hk-keys{margin-left:auto;display:flex;gap:4px;align-items:center}

  /* ‚îÄ‚îÄ‚îÄ NOW PLAYING DOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .now-playing-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse-dot 1.5s ease-in-out infinite;flex-shrink:0}
  @keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}

  /* ‚îÄ‚îÄ‚îÄ PROGRESS BAR (iframe loading) ‚îÄ‚îÄ‚îÄ‚îÄ */
  .iframe-progress{position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);z-index:20;transform-origin:left;transform:scaleX(0);transition:transform .4s ease;border-radius:0 2px 2px 0}
  .iframe-progress.running{animation:progress-run 2.5s ease-in-out forwards}
  @keyframes progress-run{0%{transform:scaleX(0)}60%{transform:scaleX(.8)}100%{transform:scaleX(.95)}}
  .iframe-progress.done{transform:scaleX(1);transition:transform .15s ease,opacity .3s ease .2s;opacity:0}

  /* RESPONSIVE */
  /* ‚îÄ‚îÄ‚îÄ SEARCH PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .search-panel-overlay{
    position:fixed;inset:0;z-index:500;
    pointer-events:none;
  }
  .search-panel-overlay.open{pointer-events:all}

  .search-panel-backdrop{
    position:absolute;inset:0;
    background:rgba(0,0,0,0);
    transition:background .25s;
  }
  .search-panel-overlay.open .search-panel-backdrop{
    background:rgba(0,0,0,.5);
    backdrop-filter:blur(2px);
  }

  .search-panel{
    position:absolute;
    top:0;right:0;bottom:0;
    width:340px;max-width:90vw;
    background:var(--surface);
    border-left:1px solid var(--border);
    display:flex;flex-direction:column;
    transform:translateX(100%);
    transition:transform .28s cubic-bezier(.4,0,.2,1);
    box-shadow:-8px 0 32px rgba(0,0,0,.4);
    overflow:hidden;
  }
  .search-panel-overlay.open .search-panel{
    transform:translateX(0);
  }

  .sp-head{
    display:flex;align-items:center;gap:10px;
    padding:14px 16px 12px;
    border-bottom:1px solid var(--border);
    flex-shrink:0;
    background:var(--surface);
  }
  .sp-back{
    width:30px;height:30px;
    display:flex;align-items:center;justify-content:center;
    background:var(--surface2);border:1px solid var(--border);
    border-radius:7px;color:var(--text-2);
    cursor:pointer;transition:all .12s;flex-shrink:0;
  }
  .sp-back:hover{border-color:var(--accent);color:var(--text)}
  .sp-search-wrap{flex:1;position:relative}
  .sp-search-wrap input{
    width:100%;height:36px;
    background:var(--surface2);
    border:1px solid var(--accent);
    border-radius:20px;
    color:var(--text);
    font-family:'DM Sans',sans-serif;font-size:13px;
    padding:0 14px 0 36px;
    outline:none;
  }
  .sp-search-wrap input::placeholder{color:var(--text-3)}
  .sp-search-icon{
    position:absolute;left:11px;top:50%;
    transform:translateY(-50%);
    color:var(--text-3);pointer-events:none;display:flex;
  }

  .sp-body{
    flex:1;overflow-y:auto;
    padding:16px;
    display:flex;flex-direction:column;gap:18px;
  }
  .sp-body::-webkit-scrollbar{width:4px}
  .sp-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

  .sp-section-title{
    font-size:11px;font-weight:700;
    color:var(--text-3);letter-spacing:.8px;
    text-transform:uppercase;margin-bottom:8px;
  }

  .sp-chips{display:flex;flex-wrap:wrap;gap:6px}
  .sp-chip{
    display:flex;align-items:center;gap:5px;
    height:30px;padding:0 12px;
    border-radius:15px;
    border:1px solid var(--border);
    background:var(--surface2);
    color:var(--text-2);
    font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;
    cursor:pointer;white-space:nowrap;
    transition:all .12s;
  }
  .sp-chip:hover{border-color:var(--accent);color:var(--text);background:var(--accent-dim)}
  .sp-chip.active{background:var(--accent);border-color:var(--accent);color:#fff}

  /* Top games grid in panel */
  .sp-game-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:8px;
  }
  .sp-game-card{
    border-radius:8px;overflow:hidden;
    cursor:pointer;
    border:1px solid var(--border);
    background:var(--surface2);
    transition:transform .12s,border-color .12s;
    aspect-ratio:1;
    position:relative;
  }
  .sp-game-card:hover{transform:translateY(-2px);border-color:var(--accent)}
  .sp-game-card img{width:100%;height:100%;object-fit:cover;display:block}
  .sp-game-card .sp-thumb-fallback{
    width:100%;height:100%;
    display:flex;align-items:center;justify-content:center;
    font-size:28px;
  }
  .sp-game-name{
    position:absolute;bottom:0;left:0;right:0;
    background:linear-gradient(transparent,rgba(0,0,0,.75));
    color:#fff;font-size:9px;font-weight:700;
    padding:12px 5px 4px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    text-align:center;
  }

  /* Search results list in panel */
  .sp-results{display:flex;flex-direction:column;gap:4px}
  .sp-result-item{
    display:flex;align-items:center;gap:10px;
    padding:8px 10px;border-radius:8px;
    cursor:pointer;border:1px solid transparent;
    transition:all .12s;
  }
  .sp-result-item:hover{background:var(--surface2);border-color:var(--border)}
  .sp-result-thumb{
    width:44px;height:33px;border-radius:5px;
    overflow:hidden;background:var(--surface2);
    display:flex;align-items:center;justify-content:center;
    font-size:18px;flex-shrink:0;
  }
  .sp-result-thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .sp-result-info{min-width:0;flex:1}
  .sp-result-title{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sp-result-type{font-size:10px;color:var(--text-3);text-transform:capitalize;margin-top:1px}
  .sp-no-results{text-align:center;padding:24px;color:var(--text-3);font-size:13px}

  @media(max-width:800px){.sidebar{display:none}.play-sidebar{display:none}.game-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:9px}}
  @media(max-width:500px){#homeView{padding:12px}.game-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}}
  @media(max-width:500px){.search-panel{width:100vw;max-width:100vw}}

  /* ‚îÄ‚îÄ‚îÄ DISGUISE OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #disguiseOverlay{display:none;position:fixed;inset:0;z-index:99999;background:#fff;font-family:Arial,sans-serif;flex-direction:column;overflow:auto}
  #disguiseOverlay.show{display:flex}
  .dg-topbar{height:48px;background:#1a73e8;display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0}
  .dg-topbar-logo{color:#fff;font-size:16px;font-weight:700;letter-spacing:-.3px}
  .dg-topbar-links{display:flex;gap:20px;margin-left:24px}
  .dg-topbar-links a{color:rgba(255,255,255,.85);font-size:13px;text-decoration:none}
  .dg-body{display:flex;flex:1;overflow:hidden}
  .dg-sidebar{width:220px;background:#f8f9fa;border-right:1px solid #e0e0e0;padding:16px 0;flex-shrink:0}
  .dg-sb-item{padding:9px 20px;font-size:13px;color:#3c4043;cursor:default;border-left:3px solid transparent}
  .dg-sb-item.active{background:#e8f0fe;border-left-color:#1a73e8;color:#1a73e8;font-weight:600}
  .dg-content{flex:1;padding:32px 40px;overflow-y:auto;background:#fff}
  .dg-heading{font-size:22px;font-weight:400;color:#202124;margin-bottom:6px}
  .dg-sub{font-size:13px;color:#5f6368;margin-bottom:28px}
  .dg-card-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
  .dg-card{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:16px;cursor:default}
  .dg-card-title{font-size:13px;font-weight:600;color:#202124;margin-bottom:4px}
  .dg-card-desc{font-size:12px;color:#5f6368;line-height:1.5}
  .dg-card-icon{font-size:24px;margin-bottom:10px}
  .dg-table{width:100%;border-collapse:collapse;font-size:13px}
  .dg-table th{text-align:left;padding:8px 12px;border-bottom:2px solid #e0e0e0;color:#5f6368;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
  .dg-table td{padding:10px 12px;border-bottom:1px solid #f0f0f0;color:#3c4043}
  .dg-table tr:hover td{background:#f8f9fa}
  .dg-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
  .dg-badge.green{background:#e6f4ea;color:#137333}
  .dg-badge.blue{background:#e8f0fe;color:#1a73e8}
  .dg-badge.grey{background:#f1f3f4;color:#5f6368}

  /* ‚îÄ‚îÄ‚îÄ PANIC BUTTON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .panic-btn{display:flex;align-items:center;gap:5px;height:32px;padding:0 11px;background:rgba(240,86,86,.12);border:1px solid rgba(240,86,86,.35);border-radius:8px;color:#f05656;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0}
  .panic-btn:hover{background:rgba(240,86,86,.22);border-color:#f05656}
</style>
</head>
<body>
<div class="app">

  <nav>
    <button id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar" style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);cursor:pointer;transition:all .12s;flex-shrink:0">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <a class="nav-logo" href="#">
      <div class="logo-icon">üéÆ</div>
      <span class="logo-text">CS Hub</span>
    </a>
    <button class="nav-search-btn" onclick="openSearchPanel()" title="Search games (/)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <span>Search games...</span>
      <span class="kbd" style="margin-left:auto">/</span>
    </button>
    <!-- hidden input kept for state sync -->
    <input type="text" id="searchInput" style="display:none" autocomplete="off"/>
    <div class="nav-right">
      <span class="nav-count" id="navCount"></span>
      <div class="nav-btn-group">
        <button onclick="playRandom()" title="Random game (R)">üé≤ Random</button>
        <button onclick="openHotkeys()" title="Keyboard shortcuts">‚å®Ô∏è</button>
      </div>
      <button class="panic-btn" onclick="activateDisguise()" title="Disguise page (Ctrl+D)">üõ°Ô∏è Hide</button>
    </div>
  </nav>

  <div class="body-layout">
    <aside class="sidebar">
      <div class="sb-label">Browse</div>
      <div class="sb-item active" data-type="all"><span class="sb-icon">üè†</span><span class="sb-name">All Games</span><span class="sb-badge" id="count-all">0</span></div>
      <div class="sb-item" data-type="favourites"><span class="sb-icon">‚ù§Ô∏è</span><span class="sb-name">Favourites</span><span class="sb-badge" id="count-favourites">0</span></div>
      <div class="sb-divider"></div>
      <div class="sb-label">Categories</div>
      <div class="sb-item" data-type="sport"><span class="sb-icon">‚öΩ</span><span class="sb-name">Sports</span><span class="sb-badge" id="count-sport">0</span></div>
      <div class="sb-item" data-type="simulation"><span class="sb-icon">üåç</span><span class="sb-name">Simulation</span><span class="sb-badge" id="count-simulation">0</span></div>
      <div class="sb-item" data-type="interactive"><span class="sb-icon">üî¨</span><span class="sb-name">Interactive</span><span class="sb-badge" id="count-interactive">0</span></div>
      <div class="sb-item" data-type="puzzle"><span class="sb-icon">üß©</span><span class="sb-name">Puzzle</span><span class="sb-badge" id="count-puzzle">0</span></div>
      <div class="sb-item" data-type="platformer"><span class="sb-icon">üèÉ</span><span class="sb-name">Platformer</span><span class="sb-badge" id="count-platformer">0</span></div>
      <div class="sb-item" data-type="arcade"><span class="sb-icon">üïπÔ∏è</span><span class="sb-name">Arcade</span><span class="sb-badge" id="count-arcade">0</span></div>
      <div class="sb-item" data-type="action"><span class="sb-icon">üöÄ</span><span class="sb-name">Action</span><span class="sb-badge" id="count-action">0</span></div>
      <div class="sb-item" data-type="rpg"><span class="sb-icon">‚öîÔ∏è</span><span class="sb-name">RPG</span><span class="sb-badge" id="count-rpg">0</span></div>
      <div class="sb-divider"></div>
      <div class="sb-item" onclick="openSettings()"><span class="sb-icon">‚öôÔ∏è</span><span class="sb-name">Settings</span></div>
    </aside>

    <div class="main-area">
      <div class="filter-bar" id="filterBar">
        <div class="filter-pill" id="filterPill"></div>
        <button class="chip active" data-type="all">All <span class="chip-count" id="fc-all">0</span></button>
        <button class="chip" data-type="sport">‚öΩ Sports <span class="chip-count" id="fc-sport">0</span></button>
        <button class="chip" data-type="simulation">üåç Sim <span class="chip-count" id="fc-simulation">0</span></button>
        <button class="chip" data-type="interactive">üî¨ Interactive <span class="chip-count" id="fc-interactive">0</span></button>
        <button class="chip" data-type="puzzle">üß© Puzzle <span class="chip-count" id="fc-puzzle">0</span></button>
        <button class="chip" data-type="platformer">üèÉ Platformer <span class="chip-count" id="fc-platformer">0</span></button>
        <button class="chip" data-type="arcade">üïπÔ∏è Arcade <span class="chip-count" id="fc-arcade">0</span></button>
        <button class="chip" data-type="action">üöÄ Action <span class="chip-count" id="fc-action">0</span></button>
        <button class="chip" data-type="rpg">‚öîÔ∏è RPG <span class="chip-count" id="fc-rpg">0</span></button>
      </div>

      <div id="homeView">
        <div class="loading-state show" id="loadingState">
          <div class="spinner"></div>
          <div class="loading-label">Loading games...</div>
        </div>

        <!-- RECENTLY PLAYED -->
        <div class="recents-section" id="recentsSection">
          <div class="recents-label">
            <span class="recents-title">Recently Played</span>
            <span class="recents-clear" onclick="clearRecents()">Clear</span>
          </div>
          <div class="recents-row" id="recentsRow"></div>
          <div class="section-divider"></div>
        </div>

<div class="mini-tools">
          <select id="engineSelect" onchange="setEngineFilter()" style="height:28px;padding:0 8px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);font-size:11px;font-weight:600;cursor:pointer;outline:none">
            <option value="all">All engines</option>
            <option value="html">HTML5</option>
            <option value="unity">Unity</option>
          </select>
          <select id="collectionSelect" onchange="setCollectionFilter()" style="height:28px;padding:0 8px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-2);font-size:11px;font-weight:600;cursor:pointer;outline:none">
            <option value="all">All collections</option>
            <option value="quick">5-minute games</option>
            <option value="puzzle">Puzzle picks</option>
            <option value="classic">Classics</option>
          </select>
          <button class="mini-btn" onclick="openSuggestionIssue()">‚ûï Suggestion/Issue</button>
          <button class="mini-btn" onclick="openAnalyticsModal()">üìä Analytics</button>
        </div>

        <div class="section-header" id="sectionHeader" style="display:none">
          <span class="section-title" id="sectionTitle">All Games</span>
          <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
            <span class="section-count" id="sectionCount"></span>
            <select id="sortSelect" onchange="setSortAndRender()" style="height:26px;padding:0 8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text-2);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;outline:none">
              <option value="default">Default</option>
              <option value="az">A ‚Üí Z</option>
              <option value="za">Z ‚Üí A</option>
              <option value="newest">Newest</option>
            </select>
          </div>
        </div>
        <div class="game-grid" id="gameGrid"></div>
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">üéÆ</div>
          <div class="empty-title">No games found</div>
          <div class="empty-sub">Try a different search or category</div>
          <button class="empty-reset" onclick="resetBrowseState()">Reset filters</button>
        </div>
      </div>

      <!-- SCROLL TO TOP -->
      <button class="scroll-top" id="scrollTopBtn" onclick="scrollToTop()" title="Back to top">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M18 15l-6-6-6 6"/></svg>
      </button>

      <div id="playView">
        <div class="play-bar">
          <button class="back-btn" onclick="goHome()">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>Back
          </button>
          <div class="now-playing-dot"></div>
          <span class="play-title" id="playName"></span>
          <span class="play-type-badge" id="playType"></span>
          <div class="play-bar-right">
            <span class="play-timer" id="playTimer">0:00</span>
            <button class="play-fav-btn" id="playFavBtn" onclick="togglePlayFav()">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
              Favourite
            </button>
            <button class="blank-btn" onclick="openInBlank()">
              <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>Blank Tab
            </button>
            <button class="icon-btn" id="fsBtn" title="Fullscreen (F)">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>
            </button>
          </div>
        </div>
        <div class="play-body">
          <div class="iframe-col">
            <div class="iframe-loader" id="iframeLoader">
              <div class="spinner"></div>
              <div class="loader-label">Loading game...</div>
            </div>
            <div class="iframe-progress" id="iframeProgress"></div>
            <div class="panic-hint">Press Esc to go back ¬∑ F to fullscreen</div>
            <iframe id="projectFrame" src="" allowfullscreen allow="pointer-lock *; fullscreen *" sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-modals allow-popups allow-downloads allow-top-navigation-by-user-activation"></iframe>
          </div>
          <aside class="play-sidebar">
            <div class="ps-head">Related Games</div>
            <div class="ps-list" id="relatedList"></div>
            <div class="ps-head">Up Next</div>
            <div class="ps-list" id="sidebarList"></div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- HOTKEYS MODAL -->
  <div class="modal-overlay" id="hotkeysOverlay" onclick="if(event.target===this)closeHotkeys()">
    <div class="modal" style="max-width:440px">
      <div class="modal-head">
        <span class="modal-title">‚å®Ô∏è Keyboard Shortcuts</span>
        <span class="modal-close" onclick="closeHotkeys()">‚úï</span>
      </div>
      <div class="modal-body" style="gap:10px">
        <div class="hk-grid">
          <div class="hk-row"><span class="hk-desc">Search games</span><span class="hk-keys"><span class="kbd">/</span></span></div>
          <div class="hk-row"><span class="hk-desc">Random game</span><span class="hk-keys"><span class="kbd">R</span></span></div>
          <div class="hk-row"><span class="hk-desc">Fullscreen game</span><span class="hk-keys"><span class="kbd">F</span></span></div>
          <div class="hk-row"><span class="hk-desc">Exit / Go back</span><span class="hk-keys"><span class="kbd">Esc</span></span></div>
          <div class="hk-row"><span class="hk-desc">Toggle disguise</span><span class="hk-keys"><span class="kbd">Ctrl</span>+<span class="kbd">D</span></span></div>
          <div class="hk-row"><span class="hk-desc">Shortcuts help</span><span class="hk-keys"><span class="kbd">?</span></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="analyticsOverlay" onclick="if(event.target===this)closeAnalyticsModal()">
    <div class="modal" style="max-width:500px">
      <div class="modal-head"><span class="modal-title">Analytics snapshot</span><span class="modal-close" onclick="closeAnalyticsModal()">‚úï</span></div>
      <div class="modal-body" id="analyticsBody"></div>
    </div>
  </div>

  <!-- WELCOME POPUP -->
  <div class="modal-overlay" id="welcomeOverlay" style="z-index:1500">
    <div class="modal" style="max-width:420px">
      <div class="modal-head">
        <span class="modal-title">üëã Welcome to CS Hub</span>
      </div>
      <div class="modal-body" style="gap:16px">
        <div style="background:rgba(240,208,58,0.1);border:1px solid rgba(240,208,58,0.3);border-radius:10px;padding:14px 16px;display:flex;gap:12px;align-items:flex-start">
          <span style="font-size:22px;flex-shrink:0">üíª</span>
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px">On a Chromebook?</div>
            <div style="font-size:12px;color:var(--text-2);line-height:1.6">Go to <strong style="color:var(--text)">Settings ‚Üí Enable About:Blank</strong> to help bypass content filters and keep the site hidden.</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text-3);line-height:1.6;padding:0 2px">
          You can find this option any time in <strong style="color:var(--text-2)">‚öôÔ∏è Settings</strong> in the sidebar.
        </div>
        <button onclick="dismissWelcome()" style="width:100%;height:38px;background:var(--accent);border:none;border-radius:9px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--accent-hover)'" onmouseout="this.style.background='var(--accent)'">
          Got it, let's play! üéÆ
        </button>
      </div>
    </div>
  </div>

  <!-- SEARCH PANEL -->
  <div class="search-panel-overlay" id="searchPanelOverlay">
    <div class="search-panel-backdrop" onclick="closeSearchPanel()"></div>
    <div class="search-panel">
      <div class="sp-head">
        <div class="sp-back" onclick="closeSearchPanel()">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        </div>
        <div class="sp-search-wrap">
          <span class="sp-search-icon">
            <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          </span>
          <input type="text" id="spSearchInput" placeholder="What are you playing today?" autocomplete="off"/>
        </div>
      </div>
      <div class="sp-body">
        <div id="spDefault">
          <div class="sp-section-title">Categories</div>
          <div class="sp-chips" id="spCategoryChips">
            <div class="sp-chip active" data-type="all">üè† All</div>
            <div class="sp-chip" data-type="sport">‚öΩ Sports</div>
            <div class="sp-chip" data-type="arcade">üïπÔ∏è Arcade</div>
            <div class="sp-chip" data-type="action">üöÄ Action</div>
            <div class="sp-chip" data-type="puzzle">üß© Puzzle</div>
            <div class="sp-chip" data-type="platformer">üèÉ Platformer</div>
            <div class="sp-chip" data-type="simulation">üåç Simulation</div>
            <div class="sp-chip" data-type="interactive">üî¨ Interactive</div>
            <div class="sp-chip" data-type="rpg">‚öîÔ∏è RPG</div>
          </div>
          <div style="margin-top:4px">
            <div class="sp-section-title">Top Games</div>
            <div class="sp-game-grid" id="spTopGames"></div>
          </div>
        </div>
        <div id="spResults" style="display:none">
          <div class="sp-section-title" id="spResultsLabel">Results</div>
          <div class="sp-results" id="spResultsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settingsOverlay" onclick="onOverlayClick(event)">
    <div class="modal">
      <div class="modal-head">
        <span class="modal-title">‚öôÔ∏è Settings</span>
        <span class="modal-close" onclick="closeSettings()">‚úï</span>
      </div>
      <div class="modal-body">

        <div class="settings-section">
          <div class="settings-section-title">General</div>
          <div class="setting-row">
            <div class="setting-row-info">
              <div class="setting-label">Open games in Blank Tab</div>
              <div class="setting-desc">Games open in an about:blank tab ‚Äî hides the URL from content filters</div>
            </div>
            <label class="toggle"><input type="checkbox" id="togBlank" onchange="setSetting('blankTab',this.checked)"><span class="toggle-track"></span></label>
          </div>
          <div class="setting-row">
            <div class="setting-row-info">
              <div class="setting-label">Auto Blank on Load</div>
              <div class="setting-desc">Automatically wraps the whole site in about:blank each session</div>
            </div>
            <label class="toggle"><input type="checkbox" id="togAutoBlank" onchange="setSetting('autoBlank',this.checked)"><span class="toggle-track"></span></label>
          </div>
          <div class="setting-row">
            <div class="setting-row-info">
              <div class="setting-label">Disguise Tab Title</div>
              <div class="setting-desc">Shows "KnowledgeBase ‚Äî Learning Resources" in the browser tab instead of CS Hub</div>
            </div>
            <label class="toggle"><input type="checkbox" id="togDisguiseTitle" onchange="setSetting('disguiseTitle',this.checked)"><span class="toggle-track"></span></label>
          </div>
          <div class="setting-row">
            <div class="setting-row-info">
              <div class="setting-label">Compact Cards</div>
              <div class="setting-desc">Smaller cards so more games fit on screen at once</div>
            </div>
            <label class="toggle"><input type="checkbox" id="togCompact" onchange="setSetting('compact',this.checked)"><span class="toggle-track"></span></label>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Theme</div>
          <div class="theme-grid" id="themeGrid"></div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Accent Colour</div>
          <div class="setting-row" style="flex-direction:column;align-items:flex-start;gap:10px">
            <div class="setting-row-info">
              <div class="setting-label">Custom accent</div>
              <div class="setting-desc">Override the theme's accent colour across the whole site</div>
            </div>
            <div class="accent-picker-row" id="accentPickerRow"></div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Data</div>
          <a class="mini-btn" href="privacy-policy.html" style="display:inline-flex;align-items:center;justify-content:center;text-decoration:none;width:fit-content">Privacy Policy</a>
          <button class="danger-btn" onclick="clearSettings()">
            <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
            <div><div>Clear Saved Settings</div><div class="danger-btn-sub">Resets all preferences and theme to defaults</div></div>
          </button>
        </div>

      </div>
    </div>
  </div>

</div>
<div class="toast" id="toast"></div>

<!-- DISGUISE OVERLAY -->
<div id="disguiseOverlay">
  <div class="dg-topbar">
    <span class="dg-topbar-logo">üìö KnowledgeBase</span>
    <div class="dg-topbar-links">
      <a href="#">Dashboard</a>
      <a href="#">Subjects</a>
      <a href="#">Resources</a>
      <a href="#">My Work</a>
    </div>
  </div>
  <div class="dg-body">
    <div class="dg-sidebar">
      <div class="dg-sb-item active">üìä Dashboard</div>
      <div class="dg-sb-item">üìñ English</div>
      <div class="dg-sb-item">üî¢ Maths</div>
      <div class="dg-sb-item">üî¨ Science</div>
      <div class="dg-sb-item">üåç Geography</div>
      <div class="dg-sb-item">üèõÔ∏è History</div>
      <div class="dg-sb-item">üíª Computing</div>
      <div class="dg-sb-item">üé® Art &amp; Design</div>
    </div>
    <div class="dg-content">
      <div class="dg-heading">Welcome back, Student</div>
      <div class="dg-sub">Here's an overview of your learning progress this week.</div>
      <div class="dg-card-row">
        <div class="dg-card"><div class="dg-card-icon">üìù</div><div class="dg-card-title">Assignments Due</div><div class="dg-card-desc">3 tasks due this week across your subjects</div></div>
        <div class="dg-card"><div class="dg-card-icon">‚úÖ</div><div class="dg-card-title">Completed</div><div class="dg-card-desc">12 tasks completed in the last 7 days</div></div>
        <div class="dg-card"><div class="dg-card-icon">üìà</div><div class="dg-card-title">Progress</div><div class="dg-card-desc">Your average score is 78% this term</div></div>
      </div>
      <div class="dg-card-title" style="margin-bottom:12px;font-size:15px;color:#202124">Recent Activity</div>
      <table class="dg-table">
        <thead><tr><th>Subject</th><th>Task</th><th>Due</th><th>Status</th></tr></thead>
        <tbody>
          <tr><td>Computing</td><td>Binary number systems worksheet</td><td>Today</td><td><span class="dg-badge blue">In Progress</span></td></tr>
          <tr><td>English</td><td>Essay: Of Mice and Men</td><td>Tomorrow</td><td><span class="dg-badge grey">Not Started</span></td></tr>
          <tr><td>Science</td><td>Lab report ‚Äî Photosynthesis</td><td>Fri</td><td><span class="dg-badge green">Submitted</span></td></tr>
          <tr><td>Maths</td><td>Quadratic equations practice</td><td>Next Mon</td><td><span class="dg-badge green">Complete</span></td></tr>
          <tr><td>Geography</td><td>Case study: River erosion</td><td>Next Wed</td><td><span class="dg-badge grey">Not Started</span></td></tr>
        </tbody>
      </table>
      <div style="margin-top:16px;font-size:12px;color:#bbb;text-align:right">Press <b>Ctrl + D</b> to return</div>
    </div>
  </div>
</div>

<!-- PASSWORD MODAL (shown over disguise on first Ctrl+D) -->
<div id="pwOverlay" style="display:none;position:fixed;inset:0;z-index:100000;background:rgba(0,0,0,0.5);align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:12px;padding:28px 32px;width:320px;box-shadow:0 8px 40px rgba(0,0,0,0.25);font-family:Arial,sans-serif">
    <div style="font-size:16px;font-weight:700;color:#202124;margin-bottom:6px">üîí Enter Password</div>
    <div style="font-size:13px;color:#666;margin-bottom:16px">Enter the password to access CS Hub.</div>
    <input id="pwInput" type="password" placeholder="Password" autocomplete="off"
      style="width:100%;box-sizing:border-box;height:38px;border:1.5px solid #d0d0d0;border-radius:7px;padding:0 12px;font-size:14px;outline:none;color:#202124"
      onkeydown="if(event.key==='Enter')checkPassword()">
    <div id="pwError" style="color:#d32f2f;font-size:12px;margin-top:6px;min-height:16px"></div>
    <button onclick="checkPassword()"
      style="margin-top:10px;width:100%;height:38px;background:#1a73e8;border:none;border-radius:7px;color:#fff;font-size:14px;font-weight:600;cursor:pointer">
      Unlock
    </button>
  </div>
</div>

<script src="js/backend.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THEMES=[
  {id:'dark',name:'Dark',colors:['#7c6af7','#3ecf6f','#38c9e8'],vars:{'--bg':'#0f0f13','--surface':'#18181f','--surface2':'#222230','--surface3':'#2a2a3a','--border':'#2e2e40','--accent':'#7c6af7','--accent-hover':'#9585ff','--accent-dim':'rgba(124,106,247,0.15)','--text':'#f0f0f8','--text-2':'#a0a0c0','--text-3':'#606080'}},
  {id:'midnight',name:'Midnight',colors:['#4f8ef7','#38c9e8','#3ecf6f'],vars:{'--bg':'#080c14','--surface':'#0f1520','--surface2':'#162030','--surface3':'#1e2a40','--border':'#1e304a','--accent':'#4f8ef7','--accent-hover':'#7aaaff','--accent-dim':'rgba(79,142,247,0.15)','--text':'#e8f0ff','--text-2':'#8090b0','--text-3':'#4a5a70'}},
  {id:'forest',name:'Forest',colors:['#3ecf6f','#38c9e8','#f0d03a'],vars:{'--bg':'#090f0d','--surface':'#101a14','--surface2':'#182318','--surface3':'#1e2e20','--border':'#223025','--accent':'#3ecf6f','--accent-hover':'#5fe080','--accent-dim':'rgba(62,207,111,0.15)','--text':'#e8f5ec','--text-2':'#80a888','--text-3':'#4a6850'}},
  {id:'rose',name:'Rose',colors:['#e560c8','#f05656','#7c6af7'],vars:{'--bg':'#130a11','--surface':'#1e1018','--surface2':'#2a1522','--surface3':'#33192a','--border':'#3d2035','--accent':'#e560c8','--accent-hover':'#f07fda','--accent-dim':'rgba(229,96,200,0.15)','--text':'#f5e8f2','--text-2':'#b080a8','--text-3':'#705060'}},
  {id:'sunset',name:'Sunset',colors:['#f0873a','#f05656','#f0d03a'],vars:{'--bg':'#110c06','--surface':'#1c1208','--surface2':'#26180e','--surface3':'#301e14','--border':'#3d2a18','--accent':'#f0873a','--accent-hover':'#ffa060','--accent-dim':'rgba(240,135,58,0.15)','--text':'#f5ece0','--text-2':'#b09070','--text-3':'#706040'}},
  {id:'cyberpunk',name:'Cyberpunk',colors:['#f0d03a','#38c9e8','#f05656'],vars:{'--bg':'#050508','--surface':'#0c0c14','--surface2':'#121220','--surface3':'#181828','--border':'#2a2a3e','--accent':'#f0d03a','--accent-hover':'#ffe060','--accent-dim':'rgba(240,208,58,0.12)','--text':'#f0f0ff','--text-2':'#a0a0c8','--text-3':'#505070'}},
  {id:'slate',name:'Slate',colors:['#94a3b8','#38c9e8','#3ecf6f'],vars:{'--bg':'#0a0c10','--surface':'#12151c','--surface2':'#1a1e28','--surface3':'#222634','--border':'#2a2e3e','--accent':'#94a3b8','--accent-hover':'#b0bfd0','--accent-dim':'rgba(148,163,184,0.15)','--text':'#e8eaf0','--text-2':'#8090a8','--text-3':'#505868'}},
  {id:'light',name:'Light',colors:['#7c6af7','#3ecf6f','#f0873a'],vars:{'--bg':'#f2f2f7','--surface':'#ffffff','--surface2':'#ebebf2','--surface3':'#e0e0ea','--border':'#d0d0e0','--accent':'#7c6af7','--accent-hover':'#9585ff','--accent-dim':'rgba(124,106,247,0.1)','--text':'#111120','--text-2':'#505070','--text-3':'#9090a8'}},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACCENT COLOUR PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ACCENT_PRESETS=[
  '#7c6af7','#4f8ef7','#3ecf6f','#38c9e8',
  '#f0873a','#f05656','#e560c8','#f0d03a',
  '#94a3b8','#ff6b6b','#51cf66','#339af0',
];

function hexToRgb(hex){
  const r=parseInt(hex.slice(1,3),16);
  const g=parseInt(hex.slice(3,5),16);
  const b=parseInt(hex.slice(5,7),16);
  return{r,g,b};
}

function lightenHex(hex,amount){
  // amount: 0-1, blends toward white
  const{r,g,b}=hexToRgb(hex);
  const lr=Math.round(r+(255-r)*amount);
  const lg=Math.round(g+(255-g)*amount);
  const lb=Math.round(b+(255-b)*amount);
  return`#${lr.toString(16).padStart(2,'0')}${lg.toString(16).padStart(2,'0')}${lb.toString(16).padStart(2,'0')}`;
}

function applyAccentColour(hex){
  if(!hex){
    // Remove custom accent ‚Äî let theme take over
    const t=THEMES.find(x=>x.id===cfg.theme)||THEMES[0];
    document.documentElement.style.setProperty('--accent',t.vars['--accent']);
    document.documentElement.style.setProperty('--accent-hover',t.vars['--accent-hover']);
    document.documentElement.style.setProperty('--accent-dim',t.vars['--accent-dim']);
    return;
  }
  const{r,g,b}=hexToRgb(hex);
  const hover=lightenHex(hex,0.15);
  document.documentElement.style.setProperty('--accent',hex);
  document.documentElement.style.setProperty('--accent-hover',hover);
  document.documentElement.style.setProperty('--accent-dim',`rgba(${r},${g},${b},0.15)`);
  cfg.customAccent=hex;
  saveCfg();
  syncAccentPicker(hex);
}

function syncAccentPicker(hex){
  document.querySelectorAll('.accent-swatch').forEach(s=>{
    s.classList.toggle('active',s.dataset.color===hex);
  });
  const wrap=document.querySelector('.accent-custom-wrap');
  if(wrap){
    const isPreset=ACCENT_PRESETS.includes(hex);
    wrap.classList.toggle('active',!!hex&&!isPreset);
  }
}

function buildAccentPicker(){
  const row=document.getElementById('accentPickerRow');
  row.innerHTML='';

  // Preset swatches
  ACCENT_PRESETS.forEach(color=>{
    const s=document.createElement('div');
    s.className='accent-swatch'+(cfg.customAccent===color?' active':'');
    s.dataset.color=color;
    s.style.background=color;
    s.title=color;
    s.onclick=()=>{cfg.customAccent=color;saveCfg();applyAccentColour(color);syncAccentPicker(color);}
    row.appendChild(s);
  });

  // Rainbow custom picker
  const wrap=document.createElement('div');
  wrap.className='accent-custom-wrap'+(cfg.customAccent&&!ACCENT_PRESETS.includes(cfg.customAccent)?' active':'');
  wrap.title='Custom colour';
  const inp=document.createElement('input');
  inp.type='color';
  inp.value=cfg.customAccent||'#7c6af7';
  inp.oninput=e=>{cfg.customAccent=e.target.value;saveCfg();applyAccentColour(e.target.value);syncAccentPicker(e.target.value);}
  const btn=document.createElement('div');
  btn.className='accent-custom-btn';
  wrap.appendChild(inp);wrap.appendChild(btn);
  row.appendChild(wrap);

  // Reset swatch
  const reset=document.createElement('div');
  reset.className='accent-swatch';
  reset.style.cssText='background:var(--surface3);border:2px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center';
  reset.title='Reset to theme default';
  reset.textContent='‚Ü∫';
  reset.style.color='var(--text-3)';
  reset.onclick=()=>{cfg.customAccent=null;saveCfg();applyAccentColour(null);syncAccentPicker(null);}
  row.appendChild(reset);
}
const DEFAULTS={theme:'dark',blankTab:false,autoBlank:false,compact:false,disguiseTitle:false,customAccent:null};
let cfg={...DEFAULTS};

function loadCfg(){try{cfg={...DEFAULTS,...JSON.parse(localStorage.getItem('cshub_cfg')||'{}')}}catch(e){cfg={...DEFAULTS}}}
function saveCfg(){localStorage.setItem('cshub_cfg',JSON.stringify(cfg))}

function setSetting(key,val){
  cfg[key]=val; saveCfg();
  if(key==='compact') applyCompact();
  if(key==='disguiseTitle') applyDisguiseTitle();
}

function applyDisguiseTitle(){
  document.title=cfg.disguiseTitle?'KnowledgeBase ‚Äî Learning Resources':'CS Hub';
}

function applyTheme(id){
  const t=THEMES.find(x=>x.id===id)||THEMES[0];
  for(const[k,v]of Object.entries(t.vars)) document.documentElement.style.setProperty(k,v);
  cfg.theme=id; saveCfg();
  document.querySelectorAll('.theme-card').forEach(c=>c.classList.toggle('active',c.dataset.id===id));
  // Re-apply custom accent on top of the new theme
  if(cfg.customAccent)applyAccentColour(cfg.customAccent);
}

function applyCompact(){
  document.getElementById('gameGrid').classList.toggle('compact',cfg.compact);
}

function applyAll(){
  applyTheme(cfg.theme);
  if(cfg.customAccent)applyAccentColour(cfg.customAccent);
  applyCompact();
  applyDisguiseTitle();
  document.getElementById('togBlank').checked=cfg.blankTab;
  document.getElementById('togAutoBlank').checked=cfg.autoBlank;
  document.getElementById('togCompact').checked=cfg.compact;
  document.getElementById('togDisguiseTitle').checked=cfg.disguiseTitle;
  if(cfg.autoBlank&&!sessionStorage.getItem('blanked')){
    sessionStorage.setItem('blanked','1');
    openInBlank();
  }
}

function clearSettings(){
  if(!confirm('Reset all settings to default?')) return;
  localStorage.removeItem('cshub_cfg');
  cfg={...DEFAULTS};
  applyAll();
  buildThemeGrid();
  buildAccentPicker();
  showToast('Settings cleared');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildThemeGrid(){
  const grid=document.getElementById('themeGrid');
  grid.innerHTML='';
  THEMES.forEach(t=>{
    const card=document.createElement('div');
    card.className='theme-card'+(cfg.theme===t.id?' active':'');
    card.dataset.id=t.id;
    card.onclick=()=>applyTheme(t.id);

    const preview=document.createElement('div');
    preview.className='theme-preview';
    preview.style.background=t.vars['--bg'];
    const heights=[65,40,52];
    t.colors.forEach((col,i)=>{
      const bar=document.createElement('div');
      bar.className='tp-bar';
      bar.style.cssText=`background:${col};height:${heights[i]}%`;
      preview.appendChild(bar);
    });
    const chk=document.createElement('div');
    chk.className='theme-check';
    chk.textContent='‚úì';
    preview.appendChild(chk);

    const name=document.createElement('div');
    name.className='theme-name';
    name.style.cssText=`background:${t.vars['--surface2']};color:${t.vars['--text']};border-color:${t.vars['--border']}`;
    name.textContent=t.name;

    card.appendChild(preview);
    card.appendChild(name);
    grid.appendChild(card);
  });
}

function openSettings(){buildThemeGrid();buildAccentPicker();document.getElementById('settingsOverlay').classList.add('open')}
function closeSettings(){document.getElementById('settingsOverlay').classList.remove('open')}
function onOverlayClick(e){if(e.target===e.currentTarget)closeSettings()}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAVOURITES & RECENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFavs(){try{return JSON.parse(localStorage.getItem('cshub_favs')||'[]')}catch(e){return[]}}
function saveFavs(f){localStorage.setItem('cshub_favs',JSON.stringify(f))}
function isFav(id){return getFavs().includes(id)}
function toggleFav(id){
  let f=getFavs();
  if(f.includes(id))f=f.filter(x=>x!==id);else f.unshift(id);
  saveFavs(f);return f.includes(id);
}
function getRecents(){try{return JSON.parse(localStorage.getItem('cshub_recents')||'[]')}catch(e){return[]}}
function addRecent(id){
  let r=getRecents().filter(x=>x!==id);r.unshift(id);r=r.slice(0,10);
  localStorage.setItem('cshub_recents',JSON.stringify(r));
}
function clearRecents(){localStorage.removeItem('cshub_recents');renderRecents();showToast('Recently played cleared')}
function renderRecents(){
  const row=document.getElementById('recentsRow'),section=document.getElementById('recentsSection');
  if(!row)return;
  const ids=getRecents(),games=ids.map(id=>PROJECTS.find(p=>p.id===id)).filter(Boolean);
  section.classList.toggle('show',games.length>0);
  row.innerHTML='';
  games.forEach(p=>{
    const card=document.createElement('div');card.className='recent-card';
    const thumb=document.createElement('div');thumb.className='recent-card-thumb';
    if(p.image){const img=document.createElement('img');img.src=p.image;img.onerror=()=>{thumb.textContent=p.icon||'üéÆ'};thumb.appendChild(img)}
    else thumb.textContent=p.icon||'üéÆ';
    const name=document.createElement('div');name.className='recent-card-name';name.textContent=p.title;
    card.appendChild(thumb);card.appendChild(name);
    card.addEventListener('click',()=>openProject(p));
    row.appendChild(card);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TYPE_KEYS=['all','favourites','sport','simulation','interactive','puzzle','platformer','arcade','action','rpg'];
const CAT_NAMES={all:'All Games',favourites:'Favourites',sport:'Sports',simulation:'Simulation',interactive:'Interactive',puzzle:'Puzzle',platformer:'Platformer',arcade:'Arcade',action:'Action',rpg:'RPG'};

function getDefaults(){return[
  {id:1,title:"Football Sim",type:"sport",engine:"html",icon:"‚öΩ",color:"green",desc:"Interactive football simulation.",url:"/Football/index.html"},
  {id:2,title:"Elements",type:"interactive",engine:"html",icon:"üî¨",color:"cyan",desc:"Explore the periodic table.",url:"/Elements/index.html"},
  {id:3,title:"Mine World",type:"simulation",engine:"html",icon:"‚õèÔ∏è",color:"orange",desc:"Sandbox mining simulation.",url:"/Mine/index.html"},
  {id:4,title:"World Box",type:"simulation",engine:"html",icon:"üåç",color:"pink",desc:"World-building sandbox.",url:"/worldbox/index.html"},
]}

let PROJECTS=[],activeType='all',searchQuery='',currentProject=null,currentEngine='all',activeCollection='all';

function saveBrowseState(){
  localStorage.setItem('cshub_browse',JSON.stringify({type:activeType,sort:currentSort,query:searchQuery,engine:currentEngine,collection:activeCollection}));
}

function loadBrowseState(){
  try{
    const saved=JSON.parse(localStorage.getItem('cshub_browse')||'{}');
    if(TYPE_KEYS.includes(saved.type))activeType=saved.type;
    if(['default','az','za','newest'].includes(saved.sort))currentSort=saved.sort;
    if(['all','html','unity'].includes(saved.engine))currentEngine=saved.engine;
    if(['all','quick','puzzle','classic'].includes(saved.collection))activeCollection=saved.collection;
    if(typeof saved.query==='string')searchQuery=saved.query.trim();
  }catch(e){}
}

function syncSearchInputs(v){
  const val=v??'';
  document.getElementById('searchInput').value=val;
  document.getElementById('spSearchInput').value=val;
  const btn=document.querySelector('.nav-search-btn span:first-of-type');
  if(btn)btn.textContent=val?val:'Search games...';
  if(btn)btn.style.color=val?'var(--text)':'';
}

function clearSearch(){
  if(!searchQuery)return;
  searchQuery='';
  syncSearchInputs('');
  spSearch('');
  filter();
  saveBrowseState();
}

function resetBrowseState(){
  searchQuery='';
  currentSort='default';
  currentEngine='all';
  activeCollection='all';
  document.getElementById('sortSelect').value='default';
  document.getElementById('engineSelect').value='all';
  document.getElementById('collectionSelect').value='all';
  setType('all');
  syncSearchInputs('');
  spSearch('');
  showToast('Filters reset');
}

fetch('/projects.json?nocache='+Date.now())
  .then(r=>r.json()).then(d=>{PROJECTS=d;onLoaded()})
  .catch(()=>{PROJECTS=getDefaults();onLoaded()});

function onLoaded(){
  updateCounts();
  document.getElementById('loadingState').classList.remove('show');
  document.getElementById('sectionHeader').style.display='flex';
  renderRecents();
  document.getElementById('sortSelect').value=currentSort;
  document.getElementById('engineSelect').value=currentEngine;
  document.getElementById('collectionSelect').value=activeCollection;
  syncSearchInputs(searchQuery);
  setType(activeType);
  if(searchQuery)spSearch(searchQuery);
  requestAnimationFrame(()=>movePill(activeType));
}

function updateCounts(){
  const favIds=getFavs();
  TYPE_KEYS.forEach(type=>{
    let n;
    if(type==='all')n=PROJECTS.length;
    else if(type==='favourites')n=favIds.filter(id=>PROJECTS.find(p=>p.id===id)).length;
    else n=PROJECTS.filter(p=>p.type===type).length;
    const s=document.getElementById('count-'+type),f=document.getElementById('fc-'+type);
    if(s)s.textContent=n;if(f)f.textContent=n;
  });
  document.getElementById('navCount').textContent=PROJECTS.length+' games';
}

function renderGrid(items){
  const grid=document.getElementById('gameGrid'),empty=document.getElementById('emptyState');
  grid.innerHTML='';
  if(!items.length){
    empty.classList.add('show');
    if(activeType==='favourites'){document.querySelector('.empty-icon').textContent='‚ù§Ô∏è';document.querySelector('.empty-title').textContent='No favourites yet';document.querySelector('.empty-sub').textContent='Heart a game to save it here'}
    else{document.querySelector('.empty-icon').textContent='üéÆ';document.querySelector('.empty-title').textContent='No games found';document.querySelector('.empty-sub').textContent='Try a different search or category'}
    return;
  }
  empty.classList.remove('show');
  document.getElementById('sectionTitle').textContent=searchQuery?'Search Results':(CAT_NAMES[activeType]||activeType);
  document.getElementById('sectionCount').textContent=items.length+' game'+(items.length!==1?'s':'');

  items.forEach((p,i)=>{
    const card=document.createElement('div');
    card.className='game-card';card.style.animationDelay=Math.min(i*30,300)+'ms';
    const thumb=document.createElement('div');
    if(p.image){
      thumb.className='card-thumb';
      const img=document.createElement('img');img.src=p.image;img.dataset.src=p.image;img.alt=p.title;img.loading='lazy';
      img.onerror=()=>{thumb.innerHTML='';thumb.className='card-thumb bg-'+(p.color||'accent');const fb=document.createElement('span');fb.className='thumb-fallback col-'+(p.color||'accent');fb.textContent=p.icon||'üéÆ';thumb.appendChild(fb);addOverlay(thumb);addFavBtn(thumb,p)};
      thumb.appendChild(img);lazyObserve(img);
    }else{
      thumb.className='card-thumb bg-'+(p.color||'accent');
      const fb=document.createElement('span');fb.className='thumb-fallback col-'+(p.color||'accent');fb.textContent=p.icon||'üéÆ';thumb.appendChild(fb);
    }
    addOverlay(thumb);addFavBtn(thumb,p);
    const badge=document.createElement('span');badge.className='card-badge '+(p.engine==='unity'?'badge-unity':'badge-html');badge.textContent=p.engine==='unity'?'Unity':'HTML5';thumb.appendChild(badge);
    const body=document.createElement('div');body.className='card-body';
    body.innerHTML='<div class="card-title">'+esc(p.title)+'</div>'+(p.desc?'<div class="card-desc">'+esc(p.desc)+'</div>':'')+'<div class="card-meta"><span class="meta-tag type-tag">'+esc(p.type||'game')+'</span></div>';
    card.appendChild(thumb);card.appendChild(body);
    card.addEventListener('click',()=>openProject(p));
    grid.appendChild(card);
  });
  applyCompact();
}

function addFavBtn(thumb,p){
  const btn=document.createElement('button');
  btn.className='fav-btn'+(isFav(p.id)?' faved':'');
  btn.title=isFav(p.id)?'Remove from favourites':'Add to favourites';
  btn.innerHTML='<svg width="13" height="13" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>';
  btn.addEventListener('click',e=>{
    e.stopPropagation();
    const faved=toggleFav(p.id);
    btn.classList.toggle('faved',faved);
    btn.title=faved?'Remove from favourites':'Add to favourites';
    updateCounts();
    showToast(faved?'‚ù§Ô∏è Added to favourites':'Removed from favourites');
    if(activeType==='favourites')filter();
  });
  thumb.appendChild(btn);
}

function addOverlay(t){const o=document.createElement('div');o.className='play-overlay';o.innerHTML='<div class="play-btn"><svg width="16" height="16" fill="#fff" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>';t.appendChild(o)}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function fuzzyMatch(text,q){
  text=(text||'').toLowerCase();
  q=(q||'').toLowerCase().trim();
  if(!q)return true;
  // Direct substring match
  if(text.includes(q))return true;
  // Multi-word: every word in query must appear somewhere in text
  const words=q.split(/\s+/).filter(Boolean);
  if(words.length>1)return words.every(w=>text.includes(w));
  return false;
}
function collectionMatch(p){
  if(activeCollection==='all')return true;
  if(activeCollection==='quick')return (p.desc||'').length<70;
  if(activeCollection==='puzzle')return p.type==='puzzle';
  if(activeCollection==='classic')return p.id<=40;
  return true;
}
const globalPlays={};
const globalRatings={};

function getPlays(){return globalPlays}
function getRatings(){return globalRatings}
function getUserRatings(){try{return JSON.parse(localStorage.getItem('cshub_user_ratings')||'{}')}catch(e){return {}}}

async function countApiGet(key){
  return window.CSHubBackend.getStat(key);
}

async function countApiUpdate(key,amount){
  return window.CSHubBackend.updateStat(key,amount);
}

async function ensureProjectStatsLoaded(id){
  if(globalPlays[id]!==undefined&&globalRatings[id])return;
  const [plays,up,down]=await Promise.all([
    globalPlays[id]!==undefined?Promise.resolve(globalPlays[id]):countApiGet('plays-'+id),
    globalRatings[id]?.up!==undefined?Promise.resolve(globalRatings[id].up):countApiGet('rating-up-'+id),
    globalRatings[id]?.down!==undefined?Promise.resolve(globalRatings[id].down):countApiGet('rating-down-'+id)
  ]);
  globalPlays[id]=plays;
  globalRatings[id]={up,down};
}
function setEngineFilter(){currentEngine=document.getElementById('engineSelect').value;filter();saveBrowseState();}
function setCollectionFilter(){activeCollection=document.getElementById('collectionSelect').value;filter();saveBrowseState();}

function filter(){
  let f=PROJECTS;
  if(activeType==='favourites'){const ids=getFavs();f=ids.map(id=>PROJECTS.find(p=>p.id===id)).filter(Boolean)}
  else if(activeType!=='all')f=f.filter(p=>p.type===activeType);
  if(currentEngine!=='all')f=f.filter(p=>(p.engine||'html')===currentEngine);
  f=f.filter(collectionMatch);
  if(searchQuery){const q=searchQuery.toLowerCase();f=f.filter(p=>fuzzyMatch(p.title,q)||fuzzyMatch(p.type||'',q)||fuzzyMatch(p.desc||'',q));}
  if(currentSort==='az')f=[...f].sort((a,b)=>a.title.localeCompare(b.title));
  else if(currentSort==='za')f=[...f].sort((a,b)=>b.title.localeCompare(a.title));
  else if(currentSort==='newest')f=[...f].sort((a,b)=>b.id-a.id);
  renderGrid(f);
}


function movePill(type){
  const bar=document.getElementById('filterBar');
  const pill=document.getElementById('filterPill');
  const chip=bar.querySelector(`.chip[data-type="${type}"]`);
  if(!chip||!pill)return;
  const barRect=bar.getBoundingClientRect();
  const chipRect=chip.getBoundingClientRect();
  pill.style.left=(chipRect.left-barRect.left+bar.scrollLeft)+'px';
  pill.style.width=chipRect.width+'px';
}

function setType(type){
  activeType=type;
  document.querySelectorAll('.chip').forEach(b=>b.classList.toggle('active',b.dataset.type===type));
  document.querySelectorAll('.sb-item[data-type]').forEach(b=>b.classList.toggle('active',b.dataset.type===type));
  movePill(type);
  filter();
  saveBrowseState();
}

function playRandom(){
  if(!PROJECTS.length)return;
  const p=PROJECTS[Math.floor(Math.random()*PROJECTS.length)];
  openProject(p);showToast('üé≤ '+p.title);
}

const homeView=document.getElementById('homeView');
const scrollBtn=document.getElementById('scrollTopBtn');
homeView.addEventListener('scroll',()=>{scrollBtn.classList.toggle('show',homeView.scrollTop>300)});
function scrollToTop(){homeView.scrollTo({top:0,behavior:'smooth'})}

document.addEventListener('keydown',e=>{
  const typing=document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='TEXTAREA';
  // Ctrl+D toggles disguise from anywhere
  if(e.ctrlKey&&e.key.toLowerCase()==='d'){e.preventDefault();
    const dg=document.getElementById('disguiseOverlay');
    dg.classList.contains('show')?tryDeactivateDisguise():activateDisguise();
    return;
  }
  if(document.getElementById('disguiseOverlay').classList.contains('show'))return;
  if(e.key==='/'&&!typing){e.preventDefault();openSearchPanel()}
  if(e.key==='r'&&!typing&&!e.ctrlKey&&!e.metaKey)playRandom();
  if((e.key==='?'||e.key==='h')&&!typing)openHotkeys();
  if(e.key==='f'&&!typing&&document.getElementById('playView').classList.contains('show')){
    e.preventDefault();
    const f=document.getElementById('projectFrame');
    if(f.requestFullscreen)f.requestFullscreen();
    else if(f.webkitRequestFullscreen)f.webkitRequestFullscreen();
  }
  if(e.key==='Escape'){
    closeSettings();
    closeSearchPanel();
    closeHotkeys();
    // Panic key: escape from game back to home
    if(document.getElementById('playView').classList.contains('show'))goHome();
  }
});

document.querySelector('.sidebar').addEventListener('click',e=>{const b=e.target.closest('.sb-item[data-type]');if(b)setType(b.dataset.type)});
document.querySelector('.filter-bar').addEventListener('click',e=>{const b=e.target.closest('.chip');if(b)setType(b.dataset.type)});

document.getElementById('searchInput').addEventListener('input',e=>{
  const val=e.target.value;
  searchQuery=val.trim();
  syncSearchInputs(val);
  spSearch(val);
  filter();
  saveBrowseState();
  if(!document.getElementById('searchPanelOverlay').classList.contains('open'))openSearchPanel();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSearchPanel(){
  const overlay=document.getElementById('searchPanelOverlay');
  overlay.classList.add('open');
  setTimeout(()=>document.getElementById('spSearchInput').focus(),50);
  buildSpTopGames();
  // Sync chip state
  document.querySelectorAll('.sp-chip').forEach(c=>c.classList.toggle('active',c.dataset.type===activeType));
}

function closeSearchPanel(){
  document.getElementById('searchPanelOverlay').classList.remove('open');
  document.getElementById('searchInput').blur();
}

function buildSpTopGames(){
  const grid=document.getElementById('spTopGames');
  if(grid.children.length>0)return; // already built
  // Pick first 9 games that have images, else any 9
  const pool=[...PROJECTS].filter(p=>p.image).slice(0,9);
  if(pool.length<9)[...PROJECTS].slice(0,9-pool.length).forEach(p=>{if(!pool.find(x=>x.id===p.id))pool.push(p)});
  pool.slice(0,9).forEach(p=>{
    const card=document.createElement('div');
    card.className='sp-game-card';
    if(p.image){
      const img=document.createElement('img');img.src=p.image;img.alt=p.title;
      img.onerror=()=>{card.innerHTML='';const fb=document.createElement('div');fb.className='sp-thumb-fallback bg-'+(p.color||'accent');fb.textContent=p.icon||'üéÆ';card.appendChild(fb);const nm=document.createElement('div');nm.className='sp-game-name';nm.textContent=p.title;card.appendChild(nm)};
      card.appendChild(img);
    }else{
      const fb=document.createElement('div');fb.className='sp-thumb-fallback bg-'+(p.color||'accent');fb.textContent=p.icon||'üéÆ';card.appendChild(fb);
    }
    const nm=document.createElement('div');nm.className='sp-game-name';nm.textContent=p.title;card.appendChild(nm);
    card.addEventListener('click',()=>{closeSearchPanel();openProject(p)});
    grid.appendChild(card);
  });
}

function spSearch(q){
  const dflt=document.getElementById('spDefault');
  const res=document.getElementById('spResults');
  const list=document.getElementById('spResultsList');
  const label=document.getElementById('spResultsLabel');
  if(!q){dflt.style.display='';res.style.display='none';return}
  dflt.style.display='none';res.style.display='';
  const ql=q.toLowerCase();
  let matches=PROJECTS.filter(p=>fuzzyMatch(p.title,ql)||fuzzyMatch(p.type||'',ql)||fuzzyMatch(p.desc||'',ql));
  label.textContent=matches.length+' result'+(matches.length!==1?'s':'');
  list.innerHTML='';
  if(!matches.length){list.innerHTML='<div class="sp-no-results">No games found for "'+esc(q)+'"</div>';return}
  matches.slice(0,30).forEach(p=>{
    const item=document.createElement('div');item.className='sp-result-item';
    const thumb=document.createElement('div');
    if(p.image){
      thumb.className='sp-result-thumb';
      const img=document.createElement('img');img.src=p.image;
      img.onerror=()=>{thumb.className='sp-result-thumb bg-'+(p.color||'accent');thumb.innerHTML='<span style="font-size:18px">'+(p.icon||'üéÆ')+'</span>'};
      thumb.appendChild(img);lazyObserve(img);
    }else{
      thumb.className='sp-result-thumb bg-'+(p.color||'accent');
      thumb.innerHTML='<span style="font-size:18px">'+(p.icon||'üéÆ')+'</span>';
    }
    const info=document.createElement('div');info.className='sp-result-info';
    info.innerHTML='<div class="sp-result-title">'+esc(p.title)+'</div><div class="sp-result-type">'+(p.type||'game')+'</div>';
    item.appendChild(thumb);item.appendChild(info);
    item.addEventListener('click',()=>{closeSearchPanel();openProject(p)});
    list.appendChild(item);
  });
}

// Panel search input
document.getElementById('spSearchInput').addEventListener('input',e=>{
  const v=e.target.value;
  searchQuery=v.trim();
  syncSearchInputs(v);
  spSearch(v);
  filter();
  saveBrowseState();
});

// Panel category chips
document.getElementById('spCategoryChips').addEventListener('click',e=>{
  const chip=e.target.closest('.sp-chip');
  if(!chip)return;
  const type=chip.dataset.type;
  setType(type);
  document.querySelectorAll('.sp-chip').forEach(c=>c.classList.toggle('active',c.dataset.type===type));
  closeSearchPanel();
});



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProject(project){
  incPlay(project.id);
  if(cfg.blankTab){openInBlank(project.url);return}
  currentProject=project;
  addRecent(project.id);
  renderRecents();
  document.title=project.title+' ‚Äî CS Hub';
  document.getElementById('homeView').style.display='none';
  document.getElementById('playView').classList.add('show');
  document.getElementById('playName').textContent=project.title;
  document.getElementById('playType').textContent=project.type||'game';
  renderRelated(project);
  // Update fav button state
  const pfb=document.getElementById('playFavBtn');
  pfb.classList.toggle('faved',isFav(project.id));
  const loader=document.getElementById('iframeLoader');
  loader.classList.remove('hidden');
  const prog=document.getElementById('iframeProgress');
  prog.className='iframe-progress running';
  const frame=document.getElementById('projectFrame');
  frame.onload=()=>{
    loader.classList.add('hidden');
    prog.className='iframe-progress done';
    setTimeout(()=>prog.className='iframe-progress',600);
    frame.focus();
  };
  frame.src=project.url;

  const list=document.getElementById('sidebarList');
  list.innerHTML='';
  PROJECTS.forEach(p=>{
    const isNow=p.id===project.id;
    const item=document.createElement('div');
    item.className='ps-card'+(isNow?' active':'');
    const psThumb=document.createElement('div');
    if(p.image){
      psThumb.className='ps-thumb';
      const img=document.createElement('img');img.src=p.image;
      img.onerror=()=>{psThumb.className='ps-thumb bg-'+(p.color||'accent');psThumb.innerHTML='<span class="col-'+(p.color||'accent')+'">'+(p.icon||'üéÆ')+'</span>'};
      psThumb.appendChild(img);
    }else{
      psThumb.className='ps-thumb bg-'+(p.color||'accent');
      psThumb.innerHTML='<span class="col-'+(p.color||'accent')+'">'+(p.icon||'üéÆ')+'</span>';
    }
    const info=document.createElement('div');info.className='ps-info';
    info.innerHTML='<div class="ps-title">'+esc(p.title)+'</div><div class="ps-type">'+(p.type||'game')+'</div>'+(isNow?'<div class="ps-now">‚ñ∂ Playing</div>':'');
    item.appendChild(psThumb);item.appendChild(info);
    if(!isNow)item.addEventListener('click',()=>openProject(p));
    list.appendChild(item);
  });
  startPlayTimer();
}

function togglePlayFav(){
  if(!currentProject)return;
  const faved=toggleFav(currentProject.id);
  const btn=document.getElementById('playFavBtn');
  btn.classList.toggle('faved',faved);
  updateCounts();
  showToast(faved?'‚ù§Ô∏è Added to favourites':'Removed from favourites');
}

function goHome(){
  stopPlayTimer();
  document.getElementById('projectFrame').src='';
  document.getElementById('playView').classList.remove('show');
  document.getElementById('homeView').style.display='flex';
  document.title='CS Hub';
  currentProject=null;
}

document.getElementById('fsBtn').addEventListener('click',()=>{
  const f=document.getElementById('projectFrame');
  if(f.requestFullscreen)f.requestFullscreen();
  else if(f.webkitRequestFullscreen)f.webkitRequestFullscreen();
});

// Focus iframe on click so keyboard/mouse controls reach the game
document.querySelector('.iframe-col').addEventListener('click',()=>{
  document.getElementById('projectFrame').focus();
});

function openInBlank(gameUrl){
  const w=window.open('about:blank','_blank');
  w.document.open();
  const src=gameUrl??(currentProject?currentProject.url:window.location.href);
  w.document.write('<!DOCTYPE html><html><head><style>*{margin:0;padding:0}iframe{border:none;width:100vw;height:100vh;display:block}</style></head><body><iframe src="'+src+'" sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-modals"></iframe></body></html>');
  w.document.close();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DISGUISE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PW='cshub123'; // ‚Üê change this to your password
const PW_KEY='cshub_unlocked';

function activateDisguise(){
  document.getElementById('disguiseOverlay').classList.add('show');
  document.title='KnowledgeBase ‚Äî Learning Resources';
}
function deactivateDisguise(){
  document.getElementById('disguiseOverlay').classList.remove('show');
  applyDisguiseTitle();
}
function tryDeactivateDisguise(){
  if(localStorage.getItem(PW_KEY)==='1'){deactivateDisguise();return;}
  const ov=document.getElementById('pwOverlay');
  ov.style.display='flex';
  document.getElementById('pwInput').value='';
  document.getElementById('pwError').textContent='';
  setTimeout(()=>document.getElementById('pwInput').focus(),50);
}
function checkPassword(){
  const val=document.getElementById('pwInput').value;
  if(val===PW){
    localStorage.setItem(PW_KEY,'1');
    document.getElementById('pwOverlay').style.display='none';
    deactivateDisguise();
  }else{
    document.getElementById('pwError').textContent='Incorrect password. Try again.';
    document.getElementById('pwInput').value='';
    document.getElementById('pwInput').focus();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAY TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let playTimerInterval=null;
let playStartTime=0;
function startPlayTimer(){
  stopPlayTimer();
  playStartTime=Date.now();
  const el=document.getElementById('playTimer');
  el.textContent='0:00';
  playTimerInterval=setInterval(()=>{
    const secs=Math.floor((Date.now()-playStartTime)/1000);
    const m=Math.floor(secs/60);
    const s=secs%60;
    el.textContent=m+':'+(s<10?'0':'')+s;
  },1000);
}
function stopPlayTimer(){
  clearInterval(playTimerInterval);
  playTimerInterval=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOTKEYS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openHotkeys(){document.getElementById('hotkeysOverlay').classList.add('open')}
function closeHotkeys(){document.getElementById('hotkeysOverlay').classList.remove('open')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WELCOME POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showWelcomeIfFirstVisit(){
  if(!localStorage.getItem('cshub_visited')){
    document.getElementById('welcomeOverlay').classList.add('open');
  }
}
function dismissWelcome(){
  localStorage.setItem('cshub_visited','1');
  document.getElementById('welcomeOverlay').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSort='default';
function setSortAndRender(){
  currentSort=document.getElementById('sortSelect').value;
  filter();
  saveBrowseState();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidebar(){
  const sb=document.querySelector('.sidebar');
  sb.classList.toggle('collapsed');
  localStorage.setItem('cshub_sb',sb.classList.contains('collapsed')?'0':'1');
}
function initSidebar(){
  if(localStorage.getItem('cshub_sb')==='0')document.querySelector('.sidebar').classList.add('collapsed');
}


function lazyObserve(img){
  if(!img.dataset.src)return;
  if(!('IntersectionObserver' in window)){img.src=img.dataset.src;return;}
  if(!window._imgObs){window._imgObs=new IntersectionObserver(entries=>entries.forEach(en=>{if(en.isIntersecting){const el=en.target;if(el.dataset.src)el.src=el.dataset.src;window._imgObs.unobserve(el);}}),{rootMargin:'120px'});}
  window._imgObs.observe(img);
}
async function rateGame(id,vote){
  const ratings=getRatings();
  const userRatings=getUserRatings();
  if(!ratings[id])ratings[id]={up:0,down:0};
  const previousVote=userRatings[id];

  if(previousVote===vote){
    ratings[id][vote]=Math.max(0,(ratings[id][vote]||0)-1);
    await countApiUpdate('rating-'+vote+'-'+id,-1);
    delete userRatings[id];
    showToast('Rating removed');
  }else{
    if(previousVote){
      ratings[id][previousVote]=Math.max(0,(ratings[id][previousVote]||0)-1);
      await countApiUpdate('rating-'+previousVote+'-'+id,-1);
    }
    ratings[id][vote]=(ratings[id][vote]||0)+1;
    await countApiUpdate('rating-'+vote+'-'+id,1);
    userRatings[id]=vote;
    showToast(previousVote?'Rating updated':'Thanks for rating');
  }

  localStorage.setItem('cshub_user_ratings',JSON.stringify(userRatings));
  filter();
}
async function incPlay(id){const p=getPlays();p[id]=(p[id]||0)+1;await countApiUpdate('plays-'+id,1);}
function incOpen(){const a=JSON.parse(localStorage.getItem('cshub_analytics')||'{"opens":0}');a.opens=(a.opens||0)+1;localStorage.setItem('cshub_analytics',JSON.stringify(a));}
function openSuggestionIssue(){
  window.open('https://github.com/Explicabler/Explicabler.github.io/issues','_blank','noopener');
  showToast('Redirecting to Suggestion/Issue tracker');
}
function openAnalyticsModal(){
  const opens=JSON.parse(localStorage.getItem('cshub_analytics')||'{"opens":0}').opens;
  const recentIds=getRecents();
  const recentTitles=recentIds.map(id=>PROJECTS.find(p=>p.id===id)?.title).filter(Boolean).slice(0,5);
  const favCount=getFavs().filter(id=>PROJECTS.find(p=>p.id===id)).length;
  const playedCount=recentIds.length;
  document.getElementById('analyticsBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">'+
    '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--accent)">'+opens+'</div><div style="font-size:10px;color:var(--text-3);margin-top:2px;font-weight:600">SESSIONS</div></div>'+
    '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--green)">'+playedCount+'</div><div style="font-size:10px;color:var(--text-3);margin-top:2px;font-weight:600">PLAYED</div></div>'+
    '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--red)">'+favCount+'</div><div style="font-size:10px;color:var(--text-3);margin-top:2px;font-weight:600">FAVOURITES</div></div>'+
    '</div>'+
    '<div style="font-size:11px;font-weight:700;color:var(--text-3);letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px">Recently Played</div>'+
    '<div style="display:flex;flex-direction:column;gap:4px">'+
    (recentTitles.length?recentTitles.map((t,i)=>'<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px"><span style="font-size:10px;font-weight:700;color:var(--text-3);width:14px">'+(i+1)+'</span><span style="font-size:12px;font-weight:600;color:var(--text)">'+esc(t)+'</span></div>').join(''):'<div style="text-align:center;padding:16px;color:var(--text-3);font-size:12px">No games played yet</div>')+
    '</div>';
  document.getElementById('analyticsOverlay').classList.add('open');
}
function closeAnalyticsModal(){document.getElementById('analyticsOverlay').classList.remove('open');}
function renderRelated(project){
  const rel=PROJECTS.filter(p=>p.id!==project.id&&(p.type===project.type||p.engine===project.engine)).slice(0,6);
  const list=document.getElementById('relatedList');list.innerHTML='';
  rel.forEach(p=>{const item=document.createElement('div');item.className='ps-card';item.innerHTML='<div class="ps-info"><div class="ps-title">'+esc(p.title)+'</div><div class="ps-type">'+esc(p.type||'game')+'</div></div>';item.onclick=()=>openProject(p);list.appendChild(item);});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
incOpen();
loadCfg();
loadBrowseState();
applyAll();
initSidebar();
showWelcomeIfFirstVisit();
// Always start on the school disguise page
activateDisguise();
</script>
</body>
</html>
