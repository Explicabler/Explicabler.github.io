<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d14;
    --surface: #16161f;
    --surface2: #1e1e2a;
    --border: #2a2a3e;
    --accent: #6c63ff;
    --red: #ff4f4f;
    --green: #42f55a;
    --yellow: #f5e642;
    --cyan: #42e8f5;
    --orange: #f5a442;
    --pink: #f542c8;
    --text: #e0e0ff;
    --text-dim: #6060a0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'VT323', monospace;
    font-size: 18px;
    min-height: 100vh;
  }

  /* ===== LOGIN SCREEN ===== */
  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
  }

  .login-box {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 40px;
    width: 340px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }

  .login-title {
    font-family: 'Press Start 2P', monospace;
    font-size: 11px;
    color: var(--accent);
    text-shadow: 0 0 14px var(--accent);
    line-height: 1.8;
  }

  .login-sub {
    font-size: 15px;
    color: var(--text-dim);
    letter-spacing: 2px;
  }

  .login-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'VT323', monospace;
    font-size: 20px;
    padding: 10px 14px;
    outline: none;
    text-align: center;
    letter-spacing: 4px;
    transition: border-color 0.2s;
    width: 100%;
  }

  .login-input:focus { border-color: var(--accent); }

  .login-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    padding: 12px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: opacity 0.15s;
  }

  .login-btn:hover { opacity: 0.85; }

  .login-error {
    color: var(--red);
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    display: none;
  }

  .login-error.show { display: block; }

  /* ===== ADMIN PANEL ===== */
  #adminPanel { display: none; }
  #adminPanel.show { display: block; }

  /* Top bar */
  .admin-nav {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .admin-logo {
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: var(--accent);
    text-shadow: 0 0 12px var(--accent);
  }

  .admin-nav-right {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .nav-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text);
    font-family: 'Press Start 2P', monospace;
    font-size: 7px;
    padding: 7px 12px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 1px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .nav-btn:hover { border-color: var(--accent); color: var(--accent); }
  .nav-btn.danger:hover { border-color: var(--red); color: var(--red); }

  /* Main layout */
  .admin-body {
    max-width: 1100px;
    margin: 0 auto;
    padding: 28px 24px;
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 24px;
    align-items: start;
  }

  /* ===== FORM PANEL ===== */
  .form-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    position: sticky;
    top: 76px;
  }

  .panel-header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 14px 18px;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .panel-header span { color: var(--accent); }

  .form-body {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .form-row { display: flex; flex-direction: column; gap: 6px; }

  .form-row label {
    font-family: 'Press Start 2P', monospace;
    font-size: 7px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  .form-row input,
  .form-row select,
  .form-row textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text);
    font-family: 'VT323', monospace;
    font-size: 18px;
    padding: 9px 12px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  .form-row input:focus,
  .form-row select:focus,
  .form-row textarea:focus { border-color: var(--accent); }

  .form-row select option { background: var(--surface2); }
  .form-row textarea { resize: vertical; min-height: 70px; }

  /* Icon picker */
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
  }

  .icon-opt {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    background: var(--surface2);
    transition: all 0.1s;
  }

  .icon-opt:hover { border-color: var(--border); transform: scale(1.1); }
  .icon-opt.selected { border-color: var(--accent); background: rgba(108,99,255,0.2); }

  /* Color picker */
  .color-grid {
    display: flex;
    gap: 8px;
  }

  .color-opt {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.1s;
  }
  .color-opt:hover { transform: scale(1.15); }
  .color-opt.selected { border-color: #fff; transform: scale(1.15); }

  /* Two col row */
  .form-2col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* Submit */
  .submit-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    padding: 13px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: opacity 0.15s;
    width: 100%;
  }
  .submit-btn:hover { opacity: 0.85; }

  .cancel-edit-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-dim);
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    padding: 13px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
    width: 100%;
    display: none;
  }
  .cancel-edit-btn:hover { border-color: var(--red); color: var(--red); }
  .cancel-edit-btn.show { display: block; }

  /* ===== PROJECT LIST PANEL ===== */
  .list-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .list-header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .list-title {
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  .list-count {
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    color: var(--accent);
  }

  .project-list { padding: 12px; display: flex; flex-direction: column; gap: 8px; }

  .list-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    transition: border-color 0.15s;
  }

  .list-item:hover { border-color: var(--accent); }

  .list-thumb {
    width: 52px;
    height: 40px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }

  .list-info { flex: 1; min-width: 0; }

  .list-name {
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    color: var(--text);
    margin-bottom: 4px;
  }

  .list-meta { font-size: 14px; color: var(--text-dim); }

  .list-url {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
  }

  .list-actions { display: flex; gap: 6px; flex-shrink: 0; }

  .act-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    font-family: 'Press Start 2P', monospace;
    font-size: 7px;
    padding: 6px 10px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .act-btn.edit:hover { border-color: var(--accent); color: var(--accent); }
  .act-btn.del:hover  { border-color: var(--red); color: var(--red); }

  .empty-list {
    padding: 40px;
    text-align: center;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    color: var(--text-dim);
    line-height: 2.5;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 10px;
    padding: 12px 20px;
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    color: var(--accent);
    box-shadow: 0 4px 24px rgba(108,99,255,0.3);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
  }

  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { border-color: var(--red); color: var(--red); box-shadow: 0 4px 24px rgba(255,79,79,0.3); }

  /* BG helpers */
  .bg-cyan   { background: rgba(66,232,245,0.15); }
  .bg-pink   { background: rgba(245,66,200,0.15); }
  .bg-green  { background: rgba(66,245,90,0.15); }
  .bg-orange { background: rgba(245,164,66,0.15); }
  .bg-yellow { background: rgba(245,230,66,0.15); }
  .bg-accent { background: rgba(108,99,255,0.15); }

  @media (max-width: 780px) {
    .admin-body { grid-template-columns: 1fr; }
    .form-panel { position: static; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-title">‚¨õ ADMIN<br>PANEL</div>
    <div class="login-sub">ENTER PASSWORD</div>
    <input class="login-input" type="password" id="passInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <button class="login-btn" onclick="tryLogin()">‚ñ∂ LOGIN</button>
    <div class="login-error" id="loginError">‚úï WRONG PASSWORD</div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <div class="admin-nav">
    <div class="admin-logo">‚¨õ ADMIN PANEL</div>
    <div class="admin-nav-right">
      <a href="index.html" class="nav-btn">üè† VIEW SITE</a>
      <button class="nav-btn danger" onclick="logout()">‚úï LOGOUT</button>
    </div>
  </div>

  <div class="admin-body">

    <!-- EDIT FORM -->
    <div class="form-panel">
      <div class="panel-header">
        <span id="formMode">SELECT A PROJECT TO EDIT</span>
      </div>
      <div class="form-body" id="formBody">

        <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:var(--text-dim);line-height:2.2;padding:12px 0;">
          ‚Üê CLICK ‚úè EDIT ON A PROJECT<br><br>
          CHANGES ARE SAVED AS A<br>
          meta.json INSIDE THE FOLDER
        </div>

        <input type="hidden" id="editingFolder" />

        <div class="form-row" id="editFields" style="display:none;flex-direction:column;gap:14px;">

          <div class="form-row">
            <label>DISPLAY TITLE</label>
            <input type="text" id="fTitle" placeholder="e.g. FOOTBALL SIM" />
          </div>

          <div class="form-2col">
            <div class="form-row">
              <label>TYPE</label>
              <select id="fType">
                <option value="sport">Sport</option>
                <option value="simulation">Simulation</option>
                <option value="interactive">Interactive</option>
                <option value="puzzle">Puzzle</option>
                <option value="platformer">Platformer</option>
                <option value="action">Action</option>
                <option value="arcade">Arcade</option>
                <option value="rpg">RPG</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-row">
              <label>ENGINE</label>
              <select id="fEngine">
                <option value="html">HTML5 / JS</option>
                <option value="unity">Unity / WebGL</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <label>DESCRIPTION</label>
            <textarea id="fDesc" placeholder="Short description..."></textarea>
          </div>

          <div class="form-row">
            <label>THUMBNAIL IMAGE URL (optional)</label>
            <input type="text" id="fImage" placeholder="e.g. /BTD5/thumb.png or https://..." oninput="previewImage(this.value)" />
            <div id="imgPreview" style="margin-top:8px;display:none;">
              <img id="imgPreviewImg" src="" style="width:100%;height:120px;object-fit:cover;border-radius:8px;border:1px solid var(--border);" />
              <div style="font-family:'Press Start 2P',monospace;font-size:7px;color:var(--green);margin-top:6px;">‚úî IMAGE LOADED</div>
            </div>
            <div style="font-family:'Press Start 2P',monospace;font-size:7px;color:var(--text-dim);margin-top:6px;line-height:2;">
              LEAVE BLANK TO USE ICON + COLOUR.<br>
              TIP: PUT A thumb.png IN YOUR GAME FOLDER.
            </div>
          </div>

          <div class="form-row" id="iconSection">
            <label>FALLBACK ICON (used if no image)</label>
            <div class="icon-grid" id="iconGrid"></div>
            <input type="hidden" id="fIcon" value="‚≠ê" />
          </div>

          <div class="form-row" id="colorSection">
            <label>CARD COLOUR (used if no image)</label>
            <div class="color-grid" id="colorGrid"></div>
            <input type="hidden" id="fColor" value="accent" />
          </div>

          <button class="submit-btn" onclick="saveMeta()">‚úî SAVE CHANGES</button>
          <button class="cancel-edit-btn show" onclick="cancelEdit()">‚úï CANCEL</button>
        </div>

      </div>
    </div>

    <!-- PROJECT LIST -->
    <div class="list-panel">
      <div class="list-header">
        <span class="list-title">DETECTED PROJECTS</span>
        <span class="list-count" id="listCount">scanning...</span>
      </div>
      <div style="padding:10px 14px;font-family:'Press Start 2P',monospace;font-size:7px;color:var(--text-dim);line-height:2;border-bottom:1px solid var(--border);">
        FOLDERS WITH index.html ARE AUTO-DETECTED.<br>
        ADD A FOLDER ‚Üí RESTART SERVER ‚Üí APPEARS HERE.
      </div>
      <div class="project-list" id="projectList"></div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const ICONS = ["‚öΩ","üî¨","‚õèÔ∏è","üåç","üöÄ","üß©","‚öîÔ∏è","üèÉ","üêç","üëæ","üéØ","üèÜ","üí°","üåä","üî•","‚ùÑÔ∏è","‚ö°","üéÆ","üèóÔ∏è","üî≠","üß¨","üåã","üé≤","üõ∏","‚úàÔ∏è","üåª","üóº","üèéÔ∏è","üéà","‚≠ê"];
const COLORS = [
  { key: "accent", hex: "#6c63ff" },
  { key: "cyan",   hex: "#42e8f5" },
  { key: "green",  hex: "#42f55a" },
  { key: "orange", hex: "#f5a442" },
  { key: "pink",   hex: "#f542c8" },
  { key: "yellow", hex: "#f5e642" },
];

function tryLogin() {
  const val = document.getElementById("passInput").value;
  fetch('/auth', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: val })
  }).then(res => {
    if (res.status === 401) {
      document.getElementById("loginError").classList.add("show");
      document.getElementById("passInput").value = "";
    } else {
      sessionStorage.setItem("adminPass", val);
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("adminPanel").classList.add("show");
      renderAll();
    }
  }).catch(() => {
    sessionStorage.setItem("adminPass", val);
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("adminPanel").classList.add("show");
    renderAll();
  });
}

document.getElementById("passInput").addEventListener("keydown", e => {
  if (e.key === "Enter") tryLogin();
});

function logout() {
  document.getElementById("adminPanel").classList.remove("show");
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("passInput").value = "";
  sessionStorage.removeItem("adminPass");
}

async function loadProjects() {
  const res = await fetch('/projects.json?nocache=' + Date.now());
  return await res.json();
}

async function renderAll() {
  const projects = await loadProjects();
  const list = document.getElementById("projectList");
  document.getElementById("listCount").textContent = projects.length + " DETECTED";

  if (!projects.length) {
    list.innerHTML = '<div class="empty-list">üìÇ<br><br>NO FOLDERS FOUND<br><br>ADD A FOLDER WITH<br>AN index.html INSIDE</div>';
    return;
  }

  list.innerHTML = "";
  projects.forEach(p => {
    const folder = decodeURIComponent(p.url.split('/')[1]);
    const item = document.createElement("div");
    item.className = "list-item";
    const pJson = JSON.stringify(p).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    item.innerHTML =
      '<div class="list-thumb bg-' + p.color + '">' + p.icon + '</div>' +
      '<div class="list-info">' +
        '<div class="list-name">' + p.title + '</div>' +
        '<div class="list-meta">' + p.type.toUpperCase() + ' ¬∑ ' + (p.engine === "unity" ? "UNITY" : "HTML5") + '</div>' +
        '<div class="list-url">üìÅ ' + folder + '</div>' +
      '</div>' +
      '<div class="list-actions">' +
        '<button class="act-btn edit" onclick=\'editProject("' + folder + '", ' + pJson + ')\'>‚úè EDIT</button>' +
      '</div>';
    list.appendChild(item);
  });
}

function editProject(folder, p) {
  document.getElementById("editingFolder").value = folder;
  document.getElementById("formMode").textContent = "EDITING: " + folder.toUpperCase();
  document.getElementById("fTitle").value  = p.title;
  document.getElementById("fType").value   = p.type;
  document.getElementById("fEngine").value = p.engine;
  document.getElementById("fDesc").value   = p.desc || "";
  document.getElementById("fIcon").value   = p.icon;
  document.getElementById("fColor").value  = p.color;
  const img = p.image || "";
  document.getElementById("fImage").value  = img;
  previewImage(img);
  document.getElementById("editFields").style.display = "flex";
  document.querySelector("#formBody > div").style.display = "none";
  buildPickers();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function cancelEdit() {
  document.getElementById("editingFolder").value = "";
  document.getElementById("formMode").textContent = "SELECT A PROJECT TO EDIT";
  document.getElementById("editFields").style.display = "none";
  document.querySelector("#formBody > div").style.display = "block";
}

async function saveMeta() {
  const folder = document.getElementById("editingFolder").value;
  if (!folder) { showToast("NO PROJECT SELECTED!", true); return; }
  const meta = {
    title:  document.getElementById("fTitle").value.trim().toUpperCase(),
    type:   document.getElementById("fType").value,
    engine: document.getElementById("fEngine").value,
    desc:   document.getElementById("fDesc").value.trim(),
    icon:   document.getElementById("fIcon").value,
    color:  document.getElementById("fColor").value,
    image:  document.getElementById("fImage").value.trim() || null,
  };
  const password = sessionStorage.getItem("adminPass");
  const res = await fetch('/save-meta', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password, folder, meta })
  });
  if (res.ok) { showToast("‚úî SAVED!"); cancelEdit(); await renderAll(); }
  else { showToast("SAVE FAILED!", true); }
}

function buildPickers() {
  const iconGrid = document.getElementById("iconGrid");
  iconGrid.innerHTML = "";
  ICONS.forEach(ic => {
    const d = document.createElement("div");
    d.className = "icon-opt" + (ic === document.getElementById("fIcon").value ? " selected" : "");
    d.textContent = ic;
    d.onclick = () => {
      document.querySelectorAll(".icon-opt").forEach(x => x.classList.remove("selected"));
      d.classList.add("selected");
      document.getElementById("fIcon").value = ic;
    };
    iconGrid.appendChild(d);
  });
  const colorGrid = document.getElementById("colorGrid");
  colorGrid.innerHTML = "";
  COLORS.forEach(c => {
    const d = document.createElement("div");
    d.className = "color-opt" + (c.key === document.getElementById("fColor").value ? " selected" : "");
    d.style.background = c.hex;
    d.onclick = () => {
      document.querySelectorAll(".color-opt").forEach(x => x.classList.remove("selected"));
      d.classList.add("selected");
      document.getElementById("fColor").value = c.key;
    };
    colorGrid.appendChild(d);
  });
}

function previewImage(url) {
  const preview = document.getElementById("imgPreview");
  const img = document.getElementById("imgPreviewImg");
  if (!url) { preview.style.display = "none"; return; }
  img.src = url;
  img.onload  = () => { preview.style.display = "block"; };
  img.onerror = () => { preview.style.display = "none"; };
}

function showToast(msg, isError = false) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "toast show" + (isError ? " error" : "");
  setTimeout(() => t.className = "toast", 2800);
}
</script>
</body>
</html>
