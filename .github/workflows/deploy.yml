name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Cache game folders
        uses: actions/cache@v4
        with:
          path: .artifact-cache
          key: games-${{ hashFiles('projects.json') }}
          restore-keys: |
            games-

      - name: Build artifact folder
        run: |
          mkdir -p .artifact-cache

          # Copy root files that change often
          cp index.html .artifact-cache/
          cp projects.json .artifact-cache/

          # Copy any other root-level files (css, js, favicon etc)
          for f in *.css *.js *.ico *.png *.svg favicon* manifest*; do
            [ -f "$f" ] && cp "$f" .artifact-cache/ 2>/dev/null || true
          done

          # Copy non-game asset folders
          for dir in game-images js scripts; do
            [ -d "$dir" ] && cp -r "$dir" .artifact-cache/ || true
          done

          # Copy game folders â€” skip ones already in cache from last run
          for dir in */; do
            dir="${dir%/}"
            case "$dir" in
              .artifact-cache|.github|game-images|js|scripts) continue ;;
              .*) continue ;;
            esac
            if [ ! -d ".artifact-cache/$dir" ]; then
              echo "Adding to cache: $dir"
              cp -r "$dir" ".artifact-cache/$dir"
            else
              echo "Cache hit: $dir"
            fi
          done

          echo "Artifact size: $(du -sh .artifact-cache | cut -f1)"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.artifact-cache'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
